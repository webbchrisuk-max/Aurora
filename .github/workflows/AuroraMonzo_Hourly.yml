name: Aurora Monzo â€“ Hourly Pot + Transaction Sync

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: aurora-monzo-hourly
  cancel-in-progress: false

jobs:
  sync_monzo_hourly:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # =====================================================
      # STEP 1 â€“ Fetch Transactions sheet
      # =====================================================
      - name: ðŸŸ¢ Fetch Transactions sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transactions" -o transactions.json

      # =====================================================
      # STEP 2 â€“ Ensure state tracking file exists
      # =====================================================
      - name: ðŸ“¦ Ensure state folder
        run: |
          mkdir -p .aurora
          if [ ! -f .aurora/monzo_transfers_applied.json ]; then
            echo "[]" > .aurora/monzo_transfers_applied.json
          fi

      # =====================================================
      # STEP 3 â€“ Apply NEW Transactions
      # =====================================================
      - name: ðŸ”„ Apply NEW Transactions
        run: |
          node <<'EOF'
          const fs = require("fs");

          const sheet = JSON.parse(fs.readFileSync("transactions.json", "utf8"));
          const statePath = ".aurora/monzo_transfers_applied.json";
          const state = JSON.parse(fs.readFileSync(statePath, "utf8"));

          const monzoPath = "AuroraMonzo.json";
          const monzo = fs.existsSync(monzoPath)
            ? JSON.parse(fs.readFileSync(monzoPath, "utf8"))
            : { core_balance: 0, transactions: [] };

          let { core_balance } = monzo;
          let applied = [];

          for (const row of sheet) {
            const id = row["Gmail ID"];
            if (!id || state.includes(id)) continue;

            // Clean amount
            const rawAmount = row["Amount"] || "0";
            const amount = parseFloat(rawAmount.toString().replace(/[Â£,]/g, ""));

            // Boolean flags
            const processed = ["TRUE", "Yes", "YES", true].includes(row["Processed"]);
            const excluded = ["TRUE", "Yes", "YES", true].includes(row["Exclude from Spend"]);

            if (!processed || excluded || isNaN(amount)) continue;

            // Apply balance
            core_balance -= amount;

            // Save transaction
            monzo.transactions.push(row);

            applied.push(id);

            console.log(`Applied Â£${amount.toFixed(2)} | ${row["Merchant"]}`);
          }

          monzo.core_balance = parseFloat(core_balance.toFixed(2));

          // Write outputs
          fs.writeFileSync(monzoPath, JSON.stringify(monzo, null, 2));
          fs.writeFileSync(statePath, JSON.stringify([...state, ...applied], null, 2));

          EOF

      # =====================================================
      # STEP 4 â€“ Commit Changes
      # =====================================================
      - name: ðŸ“¤ Commit updated files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸŸ¢ Monzo transactions synced & core balance updated"
          file_pattern: |
            AuroraMonzo.json
            .aurora/monzo_transfers_applied.json
          branch: main
