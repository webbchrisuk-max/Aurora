name: Aurora Monzo â€“ Hourly Pot + Transaction Sync

on:
  schedule:
    - cron: "0 * * * *"    # every hour
  workflow_dispatch:

concurrency:
  group: aurora-monzo-hourly
  cancel-in-progress: false

jobs:
  sync_monzo_hourly:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # =====================================================
      # STEP 1 â€“ Fetch ALL Google Sheets
      # =====================================================
      - name: ðŸ“„ Fetch Transactions sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transactions" \
          -o transactions.json

      - name: ðŸ“„ Fetch Transfers sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transfers" \
          -o transfers.json

      - name: ðŸ“„ Fetch DirectDebits sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/DirectDebits" \
          -o direct_debits.json

      - name: ðŸ“„ Fetch MonzoCore sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/MonzoCore" \
          -o monzocore.json

      # =====================================================
      # STEP 2 â€“ Build auroraMonzo.json using your EXACT headers
      # =====================================================
      - name: ðŸ”§ Generate AuroraMonzo.json
        run: |
          node <<'EOF'
          const fs = require('fs');

          // Load all sheets
          const transactions = JSON.parse(fs.readFileSync('transactions.json', 'utf8'));
          const transfers    = JSON.parse(fs.readFileSync('transfers.json', 'utf8'));
          const directDebits = JSON.parse(fs.readFileSync('direct_debits.json', 'utf8'));
          const monzoCore    = JSON.parse(fs.readFileSync('monzocore.json', 'utf8'));

          // Helper: convert blank or "-" into null
          const num = v => {
            if (v === undefined || v === null || v === "" || v === "-") return null;
            return Number(v);
          };

          // =======================
          // PROCESS TRANSACTIONS
          // =======================
          const mappedTransactions = transactions.map(t => ({
            date: t["Date"],
            time: t["Time"],
            merchant: t["Merchant"],
            amount: num(t["Amount (Â£)"]),
            type: t["Type"],
            source: t["Source"],
            subject: t["Email Subject"],
            category: t["Category"],
            processed: t["Processed"],
            exclude: t["Exclude From Spend"],
            gmail_id: t["Gmail ID"]
          }));

          // =======================
          // PROCESS TRANSFERS
          // =======================
          const mappedTransfers = transfers.map(r => ({
            date: r["Date"],
            from_pot: r["From Pot"],
            to_pot: r["To Pot"],
            amount: num(r["Amount"]),
            type: r["Type"],
            note: r["Note"],
            processed: r["Processed"],
            uid: r["UID"]
          }));

          // =======================
          // PROCESS DIRECT DEBITS
          // =======================
          const mappedDDs = directDebits.map(d => ({
            payee: d["Payee"],
            amount: num(d["Amount (Â£)"]),
            due_date: d["Due Date"],
            day: d["Day"],
            status: d["Status"],
            from_pot: d["FromPot"],
            paid: d["Paid?"]
          }));

          // =======================
          // PROCESS MONZO CORE (POTS)
          // =======================
          const mappedCore = {};
          monzoCore.forEach(row => {
            mappedCore[row["Label"]] = {
              value: num(row["Value (Â£)"]),
              target: num(row["Target"]),
              total_due: num(row["Total Due"]),
              remaining: num(row["Remaining After Payments"])
            };
          });

          // =======================
          // FINAL JSON STRUCTURE
          // =======================
          const output = {
            monzo: {
              monzo_core: mappedCore,
              pot_transfers: mappedTransfers,
              direct_debits: mappedDDs,
              transactions_feed: mappedTransactions
            }
          };

          fs.writeFileSync(
            'AuroraMonzo.json',
            JSON.stringify(output, null, 2)
          );
          EOF

      # =====================================================
      # STEP 3 â€“ Commit changes
      # =====================================================
      - name: ðŸ’¾ Commit Monzo JSON
        run: |
          git config user.name "AuroraBot"
          git config user.email "aurora@github"
          git add AuroraMonzo.json
          git commit -m "Updated AuroraMonzo.json (Auto-sync)" || echo "No changes"
          git push