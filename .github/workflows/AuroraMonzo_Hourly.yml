name: Aurora Monzo – Hourly Sync (Clean Build)

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  sync_monzo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ----------------------------------------------------------
      # 1️⃣ FETCH ALL FOUR GOOGLE SHEETS
      # ----------------------------------------------------------
      - name: Fetch Transactions sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transactions" \
          -o transactions.json

      - name: Fetch Transfers sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transfers" \
          -o transfers.json

      - name: Fetch Direct Debits sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/DirectDebits" \
          -o directdebits.json

      - name: Fetch MonzoCore sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/MonzoCore" \
          -o monzocore.json

      # ----------------------------------------------------------
      # 2️⃣ NODE: BUILD AuroraMonzo.json IN CORRECT FORMAT
      # ----------------------------------------------------------
      - name: Build AuroraMonzo.json
        run: |
          node <<'EOF'
          const fs = require('fs');

          const tx = JSON.parse(fs.readFileSync('transactions.json','utf8'));
          const dd = JSON.parse(fs.readFileSync('directdebits.json','utf8'));
          const tr = JSON.parse(fs.readFileSync('transfers.json','utf8'));
          const coreSheet = JSON.parse(fs.readFileSync('monzocore.json','utf8'));

          // ---------------------------
          // Account Core (Main + Pots)
          // ---------------------------
          const account_core = {
            main_balance: Number(coreSheet.find(r => r.Name === "Main Account")?.Value || 0),
            payday_last: coreSheet.find(r => r.Name === "Payday")?.Value || "",
            income_received: Number(coreSheet.find(r => r.Name === "IncomeReceived")?.Value || 0),

            pots: coreSheet
              .filter(r => r.Type === "Pot")
              .reduce((acc, r) => {
                acc[r.Name] = Number(r.Value || 0);
                return acc;
              }, {})
          };

          // ---------------------------
          // Transactions Feed (latest 50)
          // ---------------------------
          const recentTx = tx
            .slice(0, 50)
            .map(t => ({
              date: t.Date,
              merchant: t.Merchant,
              amount: Number(t.Amount),
              category: t.Category,
              processed: t.Processed,
              exclude: t["Exclude from Spend"],
              gmail_id: t.GmailID
            }));

          // ---------------------------
          // Direct Debits
          // ---------------------------
          const directDebits = dd.map(r => ({
            payee: r.Payee,
            amount: Number(r.Amount),
            due_date: r.DueDate,
            status: r.Status
          }));

          // ---------------------------
          // Subscriptions (from MonzoCore sheet)
          // ---------------------------
          const subscriptions = coreSheet
            .filter(r => r.Type === "Subscription")
            .map(r => ({
              service: r.Name,
              amount: Number(r.Value || 0),
              renewal_date: r.DueDate
            }));

          // ---------------------------
          // Pot Transfers
          // ---------------------------
          const potTransfers = tr.map(t => ({
            date: t.Date,
            from_pot: t.From,
            to_pot: t.To,
            amount: Number(t.Amount),
            type: "Transfer"
          }));

          // ---------------------------
          // BUILD FINAL JSON FULL STRUCTURE
          // ---------------------------
          const finalJSON = {
            monzo: {
              account_core,
              pots: account_core.pots,
              direct_debits: directDebits,
              subscriptions_from_main: subscriptions,
              transactions_feed: {
                recent: recentTx
              },
              pot_transfers: potTransfers
            }
          };

          fs.writeFileSync("AuroraMonzo.json", JSON.stringify(finalJSON, null, 2));
          EOF

      # ----------------------------------------------------------
      # 3️⃣ COMMIT UPDATED JSON TO GITHUB
      # ----------------------------------------------------------
      - name: Commit changes
        run: |
          git config user.name "AuroraBot"
          git config user.email "aurora@system"
          git add AuroraMonzo.json
          git commit -m "Updated AuroraMonzo.json — clean structure"
          git push || true