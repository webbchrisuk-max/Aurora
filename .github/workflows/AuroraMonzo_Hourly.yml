name: Aurora Monzo â€“ Hourly Pot + Transaction Sync

on:
  schedule:
    - cron: "0 * * * *"   # every hour UTC
  workflow_dispatch:

concurrency:
  group: aurora-monzo-hourly
  cancel-in-progress: false

jobs:
  sync_monzo_hourly:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # =====================================================
      # STEP 1 â€“ Fetch Transfers sheet
      # =====================================================
      - name: ðŸŸ¢ Fetch Transfers sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transfers" -o transfers.json

      # =====================================================
      # STEP 2 â€“ Fetch Transactions sheet
      # =====================================================
      - name: ðŸŸ¢ Fetch Transactions sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transactions" -o transactions.json

      # =====================================================
      # STEP 3 â€“ Fetch DirectDebits sheet
      # =====================================================
      - name: ðŸŸ¢ Fetch Direct Debits sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/DirectDebits" -o directdebits.json

      # =====================================================
      # STEP 4 â€“ Ensure state folder
      # =====================================================
      - name: ðŸ“¦ Ensure state folder
        run: |
          mkdir -p .aurora
          if [ ! -f .aurora/monzo_transfers_applied.json ]; then
            echo "[]" > .aurora/monzo_transfers_applied.json
          fi

      # =====================================================
      # STEP 5 â€“ Apply NEW Transfers (UID filtering)
      # =====================================================
      - name: ðŸ”„ Apply NEW Transfers
        run: |
          node <<'EOF'
          const fs = require('fs');

          const transfers = JSON.parse(fs.readFileSync('transfers.json', 'utf8'));
          const applied = JSON.parse(fs.readFileSync('.aurora/monzo_transfers_applied.json', 'utf8'));

          const newTransfers = transfers.filter(t => t.UID && !applied.includes(t.UID));

          if (newTransfers.length > 0) {
            newTransfers.forEach(t => applied.push(t.UID));
            fs.writeFileSync('.aurora/monzo_transfers_applied.json', JSON.stringify(applied, null, 2));
          }
          EOF

      # =====================================================
      # STEP 6 â€“ Auto-tick Paid Direct Debits
      # =====================================================
      - name: ðŸ”˜ Auto-mark Paid Direct Debits
        run: |
          node <<'EOF'
          const fs = require('fs');

          const ddSheet = JSON.parse(fs.readFileSync('directdebits.json', 'utf8'));
          const transactions = JSON.parse(fs.readFileSync('transactions.json', 'utf8'));

          const today = new Date();
          today.setHours(0,0,0,0);

          let updated = false;

          ddSheet.forEach(dd => {
            const ddName = (dd["Name"] || dd["Payee"] || "").toLowerCase().trim();
            const ddDate = new Date(dd["Date"] || dd["date"]);
            const ddPaid = dd["Paid"] === true || dd["paid"] === true;

            ddDate.setHours(0,0,0,0);

            if (ddPaid) return;
            if (ddDate > today) return;

            const match = transactions.find(tx => {
              const merged = ((tx.Merchant || "") + " " + (tx.Description || "")).toLowerCase();
              return merged.includes(ddName);
            });

            if (match) {
              dd["Paid"] = true;
              dd["paid"] = true;
              updated = true;
            }
          });

          if (updated) {
            fs.writeFileSync('directdebits.json', JSON.stringify(ddSheet, null, 2));
          }
          EOF

      # =====================================================
      # STEP 7 â€“ UPDATE AuroraMonzo.json (SAFE-LOCKED)
      # =====================================================
      - name: ðŸ§¿ Update AuroraMonzo.json
        run: |
          node <<'EOF'
          const fs = require('fs');

          // Load existing file FIRST
          let core = {};
          if (fs.existsSync('AuroraMonzo.json')) {
            try {
              core = JSON.parse(fs.readFileSync('AuroraMonzo.json', 'utf8'));
            } catch (e) {
              console.log("âš ï¸ Existing JSON corrupt â€” keeping last known data");
            }
          }

          // Load live sheets
          const transactions = JSON.parse(fs.readFileSync('transactions.json', 'utf8'));
          const direct = JSON.parse(fs.readFileSync('directdebits.json', 'utf8'));
          const transfers = JSON.parse(fs.readFileSync('transfers.json', 'utf8'));
          const applied = JSON.parse(fs.readFileSync('.aurora/monzo_transfers_applied.json', 'utf8'));

          // SAFE-LOCK: NEVER overwrite account_core
          const previousCore = core.monzo?.account_core || {};

          // Always preserve user pots, balances & payday cycle
          const accountCore = {
            main_balance: previousCore.main_balance ?? 0,
            payday_last: previousCore.payday_last ?? "",
            payday_next: previousCore.payday_next ?? "",
            income_received: previousCore.income_received ?? 0,
            pots: previousCore.pots ?? {}
          };

          // Save final structure
          core["monzo"] = {
            account_core: accountCore,
            subscriptions_from_main: core.monzo?.subscriptions_from_main || [],
            subscriptions_from_alt: core.monzo?.subscriptions_from_alt || [],
            transactions: transactions,
            direct_debits: direct,
            transfers: transfers,
            state: applied
          };

          // Pretty print all files
          fs.writeFileSync('transactions.json', JSON.stringify(transactions, null, 2));
          fs.writeFileSync('directdebits.json', JSON.stringify(direct, null, 2));
          fs.writeFileSync('transfers.json', JSON.stringify(transfers, null, 2));
          fs.writeFileSync('.aurora/monzo_transfers_applied.json', JSON.stringify(applied, null, 2));
          fs.writeFileSync('AuroraMonzo.json', JSON.stringify(core, null, 2));
          EOF

      # =====================================================
      # STEP 8 â€“ COMMIT & PUSH
      # =====================================================
      - name: ðŸ“¤ Commit and Push
        run: |
          git config user.name "Aurora Automation"
          git config user.email "actions@github.com"

          git add .
          git commit -m "Aurora Monzo: Safe-Locked Sync (No Reset, No Wipe, Fully Structured JSON)" || echo "No changes to commit"
          git push || echo "No changes to push"