name: Aurora Monzo â€“ Hourly Sync

on:
  schedule:
    - cron: "0 * * * *"   # every hour UTC
  workflow_dispatch:

concurrency:
  group: aurora-monzo-hourly
  cancel-in-progress: false

jobs:
  sync_monzo_hourly:
    runs-on: ubuntu-latest

    steps:
      # =====================================================
      # STEP 1 â€” Checkout
      # =====================================================
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4


      # =====================================================
      # STEP 2 â€” Fetch Google Sheets (Transfers / DirectDebits / Transactions / MonzoCore)
      # =====================================================

      - name: ðŸŸ¢ Fetch Transfers sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transfers" -o transfers.json

      - name: ðŸŸ¢ Fetch Direct Debits sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/DirectDebits" -o directdebits.json

      - name: ðŸŸ¢ Fetch Transactions sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transactions" -o transactions.json

      - name: ðŸŸ¢ Fetch Monzo Core sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/MonzoCore" -o monzocore.json


      # =====================================================
      # STEP 3 â€” Ensure State Tracking
      # =====================================================
      - name: ðŸ“¦ Ensure state folder
        run: |
          mkdir -p .aurora
          if [ ! -f .aurora/monzo_transfers_applied.json ]; then
            echo "[]" > .aurora/monzo_transfers_applied.json
          fi


      # =====================================================
      # STEP 4 â€” Apply NEW Transfers into AuroraMonzo.json
      # =====================================================
      - name: ðŸ”„ Apply NEW Transfers
        run: |
          node <<'EOF'
          const fs = require('fs');

          const transfers = JSON.parse(fs.readFileSync('transfers.json', 'utf8'));
          const applied = JSON.parse(fs.readFileSync('.aurora/monzo_transfers_applied.json', 'utf8'));

          const newTransfers = transfers.filter(t => !applied.includes(t.GmailID));

          const monzoFile = './AuroraMonzo.json';
          let monzo = {};
          if (fs.existsSync(monzoFile)) {
            monzo = JSON.parse(fs.readFileSync(monzoFile, 'utf8'));
          }

          if (!monzo.pot_transfers) monzo.pot_transfers = [];

          newTransfers.forEach(t => {
            monzo.pot_transfers.push({
              date: t.Date,
              pot: t.Pot,
              amount: t.Amount,
              type: t.Type,
              gmail_id: t.GmailID
            });
            applied.push(t.GmailID);
          });

          fs.writeFileSync(monzoFile, JSON.stringify(monzo, null, 2));
          fs.writeFileSync('.aurora/monzo_transfers_applied.json', JSON.stringify(applied, null, 2));
          EOF


      # =====================================================
      # STEP 5 â€” Process Direct Debits into JSON
      # =====================================================
      - name: ðŸ§® Process Direct Debits
        run: |
          node <<'EOF'
          const fs = require('fs');

          const raw = JSON.parse(fs.readFileSync('directdebits.json', 'utf8'));
          const monzoFile = './AuroraMonzo.json';

          let monzo = {};
          if (fs.existsSync(monzoFile)) {
            monzo = JSON.parse(fs.readFileSync(monzoFile, 'utf8'));
          }

          const processed = raw.map(row => ({
            payee: row.Payee,
            amount: parseFloat(row["Amount (Â£)"] || 0),
            due_date: row["Due Date"],
            status: row.Status,
            from_pot: row["From Pot"],
            paid: row["Paid?"]
          }));

          monzo.direct_debits = processed;

          fs.writeFileSync(monzoFile, JSON.stringify(monzo, null, 2));
          EOF


      # =====================================================
      # STEP 6 â€” Process Transactions into JSON
      # =====================================================
      - name: ðŸ§¾ Process Transactions
        run: |
          node <<'EOF'
          const fs = require('fs');

          const tx = JSON.parse(fs.readFileSync('transactions.json', 'utf8'));
          const monzoFile = './AuroraMonzo.json';

          let monzo = {};
          if (fs.existsSync(monzoFile)) {
            monzo = JSON.parse(fs.readFileSync(monzoFile, 'utf8'));
          }

          const mapped = tx.map(row => ({
            date: row.Date,
            time: row.Time,
            merchant: row.Merchant,
            amount: parseFloat(row["Amount (Â£)"] || 0),
            type: row.Type,
            source: row.Source,
            subject: row["Email Subject"],
            category: row.Category,
            processed: row.Processed,
            exclude: row["Exclude From Spend"],
            gmail_id: row["Gmail ID"]
          }));

          monzo.transactions = mapped;

          fs.writeFileSync(monzoFile, JSON.stringify(monzo, null, 2));
          EOF


      # =====================================================
      # STEP 7 â€” EXPORT MONZO CORE (FINAL VALUES)
      # =====================================================
      - name: ðŸ§± Export Monzo Core
        run: |
          node <<'EOF'
          const fs = require('fs');

          const core = JSON.parse(fs.readFileSync('monzocore.json', 'utf8'));
          const monzoFile = './AuroraMonzo.json';

          let monzo = {};
          if (fs.existsSync(monzoFile)) {
            monzo = JSON.parse(fs.readFileSync(monzoFile, 'utf8'));
          }

          const extract = {};
          core.forEach(row => {
            const name = row.Label;
            extract[name] = {
              value: parseFloat(row["Value (Â£)"] || 0),
              target: parseFloat(row["Target"] || 0),
              total_due: parseFloat(row["Total Due"] || 0),
              remaining: parseFloat(row["Remaining After Payments"] || 0)
            };
          });

          monzo.monzo_core = extract;

          fs.writeFileSync(monzoFile, JSON.stringify(monzo, null, 2));
          EOF


      # =====================================================
      # STEP 8 â€” Commit & Push
      # =====================================================
      - name: ðŸ’¾ Commit & Push changes
        run: |
          git config user.name "AuroraBot"
          git config user.email "aurora@example.com"
          git add .
          git commit -m "Aurora Monzo Sync Update" || echo "No changes to commit"
          git push
