name: Aurora Monzo â€“ Hourly Pot + Transaction Sync

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

concurrency:
  group: aurora-monzo-hourly
  cancel-in-progress: false

jobs:
  sync_monzo_hourly:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # ==========================================================
      # ABSOLUTE PROTECTION â€“ DO NOT TOUCH AuroraSync.json
      # ==========================================================
      - name: ðŸ”’ Hard-lock AuroraSync.json
        run: |
          if [ -f "AuroraSync.json" ]; then
            echo "ðŸ” AuroraSync.json detected â€” READ-ONLY mode enabled."
            chmod 444 AuroraSync.json
          fi

      # =====================================================
      # STEP 1 â€“ Fetch Sheets
      # =====================================================
      - name: ðŸŸ¢ Fetch Transfers sheet
        run: curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transfers" -o transfers.json

      - name: ðŸŸ¢ Fetch Transactions sheet
        run: curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transactions" -o transactions.json

      - name: ðŸŸ¢ Fetch Direct Debits sheet
        run: curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/DirectDebits" -o directdebits.json

      # =====================================================
      # STEP 2 â€“ State Tracking
      # =====================================================
      - name: ðŸ“¦ Ensure state folder
        run: |
          mkdir -p .aurora
          if [ ! -f .aurora/monzo_transfers_applied.json ]; then
            echo "[]" > .aurora/monzo_transfers_applied.json
          fi

      # =====================================================
      # STEP 3 â€“ Apply NEW Transfers
      # =====================================================
      - name: ðŸ”„ Apply NEW Transfers
        run: |
          node <<'EOF'
          const fs = require('fs');

          const transfers = JSON.parse(fs.readFileSync('transfers.json', 'utf8'));
          const applied = JSON.parse(fs.readFileSync('.aurora/monzo_transfers_applied.json', 'utf8'));

          const newTransfers = transfers.filter(t => t.UID && !applied.includes(t.UID));

          if (newTransfers.length > 0) {
            newTransfers.forEach(t => applied.push(t.UID));
            fs.writeFileSync('.aurora/monzo_transfers_applied.json', JSON.stringify(applied, null, 2));
          }
          EOF

      # =====================================================
      # STEP 4 â€“ Auto-tick Paid DDs
      # =====================================================
      - name: ðŸ”˜ Auto-mark Paid DDs
        run: |
          node <<'EOF'
          const fs = require('fs');

          const dd = JSON.parse(fs.readFileSync('directdebits.json', 'utf8'));
          const tx = JSON.parse(fs.readFileSync('transactions.json', 'utf8'));

          let updated = false;

          dd.forEach(item => {
            if (item.paid === true) return;

            const name = (item.payee || "").toLowerCase();
            const match = tx.find(t =>
              ((t.Merchant || "") + " " + (t.Description || "")).toLowerCase().includes(name)
            );

            if (match) {
              item.paid = true;
              updated = true;
            }
          });

          if (updated) {
            fs.writeFileSync('directdebits.json', JSON.stringify(dd, null, 2));
          }
          EOF

      # =====================================================
      # STEP 5 â€“ SAFE UPDATE TO AuroraMonzo.json ONLY
      # =====================================================
      - name: ðŸ§¿ Safe merge for AuroraMonzo.json
        run: |
          node <<'EOF'
          const fs = require('fs');

          // Load existing AuroraMonzo.json EXACTLY as is
          let core = {};
          if (fs.existsSync('AuroraMonzo.json')) {
            core = JSON.parse(fs.readFileSync('AuroraMonzo.json', 'utf8'));
          }

          // Ensure structure exists
          if (!core.monzo) core.monzo = {};
          if (!core.monzo.account_core) core.monzo.account_core = {};
          if (!core.monzo.account_core.pots) core.monzo.account_core.pots = {};

          // Merge ONLY sheets
          core.monzo.transactions = JSON.parse(fs.readFileSync('transactions.json', 'utf8'));
          core.monzo.direct_debits = JSON.parse(fs.readFileSync('directdebits.json', 'utf8'));
          core.monzo.transfers = JSON.parse(fs.readFileSync('transfers.json', 'utf8'));
          core.monzo.state = JSON.parse(fs.readFileSync('.aurora/monzo_transfers_applied.json', 'utf8'));

          // DO NOT MODIFY ANY OTHER SECTIONS
          fs.writeFileSync('AuroraMonzo.json', JSON.stringify(core, null, 2));
          EOF

      # =====================================================
      # STEP 6 â€“ Commit & Push
      # =====================================================
      - name: ðŸ“¤ Commit and Push
        run: |
          git config user.name "Aurora Automation"
          git config user.email "actions@github.com"
          git add .
          git commit -m "SAFE Monzo Sync â€“ Sheets updated, AuroraSync.json protected" || echo "No changes"
          git push || echo "No changes"
