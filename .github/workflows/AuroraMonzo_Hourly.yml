name: Aurora Monzo â€“ Hourly Pot + Transaction Sync

on:
  schedule:
    - cron: "0 * * * *"   # Every hour UTC
  workflow_dispatch:

concurrency:
  group: aurora-monzo-hourly
  cancel-in-progress: false

jobs:
  sync_monzo_hourly:
    runs-on: ubuntu-latest

    steps:
      # =====================================================
      # STEP 1 â€” Checkout Repository
      # =====================================================
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # REQUIRED so pull --rebase works

      # =====================================================
      # STEP 2 â€“ Fetch Transfers sheet
      # =====================================================
      - name: ðŸŸ¢ Fetch Transfers sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transfers" -o transfers.json

      # =====================================================
      # STEP 3 â€“ Fetch Transactions sheet
      # =====================================================
      - name: ðŸŸ£ Fetch Transactions sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transactions" -o transactions.json

      # =====================================================
      # STEP 4 â€“ Fetch Direct Debits sheet
      # =====================================================
      - name: ðŸŸ¡ Fetch Direct Debits sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/DirectDebits" -o directdebits.json

      # =====================================================
      # STEP 5 â€“ Ensure State Folder
      # =====================================================
      - name: ðŸ“¦ Ensure state folder
        run: |
          mkdir -p .aurora
          if [ ! -f .aurora/monzo_transfers_applied.json ]; then
            echo "[]" > .aurora/monzo_transfers_applied.json
          fi

      # =====================================================
      # STEP 6 â€“ Apply NEW Transfers + Build AuroraMonzo.json
      # =====================================================
      - name: ðŸ”„ Apply Transfer + Transaction Sync Logic
        run: |
          node << 'EOF'
          const fs = require("fs");

          const transfers = JSON.parse(fs.readFileSync("transfers.json", "utf8"));
          const transactions = JSON.parse(fs.readFileSync("transactions.json", "utf8"));
          const directDebits = JSON.parse(fs.readFileSync("directdebits.json", "utf8"));
          const appliedPath = ".aurora/monzo_transfers_applied.json";

          const appliedTransfers = JSON.parse(fs.readFileSync(appliedPath, "utf8"));
          const monzoPath = "AuroraMonzo.json";

          let monzo = { pots: {}, transactions: [], direct_debits: [] };

          if (fs.existsSync(monzoPath)) {
            monzo = JSON.parse(fs.readFileSync(monzoPath, "utf8"));
          }

          // --- Apply transfers only once ---
          const newTransfers = transfers.filter(t => !appliedTransfers.includes(t.id));

          newTransfers.forEach(t => {
            const amt = Number(t.Amount || 0);

            if (!monzo.pots[t["From Pot"]]) monzo.pots[t["From Pot"]] = 0;
            if (!monzo.pots[t["To Pot"]]) monzo.pots[t["To Pot"]] = 0;

            monzo.pots[t["From Pot"]] -= amt;
            monzo.pots[t["To Pot"]] += amt;

            appliedTransfers.push(t.id);
          });

          // Save updated transfer state
          fs.writeFileSync(appliedPath, JSON.stringify(appliedTransfers, null, 2));

          // Save transactions + DDs
          monzo.transactions = transactions;
          monzo.direct_debits = directDebits;

          fs.writeFileSync(monzoPath, JSON.stringify(monzo, null, 2));
          EOF

      # =====================================================
      # STEP 7 â€” GIT SAFETY: Pull latest before push
      # =====================================================
      - name: ðŸ“¥ Pull latest (fix non-fast-forward)
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git pull --rebase origin main || true

      # =====================================================
      # STEP 8 â€” Commit & Push JSON
      # =====================================================
      - name: ðŸ“¤ Push AuroraMonzo.json
        run: |
          git add AuroraMonzo.json
          git add .aurora/monzo_transfers_applied.json
          git commit -m "Monzo Sync Update" || true
          git push origin main || true
