name: Aurora Monzo â€“ Hourly Pot + Transaction Sync

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

concurrency:
  group: aurora-monzo-hourly
  cancel-in-progress: false

jobs:
  sync_monzo_hourly:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure .aurora + default pay period file
        run: |
          mkdir -p .aurora
          if [ ! -f .aurora/pay_period.json ]; then
            echo "{
              \"current_period_start\": \"2025-11-01\",
              \"next_payday\": \"2025-12-05\",
              \"period_length_days\": 28
            }" > .aurora/pay_period.json
          fi

      - name: Payday Rollover if needed
        run: |
          node <<'EOF'
          const fs = require('fs');
          const path = require('path');

          const statePath = path.join('.aurora', 'pay_period.json');
          const txPath = 'transactions.json';
          const archivePath = 'transactions_archive.json';

          let state;
          try { state = JSON.parse(fs.readFileSync(statePath, 'utf8')); }
          catch {
            state = {
              current_period_start: "2025-11-01",
              next_payday: "2025-12-05",
              period_length_days: 28
            };
            fs.writeFileSync(statePath, JSON.stringify(state, null, 2));
          }

          const today = new Date();
          const todayYMD = today.toISOString().slice(0, 10);
          const nextPayday = new Date(state.next_payday + "T00:00:00Z");
          const nextPaydayYMD = nextPayday.toISOString().slice(0, 10);

          if (todayYMD < nextPaydayYMD) process.exit(0);

          let oldTx = [];
          try { oldTx = JSON.parse(fs.readFileSync(txPath, 'utf8')); } catch {}
          let archive = [];
          try { archive = JSON.parse(fs.readFileSync(archivePath, 'utf8')); } catch {}

          if (oldTx.length > 0) {
            const merged = archive.concat(oldTx);
            fs.writeFileSync(archivePath, JSON.stringify(merged, null, 2));
          }

          fs.writeFileSync(txPath, '[]\n');

          const ms = 86400000;
          const newStart = nextPayday;
          const newNext = new Date(newStart.getTime() + (state.period_length_days || 28) * ms);

          state.current_period_start = newStart.toISOString().slice(0, 10);
          state.next_payday = newNext.toISOString().slice(0, 10);

          fs.writeFileSync(statePath, JSON.stringify(state, null, 2));
          EOF

      - name: Fetch Transfers
        run: curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transfers" -o transfers.json

      - name: Fetch Transactions raw
        run: curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transactions" -o transactions_raw.json

      - name: Fetch Direct Debits
        run: curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/DirectDebits" -o directdebits.json

      - name: Fetch MonzoCore
        run: curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/MonzoCore" -o MonzoCore.json

      - name: Ensure state folder
        run: |
          mkdir -p .aurora
          if [ ! -f .aurora/monzo_transfers_applied.json ]; then
            echo "[]" > .aurora/monzo_transfers_applied.json
          fi

      - name: Apply NEW Transfers
        run: |
          node <<'EOF'
          const fs = require('fs');
          const transfers = JSON.parse(fs.readFileSync('transfers.json', 'utf8'));
          const applied = JSON.parse(fs.readFileSync('.aurora/monzo_transfers_applied.json', 'utf8'));

          const newOnes = transfers.filter(t => t.UID && !applied.includes(t.UID));
          newOnes.forEach(t => applied.push(t.UID));

          fs.writeFileSync('.aurora/monzo_transfers_applied.json', JSON.stringify(applied, null, 2));
          EOF

      - name: Merge RAW into pay-period transactions
        run: |
          node <<'EOF'
          const fs = require('fs');

          const raw = JSON.parse(fs.readFileSync('transactions_raw.json', 'utf8'));
          const current = JSON.parse(fs.readFileSync('transactions.json', 'utf8'));

          let state;
          try { state = JSON.parse(fs.readFileSync('.aurora/pay_period.json', 'utf8')); }
          catch {
            state = {
              current_period_start: "2025-11-01",
              next_payday: "2025-12-05",
              period_length_days: 28
            };
          }

          const start = new Date(state.current_period_start + "T00:00:00Z");

          const filtered = raw.filter(t => {
            if (!t.Date) return false;
            const p = t.Date.split('/');
            const d = new Date(`${p[2]}-${p[1]}-${p[0]}T00:00:00Z`);
            return d >= start;
          });

          const seen = new Set();
          const merged = [];
          [...current, ...filtered].forEach(t => {
            const key = t["Gmail ID"] || JSON.stringify(t);
            if (!seen.has(key)) {
              seen.add(key);
              merged.push(t);
            }
          });

          fs.writeFileSync('transactions.json', JSON.stringify(merged, null, 2));
          EOF

      - name: Auto-mark Paid DDs
        run: |
          node <<'EOF'
          const fs = require('fs');
          const dd = JSON.parse(fs.readFileSync('directdebits.json', 'utf8'));
          const tx = JSON.parse(fs.readFileSync('transactions.json', 'utf8'));

          dd.forEach(item => {
            if (item.paid === true) return;
            const name = (item.payee || "").toLowerCase();
            const match = tx.find(t =>
              ((t.Merchant || "") + " " + (t.Description || "")).toLowerCase().includes(name)
            );
            if (match) item.paid = true;
          });

          fs.writeFileSync('directdebits.json', JSON.stringify(dd, null, 2));
          EOF

      - name: Update AuroraMonzo.json
        run: |
          node <<'EOF'
          const fs = require('fs');

          let core = {};
          if (fs.existsSync('AuroraMonzo.json')) {
            core = JSON.parse(fs.readFileSync('AuroraMonzo.json', 'utf8'));
          }

          if (!core.monzo) core.monzo = {};
          core.monzo.transactions = JSON.parse(fs.readFileSync('transactions.json', 'utf8'));
          core.monzo.direct_debits = JSON.parse(fs.readFileSync('directdebits.json', 'utf8'));
          core.monzo.transfers = JSON.parse(fs.readFileSync('transfers.json', 'utf8'));
          core.monzo.core = JSON.parse(fs.readFileSync('MonzoCore.json', 'utf8'));

          fs.writeFileSync('AuroraMonzo.json', JSON.stringify(core, null, 2));
          EOF

      - name: Commit and Push
        run: |
          git config user.name "Aurora Automation"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Aurora Monzo Sync" || echo "No changes"
          git push || echo "No changes"
