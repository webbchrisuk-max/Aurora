name: Aurora Monzo â€“ Hourly Pot + Transaction Sync

on:
  schedule:
    - cron: "0 * * * *"     # Runs every hour
  workflow_dispatch:

concurrency:
  group: aurora-monzo-hourly
  cancel-in-progress: false

jobs:
  sync_monzo_hourly:
    runs-on: ubuntu-latest

    steps:
      # =====================================================
      # STEP 1 â€“ Checkout repo
      # =====================================================
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =====================================================
      # STEP 2 â€“ Fetch Transfers Sheet
      # =====================================================
      - name: ðŸŸ¢ Fetch Transfers sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transfers" -o transfers.json

      # =====================================================
      # STEP 3 â€“ Fetch Transactions Sheet
      # =====================================================
      - name: ðŸŸ¢ Fetch Transactions sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transactions" -o transactions.json

      # =====================================================
      # STEP 4 â€“ Fetch Direct Debits Sheet
      # =====================================================
      - name: ðŸŸ¢ Fetch DirectDebits sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/DirectDebits" -o directdebits.json

      # =====================================================
      # STEP 5 â€“ Load existing AuroraMonzo.json
      # =====================================================
      - name: ðŸ“¥ Load existing AuroraMonzo.json
        run: |
          curl -s "https://raw.githubusercontent.com/webbchrisuk-max/Aurora/refs/heads/main/AuroraMonzo.json" -o AuroraMonzo.json

      # =====================================================
      # STEP 6 â€“ Merge new sheets â†’ AuroraMonzo.json
      # =====================================================
      - name: ðŸ”„ Build updated AuroraMonzo.json
        run: |
          node <<'EOF'
          const fs = require("fs");

          const transfers = JSON.parse(fs.readFileSync("transfers.json","utf8"));
          const transactions = JSON.parse(fs.readFileSync("transactions.json","utf8"));
          const directDebits = JSON.parse(fs.readFileSync("directdebits.json","utf8"));
          const monzo = JSON.parse(fs.readFileSync("AuroraMonzo.json","utf8"));

          // ------------------------------
          // Ensure structure exists
          // ------------------------------
          monzo.monzo = monzo.monzo || {};
          monzo.monzo.direct_debits = [];
          monzo.monzo.transactions_feed = { recent: [] };
          monzo.monzo.pot_transfers = monzo.monzo.pot_transfers || [];

          // ------------------------------
          // DIRECT DEBITS â†’ Clean mapping
          // ------------------------------
          directDebits.forEach(dd => {
            if (!dd["Payee"]) return;
            monzo.monzo.direct_debits.push({
              payee: dd["Payee"],
              amount: Number(dd["Amount"] || 0),
              due_date: dd["Date"] || ""
            });
          });

          // ------------------------------
          // TRANSACTIONS â†’ Last 200 safe
          // ------------------------------
          transactions.forEach(t => {
            if (!t["Date"] || !t["Merchant"]) return;
            monzo.monzo.transactions_feed.recent.push({
              Date: t["Date"],
              Merchant: t["Merchant"],
              "Amount (Â£)": Number(t["Amount (Â£)"] || 0),
              Category: t["Category"] || "",
              Processed: t["Processed"] || "",
              "Exclude From Spend": t["Exclude From Spend"] || ""
            });
          });

          // Keep last 200 only
          monzo.monzo.transactions_feed.recent =
            monzo.monzo.transactions_feed.recent.slice(-200);

          // ------------------------------
          // SAVE
          // ------------------------------
          fs.writeFileSync("AuroraMonzo.json", JSON.stringify(monzo, null, 2));
          EOF

      # =====================================================
      # STEP 7 â€“ Commit AuroraMonzo.json
      # =====================================================
      - name: ðŸ“¤ Commit updated AuroraMonzo.json
        run: |
          git config --global user.name "Aurora Automation"
          git config --global user.email "actions@github.com"

          git add AuroraMonzo.json
          git commit -m "Monzo Sync Update" || true
          git push || true