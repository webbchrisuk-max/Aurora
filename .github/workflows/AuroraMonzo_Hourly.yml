name: Aurora Monzo â€“ Hourly Pot + Transaction Sync

on:
  schedule:
    - cron: "0 * * * *"   # every hour
  workflow_dispatch:

concurrency:
  group: aurora-monzo-hourly
  cancel-in-progress: false

jobs:
  sync_monzo_hourly:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # =====================================================
      # STEP 1 â€“ Fetch Transfers sheet
      # =====================================================
      - name: ðŸŸ¢ Fetch Transfers sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transfers" \
          -o transfers.json

      # =====================================================
      # STEP 2 â€“ Ensure state tracking
      # =====================================================
      - name: ðŸ“¦ Ensure state folder
        run: |
          mkdir -p .aurora
          if [ ! -f .aurora/monzo_transfers_applied.json ]; then
            echo "[]" > .aurora/monzo_transfers_applied.json
          fi

      # =====================================================
      # STEP 3 â€“ Apply NEW Transfers
      # =====================================================
      - name: ðŸ”„ Apply NEW Transfers
        run: |
          node << 'EOF'
          const fs = require("fs");


          // ------------------------------
          // Load all data
          // ------------------------------
          const transfers = JSON.parse(fs.readFileSync("transfers.json", "utf8"));
          const appliedUIDs = new Set(JSON.parse(fs.readFileSync(".aurora/monzo_transfers_applied.json", "utf8")));
          const monzoPath = "AuroraMonzo.json";

          const monzo = JSON.parse(fs.readFileSync(monzoPath, "utf8"));


          // ------------------------------
          // Ensure pots exist (your list)
          // ------------------------------
          const pots = [
            "Flex Repayment",
            "Direct Debits",
            "Holiday Pot",
            "Coventry City F.C",
            "IGTrading",
            "Car Maintenance",
            "Work Buffer",
            "Savings",
            "Christmas",
            "Dentist",
            "Holding Pot"
          ];

          monzo.pots = monzo.pots || {};
          pots.forEach(p => {
            if (!monzo.pots[p]) monzo.pots[p] = 0;
          });


          // ------------------------------
          // Apply unprocessed transfers
          // ------------------------------
          for (const row of transfers) {
            const uid = row["UID"];
            const processed = row["Processed"];
            const type = row["Type"];
            const fromPot = row["From Pot"];
            const toPot = row["To Pot"];
            const amount = parseFloat(row["Amount"] || 0);

            if (!uid || appliedUIDs.has(uid)) continue;
            if (processed && processed.toLowerCase() === "yes") continue;
            if (!amount || amount === 0) continue;

            // Validate pots
            if (!monzo.pots[fromPot]) monzo.pots[fromPot] = 0;
            if (!monzo.pots[toPot]) monzo.pots[toPot] = 0;

            // Transfer logic
            monzo.pots[fromPot] -= amount;
            monzo.pots[toPot] += amount;

            appliedUIDs.add(uid);
          }


          // ------------------------------
          // Save updates
          // ------------------------------
          fs.writeFileSync(monzoPath, JSON.stringify(monzo, null, 2));
          fs.writeFileSync(".aurora/monzo_transfers_applied.json", JSON.stringify([...appliedUIDs], null, 2));

          EOF

      # =====================================================
      # STEP 4 â€“ Commit + Push
      # =====================================================
      - name: ðŸ“¤ Commit changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add AuroraMonzo.json .aurora/monzo_transfers_applied.json
          git commit -m "ðŸ”„ Applied Monzo transfers $(date)" || echo "No changes"
          git push
