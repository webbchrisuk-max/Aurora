# ==========================================================
# üåå  Aurora Monzo ‚Äì Hourly Pot + Transaction Sync
# ==========================================================
# ‚Ä¢ Runs every hour to pull live Monzo data from OpenSheet
# ‚Ä¢ Updates AuroraMonzo.json automatically
# ‚Ä¢ Commits safely (with rebase) even if manual changes exist
# ==========================================================

name: üí∞ Hourly Monzo Sync

on:
  schedule:
    - cron: "0 * * * *"      # every hour, on the hour (UTC)
  workflow_dispatch:          # allow manual trigger

jobs:
  aurora_monzo_sync:
    runs-on: ubuntu-latest

    steps:
      # --------------------- CHECKOUT ---------------------
      - name: üõ† Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------- SETUP NODE ---------------------
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # --------------------- FETCH LATEST DATA ---------------------
      - name: üì• Fetch Monzo data from OpenSheet
        run: |
          echo "Fetching Monzo transactions + pot transfers..."
          mkdir -p .aurora

          # === Google Sheet IDs ===
          SHEET_ID="10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE"
          TRANSFERS_URL="https://opensheet.elk.sh/${SHEET_ID}/Transfers"
          TRANSACTIONS_URL="https://opensheet.elk.sh/${SHEET_ID}/Transactions"

          curl -s "$TRANSFERS_URL" -o .aurora/transfers.json
          curl -s "$TRANSACTIONS_URL" -o .aurora/transactions.json

          echo "‚úÖ Downloaded latest Transfers & Transactions data"

      # --------------------- APPLY TO JSON ---------------------
      - name: üßÆ Apply updates to AuroraMonzo.json
        run: |
          echo "Updating AuroraMonzo.json..."

          node <<'EOF'
          const fs = require('fs');

          const path = 'AuroraMonzo.json';
          const transfers = JSON.parse(fs.readFileSync('.aurora/transfers.json', 'utf8'));
          const transactions = JSON.parse(fs.readFileSync('.aurora/transactions.json', 'utf8'));
          const aurora = JSON.parse(fs.readFileSync(path, 'utf8'));

          // --- Update transactions ---
          aurora.monzo.transactions_feed = { recent: transactions };

          // --- Apply pot transfers ---
          if (!aurora.monzo.account_core.pots) aurora.monzo.account_core.pots = {};
          const pots = aurora.monzo.account_core.pots;

          const appliedLogPath = '.aurora/monzo_transfers_applied.json';
          let applied = [];
          if (fs.existsSync(appliedLogPath)) {
            try { applied = JSON.parse(fs.readFileSync(appliedLogPath, 'utf8')); } catch {}
          }

          const today = new Date().toISOString().split('T')[0];
          const makeId = t => [t.Date, t["From Pot"], t["To Pot"], t.Amount, t.Note].join('|');

          for (const t of transfers) {
            const id = makeId(t);
            if (applied.includes(id)) continue;
            const date = (t.Date || '').trim();
            if (!date || date > today) continue;

            const from = (t["From Pot"] || '').trim();
            const to = (t["To Pot"] || '').trim();
            const amount = parseFloat(t.Amount);
            if (!from || !to || !Number.isFinite(amount)) continue;

            // Main Account debit/credit
            if (from === 'Main Account') aurora.monzo.account_core.main_balance -= amount;
            else pots[from] = (pots[from] || 0) - amount;

            if (to === 'Main Account') aurora.monzo.account_core.main_balance += amount;
            else pots[to] = (pots[to] || 0) + amount;

            applied.push(id);
          }

          // --- Integrity update ---
          aurora.monzo.integrity = {
            checksum: `aurora-monzo-${new Date().toISOString()}`,
            verified: true,
            last_updated: new Date().toISOString()
          };

          fs.writeFileSync(path, JSON.stringify(aurora, null, 2));
          fs.writeFileSync(appliedLogPath, JSON.stringify(applied, null, 2));
          console.log(`‚úÖ AuroraMonzo.json updated successfully`);
          EOF

      # --------------------- COMMIT + SAFE PUSH ---------------------
      - name: üíæ Commit and push updates (safe rebase)
        run: |
          git config user.name "aurora-bot"
          git config user.email "aurora@users.noreply.github.com"

          git fetch origin main
          git rebase origin/main || true

          git add AuroraMonzo.json .aurora/monzo_transfers_applied.json || true
          git commit -m "üí∞ Hourly Monzo Sync (pots + transactions)" || echo "No changes to commit"

          git pull --rebase origin main || true
          git push origin main || echo "Push failed ‚Äì will retry next run"

      # --------------------- COMPLETION ---------------------
      - name: ‚úÖ Summary
        run: echo "Aurora Monzo hourly sync completed successfully üöÄ"