name: Aurora Monzo â€“ Hourly Pot + Transaction Sync

on:
  schedule:
    - cron: "0 * * * *"   # every hour UTC
  workflow_dispatch:

concurrency:
  group: aurora-monzo-hourly
  cancel-in-progress: false

jobs:
  sync_monzo_hourly:
    runs-on: ubuntu-latest

    steps:
      # =====================================================
      # STEP 1 â€“ Checkout repository
      # =====================================================
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # =====================================================
      # STEP 2 â€“ Fetch Transactions sheet
      # =====================================================
      - name: ðŸŸ¢ Fetch Transactions sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transactions" -o transactions.json

      # =====================================================
      # STEP 3 â€“ Ensure state tracking
      # =====================================================
      - name: ðŸ“¦ Ensure state folder
        run: |
          mkdir -p .aurora
          if [ ! -f .aurora/monzo_transfers_applied.json ]; then
            echo "[]" > .aurora/monzo_transfers_applied.json
          fi

      # =====================================================
      # STEP 4 â€“ Apply NEW Transactions
      # =====================================================
      - name: ðŸ”„ Apply NEW Transactions
        run: |
          node <<'EOF'
          const fs = require("fs");

          const sheet = JSON.parse(fs.readFileSync("transactions.json", "utf8"));
          const statePath = ".aurora/monzo_transfers_applied.json";
          const state = fs.existsSync(statePath)
            ? JSON.parse(fs.readFileSync(statePath, "utf8"))
            : [];

          // Read current AuroraSync.json
          const auroraPath = "AuroraSync.json";
          const aurora = fs.existsSync(auroraPath)
            ? JSON.parse(fs.readFileSync(auroraPath, "utf8"))
            : {};

          if (!aurora.monzo) aurora.monzo = {};
          if (!aurora.monzo.core_balance) aurora.monzo.core_balance = 0;

          let coreBalance = aurora.monzo.core_balance;
          let applied = [];

          for (const row of sheet) {
            const id = row["Gmail ID"];
            if (state.includes(id)) continue;

            // âœ… Clean the amount (strip Â£ and commas)
            const rawAmount = row["Amount (Â£)"] || "0";
            const amount = parseFloat(rawAmount.toString().replace(/[Â£,]/g, ""));

            // âœ… Interpret "Yes"/"TRUE" as boolean
            const processed = row["Processed"] === true || row["Processed"] === "Yes" || row["Processed"] === "TRUE";
            const excluded = row["Exclude From Spend"] === true || row["Exclude From Spend"] === "Yes" || row["Exclude From Spend"] === "TRUE";

            if (!processed || excluded || isNaN(amount)) continue;

            // Apply the transaction
            coreBalance -= amount;
            console.log(`Applied transaction: Â£${amount.toFixed(2)} ${row["Merchant"] || "Unknown"} | New main balance: Â£${coreBalance.toFixed(2)}`);
            applied.push(id);
          }

          aurora.monzo.core_balance = parseFloat(coreBalance.toFixed(2));

          // Save updates
          fs.writeFileSync(auroraPath, JSON.stringify(aurora, null, 2));
          fs.writeFileSync(statePath, JSON.stringify([...state, ...applied], null, 2));
          EOF

      # =====================================================
      # STEP 5 â€“ Commit & Push Updated JSON
      # =====================================================
      - name: ðŸ“¤ Commit AuroraSync.json
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸŸ¢ Monzo transactions synced & core balance updated"
          file_pattern: AuroraSync.json .aurora/monzo_transfers_applied.json
          branch: main
