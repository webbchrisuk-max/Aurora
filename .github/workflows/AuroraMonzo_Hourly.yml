name: Aurora Monzo â€“ Hourly Pot + Transaction Sync

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  sync_monzo:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # =====================================================
      # STEP 1 â€“ Fetch Google Sheets (ALL FOUR)
      # =====================================================
      - name: ðŸ“¥ Fetch Transactions Sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transactions" -o transactions.json

      - name: ðŸ“¥ Fetch Transfers Sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transfers" -o transfers.json

      - name: ðŸ“¥ Fetch Direct Debits Sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/DirectDebits" -o dd.json

      - name: ðŸ“¥ Fetch MonzoCore Sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/MonzoCore" -o monzocore.json

      # =====================================================
      # STEP 2 â€“ Build AuroraMonzo.json (MATCHES YOUR HTML)
      # =====================================================
      - name: ðŸ›  Build AuroraMonzo.json
        run: |
          node << 'EOF'
          const fs = require('fs');

          const tx = JSON.parse(fs.readFileSync('transactions.json', 'utf8'));
          const transfers = JSON.parse(fs.readFileSync('transfers.json', 'utf8'));
          const dd = JSON.parse(fs.readFileSync('dd.json', 'utf8'));
          const core = JSON.parse(fs.readFileSync('monzocore.json', 'utf8'));

          const num = (v) => v === "" || v === null || v === undefined ? 0 : Number(v);

          // ============================
          // MAP TRANSACTIONS â†’ HTML format
          // ============================
          const mappedTx = tx.map(t => ({
            Date: t["Date"],
            Time: t["Time"],
            Merchant: t["Merchant"],
            "Amount (Â£)": num(t["Amount (Â£)"]),
            Type: t["Type"],
            Source: t["Source"],
            "Email Subject": t["Email Subject"],
            Category: t["Category"],
            Processed: t["Processed"],
            "Exclude From Spend": t["Exclude From Spend"],
            "Gmail ID": t["Gmail ID"]
          }));

          // ============================
          // MAP TRANSFERS
          // ============================
          const mappedTransfers = transfers.map(t => ({
            date: t["Date"],
            from_pot: t["From Pot"],
            to_pot: t["To Pot"],
            amount: num(t["Amount"]),
            note: t["Note"],
            processed: t["Processed"],
            type: t["Type"],
            uid: t["UID"]
          }));

          // ============================
          // MAP DIRECT DEBITS
          // ============================
          const mappedDD = dd.map(d => ({
            payee: d["Payee"],
            amount: num(d["Amount (Â£)"]),
            due_date: d["Due Date"],
            day: d["Day"],
            status: d["Status"],
            from_pot: d["FromPot"],
            paid: d["Paid?"]
          }));

          // ============================
          // MAP MONZO CORE (pots + balances)
          // ============================
          const pots = {};
          core.forEach(row => {
            const label = row["Label"];
            pots[label] = num(row["Value (Â£)"]);
          });

          const output = {
            monzo: {
              account_core: {
                main_balance: pots["Main Account"] || 0,
                payday_last: "",
                income_received: 0,
                pots: pots
              },
              direct_debits: mappedDD,
              subscriptions_from_main: [],
              transactions_feed: {
                recent: mappedTx
              },
              pot_transfers: mappedTransfers
            }
          };

          fs.writeFileSync("AuroraMonzo.json", JSON.stringify(output, null, 2));
          console.log("AuroraMonzo.json built successfully!");
          EOF

      # =====================================================
      # STEP 3 â€“ Push Updated JSON
      # =====================================================
      - name: ðŸ”¼ Push AuroraMonzo.json
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Updated AuroraMonzo.json (Monzo Sync)"
          file_pattern: AuroraMonzo.json