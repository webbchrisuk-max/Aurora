name: Aurora Monzo â€“ Hourly Pot + Transaction Sync

on:
  schedule:
    - cron: "0 * * * *"    # every hour
  workflow_dispatch:

concurrency:
  group: aurora-monzo-hourly
  cancel-in-progress: false

jobs:
  sync_monzo_hourly:
    runs-on: ubuntu-latest

    steps:
      # =====================================================
      # STEP 1 â€“ Checkout repository
      # =====================================================
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # =====================================================
      # STEP 2 â€“ Fetch Transfers sheet
      # =====================================================
      - name: ðŸŸ¢ Fetch Transfers sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transfers" -o transfers.json

      # =====================================================
      # STEP 3 â€“ Ensure state tracking
      # =====================================================
      - name: ðŸ“¦ Ensure state folder
        run: |
          mkdir -p .aurora
          if [ ! -f .aurora/monzo_transfers_applied.json ]; then
            echo "[]" > .aurora/monzo_transfers_applied.json
          fi

      # =====================================================
      # STEP 4 â€“ Apply NEW transfers to AuroraMonzo.json
      # =====================================================
      - name: ðŸ”„ Apply NEW Transfers
        run: |
          node << 'EOF'
          const fs = require("fs");

          const transfers = JSON.parse(fs.readFileSync("transfers.json", "utf8"));
          const statePath = ".aurora/monzo_transfers_applied.json";
          const monzoPath = "AuroraMonzo.json";

          const applied = JSON.parse(fs.readFileSync(statePath, "utf8"));
          const monzo = JSON.parse(fs.readFileSync(monzoPath, "utf8"));

          monzo.pots = monzo.pots || {};

          // Only apply NEW transfers
          const newOnes = transfers.filter(t => !applied.includes(t.id));

          newOnes.forEach(t => {
            const pot = t.pot?.trim();
            const amount = Number(t.amount || 0);

            if (!pot) return;

            monzo.pots[pot] = monzo.pots[pot] || { balance: 0, target: 0 };
            monzo.pots[pot].balance = Number(monzo.pots[pot].balance || 0) + amount;

            applied.push(t.id);
          });

          fs.writeFileSync(monzoPath, JSON.stringify(monzo, null, 2));
          fs.writeFileSync(statePath, JSON.stringify(applied, null, 2));
          EOF

      # =====================================================
      # STEP 5 â€“ Rebuild Monzo pot structure (LOCKED LIST)
      # =====================================================
      - name: ðŸ§® Rebuild Monzo pots from fixed list
        run: |
          node << 'EOF'
          const fs = require("fs");

          const path = "AuroraMonzo.json";
          const data = JSON.parse(fs.readFileSync(path, "utf8"));

          // ðŸ”’ Your final, locked pot names (order matters)
          const potNames = [
            "Flex Repayment",
            "Direct Debits",
            "Holiday Pot",
            "Coventry City F.C",
            "IGTrading",
            "Car Maintenance",
            "Work Buffer",
            "Savings",
            "Christmas",
            "Dentist",
            "Holding Pot"
          ];

          // Ensure pots object exists
          data.pots = data.pots || {};
          const oldPots = data.pots;
          const newPots = {};

          potNames.forEach((name, index) => {
            const existing = oldPots[name] || {};

            newPots[name] = {
              ...existing,
              balance: existing.balance ?? 0,
              target: existing.target ?? 0,
              sort_order: index + 1
            };
          });

          // Remove any pots not in the list
          data.pots = newPots;

          // Update timestamp
          data.meta = data.meta || {};
          data.meta.last_updated = new Date().toISOString();

          fs.writeFileSync(path, JSON.stringify(data, null, 2));
          EOF

      # =====================================================
      # STEP 6 â€“ Commit & Push
      # =====================================================
      - name: ðŸ“¤ Commit Monzo JSON updates
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"

          git add AuroraMonzo.json
          git commit -m "ðŸ”„ Auto-update AuroraMonzo.json pots + transfers" || echo "No changes"
          git push
