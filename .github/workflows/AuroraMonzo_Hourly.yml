name: Aurora Monzo â€“ Hourly Pot + Transaction Sync

on:
  schedule:
    - cron: "0 * * * *"   # Every hour UTC
  workflow_dispatch:

jobs:
  sync_monzo:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # =====================================================
      # STEP 1 â€“ Fetch ALL Sheets
      # =====================================================
      - name: ðŸ“¥ Fetch Transactions Sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transactions" -o transactions.json

      - name: ðŸ“¥ Fetch Transfers Sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transfers" -o transfers.json

      - name: ðŸ“¥ Fetch Direct Debits Sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/DirectDebits" -o dd.json

      - name: ðŸ“¥ Fetch MonzoCore Sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/MonzoCore" -o monzocore.json

      # =====================================================
      # STEP 2 â€“ Build AuroraMonzo.json
      # =====================================================
      - name: ðŸ›  Build AuroraMonzo.json
        run: |
          node << 'EOF'
          const fs = require('fs');

          const tx = JSON.parse(fs.readFileSync('transactions.json', 'utf8'));
          const transfers = JSON.parse(fs.readFileSync('transfers.json', 'utf8'));
          const dd = JSON.parse(fs.readFileSync('dd.json', 'utf8'));
          const core = JSON.parse(fs.readFileSync('monzocore.json', 'utf8'));

          const num = (v) => v === "" || v === null || v === undefined ? 0 : Number(v);

          // ============================
          // TRANSACTIONS
          // ============================
          const mappedTx = tx.map(t => ({
            Date: t["Date"],
            Time: t["Time"],
            Merchant: t["Merchant"],
            "Amount (Â£)": num(t["Amount (Â£)"]),
            Type: t["Type"],
            Source: t["Source"],
            "Email Subject": t["Email Subject"],
            Category: t["Category"],
            Processed: t["Processed"],
            "Exclude From Spend": t["Exclude From Spend"],
            "Gmail ID": t["Gmail ID"]
          }));

          // ============================
          // TRANSFERS
          // ============================
          const mappedTransfers = transfers.map(t => ({
            date: t["Date"],
            from_pot: t["From Pot"],
            to_pot: t["To Pot"],
            amount: num(t["Amount"]),
            note: t["Note"],
            processed: t["Processed"],
            type: t["Type"],
            uid: t["UID"]
          }));

          // ============================
          // DIRECT DEBITS
          // ============================
          const mappedDD = dd.map(d => ({
            payee: d["Payee"],
            amount: num(d["Amount (Â£)"]),
            due_date: d["Due Date"],
            day: d["Day"],
            status: d["Status"],
            from_pot: d["FromPot"],
            paid: d["Paid?"]
          }));

          // ============================
          // MONZO CORE (pots + balances)
          // ============================
          const pots = {};
          const monzoCoreObject = {};

          core.forEach(row => {
            const label = row["Label"];
            pots[label] = num(row["Value (Â£)"]);

            monzoCoreObject[label] = {
              value: num(row["Value (Â£)"]),
              target: num(row["Target"]) || null,
              total_due: num(row["Total Due"]) || null,
              remaining: row["Remaining After Payments"] === "" ? null : num(row["Remaining After Payments"])
            };
          });

          const output = {
            monzo: {
              account_core: {
                main_balance: pots["Main Account"] || 0,
                payday_last: "",
                payday_next: "",
                payday_cycle: "four_week",
                pay_period_days: 28,
                income_received: 0,
                pots: pots
              },
              monzo_core: monzoCoreObject,
              direct_debits: mappedDD,
              subscriptions_from_main: [],
              transactions_feed: { recent: mappedTx },
              pot_transfers: mappedTransfers
            }
          };

          // =====================================================
          // PAYDAY CALCULATION â€“ 4 WEEK CYCLE (28 DAYS)
          // =====================================================
          const BASE_PAYDAY = new Date("2025-11-07T00:00:00Z");
          const today = new Date();

          let payday_last = new Date(BASE_PAYDAY);
          let payday_next = new Date(BASE_PAYDAY);

          while (payday_next <= today) {
            payday_last = new Date(payday_next);
            payday_next = new Date(payday_next.getTime() + 28 * 86400000);
          }

          output.monzo.account_core.payday_last = payday_last.toISOString().split("T")[0];
          output.monzo.account_core.payday_next = payday_next.toISOString().split("T")[0];

          // =====================================================
          // SUBSCRIPTIONS FROM MAIN ACCOUNT
          // =====================================================
          const subscriptions = mappedDD
            .filter(d => (d.from_pot || "").toLowerCase() === "main account")
            .map(d => ({
              service: d.payee,
              amount: d.amount,
              renewal_date: d.due_date
            }));

          output.monzo.subscriptions_from_main = subscriptions;

          // =====================================================
          // WRITE FINAL JSON
          // =====================================================
          fs.writeFileSync("AuroraMonzo.json", JSON.stringify(output, null, 2));
          console.log("AuroraMonzo.json built successfully!");
          EOF

      # =====================================================
      # STEP 3 â€“ Commit final JSON
      # =====================================================
      - name: ðŸ”¼ Push AuroraMonzo.json
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Updated AuroraMonzo.json (Monzo Sync)"
          file_pattern: AuroraMonzo.json