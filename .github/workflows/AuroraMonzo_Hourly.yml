name: Aurora Monzo ‚Äì Hourly Pot + Transaction Sync

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

concurrency:
  group: aurora-monzo-hourly
  cancel-in-progress: false

jobs:
  sync_monzo_hourly:
    runs-on: ubuntu-latest

    steps:
      # =====================================================
      # STEP 0 ‚Äì Checkout repo
      # =====================================================
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      # =====================================================
      # STEP 0.5 ‚Äì Payday Rollover BEFORE anything else
      # =====================================================
      - name: üìÜ Rollover pay-period transactions if needed
        run: |
          node <<'EOF'
          const fs = require('fs');
          const path = require('path');

          const statePath = path.join('.aurora', 'pay_period.json');
          const txPath = 'transactions.json';
          const archivePath = 'transactions_archive.json';

          function readJson(p, fallback) {
            try { return JSON.parse(fs.readFileSync(p, 'utf8')); }
            catch { return fallback; }
          }

          const state = readJson(statePath, null);
          if (!state) process.exit(0);

          const today = new Date();
          const todayYMD = today.toISOString().slice(0, 10);
          const nextPayday = new Date(state.next_payday + "T00:00:00Z");
          const nextPaydayYMD = nextPayday.toISOString().slice(0, 10);

          if (todayYMD < nextPaydayYMD) process.exit(0);

          console.log("üîÑ Payday reached ‚Äî rolling over.");

          const oldTx = readJson(txPath, []);
          const archive = readJson(archivePath, []);

          if (oldTx.length > 0) {
            const merged = archive.concat(oldTx);
            fs.writeFileSync(archivePath, JSON.stringify(merged, null, 2));
            console.log(`Archived ${oldTx.length} past-period transactions.`);
          }

          fs.writeFileSync(txPath, '[]\n');

          const ms = 86400000;
          const newStart = nextPayday;
          const newNext = new Date(newStart.getTime() + (state.period_length_days || 28) * ms);

          state.current_period_start = newStart.toISOString().slice(0, 10);
          state.next_payday = newNext.toISOString().slice(0, 10);

          fs.writeFileSync(statePath, JSON.stringify(state, null, 2));
          console.log("Updated pay_period.json:", state);
          EOF

      # =====================================================
      # PROTECT AuroraSync.json at all times
      # =====================================================
      - name: üîí Hard-lock AuroraSync.json
        run: |
          if [ -f "AuroraSync.json" ]; then
            chmod 444 AuroraSync.json
          fi

      # =====================================================
      # STEP 1 ‚Äì Fetch Google Sheets
      # =====================================================
      - name: üü¢ Fetch Transfers
        run: curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transfers" -o transfers.json

      - name: üü¢ Fetch Transactions (RAW FULL SHEET)
        run: curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transactions" -o transactions_raw.json

      - name: üü¢ Fetch Direct Debits
        run: curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/DirectDebits" -o directdebits.json

      # =====================================================
      # STEP 2 ‚Äì Ensure State Folder
      # =====================================================
      - name: üì¶ Ensure state folder
        run: |
          mkdir -p .aurora
          if [ ! -f .aurora/monzo_transfers_applied.json ]; then
            echo "[]" > .aurora/monzo_transfers_applied.json
          fi

      # =====================================================
      # STEP 3 ‚Äì Apply NEW Transfers (unchanged)
      # =====================================================
      - name: üîÑ Apply NEW Transfers
        run: |
          node <<'EOF'
          const fs = require('fs');
          const transfers = JSON.parse(fs.readFileSync('transfers.json', 'utf8'));
          const applied = JSON.parse(fs.readFileSync('.aurora/monzo_transfers_applied.json', 'utf8'));

          const newOnes = transfers.filter(t => t.UID && !applied.includes(t.UID));

          newOnes.forEach(t => applied.push(t.UID));

          fs.writeFileSync('.aurora/monzo_transfers_applied.json', JSON.stringify(applied, null, 2));
          EOF

      # =====================================================
      # STEP 3.5 ‚Äì Merge RAW transactions into pay-period list
      # =====================================================
      - name: üîç Merge RAW into pay-period transactions
        run: |
          node <<'EOF'
          const fs = require('fs');

          const raw = JSON.parse(fs.readFileSync('transactions_raw.json', 'utf8'));
          const current = JSON.parse(fs.readFileSync('transactions.json', 'utf8'));
          const state = JSON.parse(fs.readFileSync('.aurora/pay_period.json', 'utf8'));

          const start = new Date(state.current_period_start + "T00:00:00Z");

          const filtered = raw.filter(t => {
            const dateParts = t.Date.split('/');
            const d = new Date(`${dateParts[2]}-${dateParts[1]}-${dateParts[0]}T00:00:00Z`);
            return d >= start;
          });

          // Remove duplicates by Gmail ID OR by exact fields
          const seen = new Set();
          const merged = [];

          [...current, ...filtered].forEach(t => {
            const key = t["Gmail ID"] || JSON.stringify(t);
            if (!seen.has(key)) {
              seen.add(key);
              merged.push(t);
            }
          });

          fs.writeFileSync('transactions.json', JSON.stringify(merged, null, 2));
          console.log(`Pay-period transactions now: ${merged.length}`);
          EOF

      # =====================================================
      # STEP 4 ‚Äì Auto-mark Paid DDs
      # =====================================================
      - name: üîò Auto-mark Paid DDs
        run: |
          node <<'EOF'
          const fs = require('fs');
          const dd = JSON.parse(fs.readFileSync('directdebits.json', 'utf8'));
          const tx = JSON.parse(fs.readFileSync('transactions.json', 'utf8'));

          dd.forEach(item => {
            if (item.paid === true) return;
            const name = (item.payee || "").toLowerCase();
            const match = tx.find(t =>
              ((t.Merchant || "") + " " + (t.Description || "")).toLowerCase().includes(name)
            );
            if (match) item.paid = true;
          });

          fs.writeFileSync('directdebits.json', JSON.stringify(dd, null, 2));
          EOF

      # =====================================================
      # STEP 5 ‚Äì Update AuroraMonzo.json (SAFE)
      # =====================================================
      - name: üßø Safe merge for AuroraMonzo.json
        run: |
          node <<'EOF'
          const fs = require('fs');

          let core = {};
          if (fs.existsSync('AuroraMonzo.json')) {
            core = JSON.parse(fs.readFileSync('AuroraMonzo.json', 'utf8'));
          }

          if (!core.monzo) core.monzo = {};
          core.monzo.transactions = JSON.parse(fs.readFileSync('transactions.json', 'utf8'));
          core.monzo.direct_debits = JSON.parse(fs.readFileSync('directdebits.json', 'utf8'));
          core.monzo.transfers = JSON.parse(fs.readFileSync('transfers.json', 'utf8'));

          fs.writeFileSync('AuroraMonzo.json', JSON.stringify(core, null, 2));
          EOF

      # =====================================================
      # STEP 6 ‚Äì Commit & Push
      # =====================================================
      - name: üì§ Commit and Push
        run: |
          git config user.name "Aurora Automation"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Aurora Monzo Sync ‚Äì Pay-period merge + rollover" || echo "No changes"
          git push || echo "No changes"
