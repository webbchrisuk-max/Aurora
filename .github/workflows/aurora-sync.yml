name: Aurora ISA â€“ 5-Minute Live Shares + Dividends Sync

on:
  schedule:
    - cron: "*/5 8-16 * * 1-5"
    - cron: "30 16 * * 1-5"
  workflow_dispatch:

jobs:
  isa_sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch Holdings sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" -o holdings.json

      - name: Fetch Dividends sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" -o dividends.json

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Update ISA data
        run: |
          node << 'EOF'
          const fs = require("fs");

          const holdings = JSON.parse(fs.readFileSync("holdings.json", "utf8"));
          const dividendsSheet = JSON.parse(fs.readFileSync("dividends.json", "utf8"));

          const auroraPath = "AuroraSync.json";
          const aurora = JSON.parse(fs.readFileSync(auroraPath, "utf8"));

          const now = new Date().toISOString().replace("T"," ").substring(0,19);

          aurora.isa = aurora.isa || {};
          aurora.isa.holdings = {
            ig_isa: [],
            trade212_isa: []
          };

          // ----------------------------------------------------
          // PROCESS HOLDINGS FROM GOOGLE SHEET ONLY
          // ----------------------------------------------------
          for (const row of holdings) {
            const account = (row["account"] || "").trim().toUpperCase();
            const entry = {
              ticker: row["ticker"],
              name: row["name"],
              shares: parseFloat(row["shares"] || 0),
              book_cost: parseFloat(row["book_cost"] || 0),
              live_price: parseFloat(row["live_price"] || 0),
              value: parseFloat(row["value"] || 0),
              gain_value: parseFloat(row["gain_value"] || 0),
              gain_percentage: parseFloat(row["gain_percentage"] || 0),
              annual_dividend_per_share: parseFloat(row["annual_dividend_per_share"] || 0),
              annual_div_yield: parseFloat(row["annual_div_yield"] || 0),
              annual_income: parseFloat(row["annual_income"] || 0),
              sector: row["sector"],
              last_updated: row["last_updated"]
            };

            if (account === "IG ISA") aurora.isa.holdings.ig_isa.push(entry);
            if (account === "TRADE212") aurora.isa.holdings.trade212_isa.push(entry);
          }

          // ----------------------------------------------------
          // PROCESS DIVIDENDS (SAME LOGIC AS BEFORE)
          // ----------------------------------------------------
          const today = new Date().toISOString().split("T")[0];

          const upcoming = [];
          const nextFive = [];
          const monthlyTotals = {};
          let yearlyTotal = 0;

          for (const d of dividendsSheet) {
            const payDate = d["pay_date"];
            const total = parseFloat(d["total_dividend"] || 0);

            // auto status
            let status = d["status"] || "Estimated";
            if (payDate && payDate < today) status = "Paid";

            if (payDate && payDate >= today) {
              upcoming.push({
                ticker: d["ticker"],
                name: d["name"],
                ex_div_date: d["ex_div_date"],
                pay_date: payDate,
                dividend_per_share: d["dividend_per_share"],
                shares_at_exdiv: d["shares_at_exdiv"],
                total_dividend: total,
                frequency: d["frequency"],
                status
              });
            }

            if (payDate) {
              const month = payDate.substring(0, 7);
              monthlyTotals[month] = (monthlyTotals[month] || 0) + total;
            }

            yearlyTotal += total;
          }

          upcoming.sort((a, b) => a.pay_date.localeCompare(b.pay_date));
          nextFive.push(...upcoming.slice(0, 5));

          aurora.isa.dividends = {
            last_updated: now,
            upcoming,
            next_five: nextFive,
            monthly_totals: monthlyTotals,
            annual_total: yearlyTotal
          };

          fs.writeFileSync(auroraPath, JSON.stringify(aurora, null, 2));
          EOF

      - name: Commit changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add AuroraSync.json
          git commit -m "ISA update from Google Sheet $(date)" || echo "No changes"
          git push
