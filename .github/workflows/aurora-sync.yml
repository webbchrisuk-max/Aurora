name: Aurora ISA â€“ Live Price Sync (Watchlist Powered)

on:
  schedule:
    - cron: "*/10 8-16 * * 1-5"   # every 10 minutes during market hours
  workflow_dispatch:

concurrency:
  group: aurora-isa-sync
  cancel-in-progress: false

jobs:
  isa_live_update:
    runs-on: ubuntu-latest

    steps:
      # =====================================================
      # 1) CHECKOUT
      # =====================================================
      - name: ðŸ§© Checkout repo
        uses: actions/checkout@v4

      # =====================================================
      # 2) FETCH HOLDINGS SHEET (Tickers + shares + book cost)
      # =====================================================
      - name: ðŸŸ¢ Fetch Holdings sheet
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" \
            -o holdings.json

      # =====================================================
      # 3) FETCH WATCHLIST.JSON (Has the live prices)
      # =====================================================
      - name: ðŸ”µ Fetch Watchlist JSON
        run: |
          curl -s \
            "https://webbchrisuk-max.github.io/watchlist.json" \
            -o watchlist.json

      # =====================================================
      # 4) UPDATE AURORASYNC.JSON WITH TICKERS + LIVE PRICES
      # =====================================================
      - name: ðŸ”§ Apply Prices to ISA
        run: |
          node << 'EOF'
          const fs = require("fs");

          const auroraPath = "AuroraSync.json";
          const holdingsRaw = JSON.parse(fs.readFileSync("holdings.json", "utf8"));
          const watchlist = JSON.parse(fs.readFileSync("watchlist.json", "utf8"));
          const aurora = JSON.parse(fs.readFileSync(auroraPath, "utf8"));

          // Helper: find live price from watchlist
          function getPrice(ticker) {
            const w = watchlist.find(x => x.ticker?.toUpperCase() === ticker?.toUpperCase());
            if (!w) return 0;
            return Number(w.live_price || 0);
          }

          // Reset ISA structure safely
          aurora.isa = aurora.isa || {};
          aurora.isa.holdings = { ig_isa: [], trade212_isa: [] };

          holdingsRaw.forEach(row => {
            const live = getPrice(row["ticker"]);
            const shares = Number(row["shares"] || 0);
            const book = Number(row["book_cost"] || 0);

            const value = shares * live;
            const gain = value - book;
            const gainPct = book > 0 ? (gain / book * 100) : 0;

            const obj = {
              ticker: row["ticker"],
              name: row["name"],
              shares,
              book_cost: book,
              live_price: live,
              value,
              gain_value: gain,
              gain_percentage: gainPct,
              annual_dividend_per_share: Number(row["annual_dividend_per_share"] || 0),
              annual_div_yield: live > 0 ? (row["annual_dividend_per_share"] / live * 100) : 0,
              annual_income: shares * Number(row["annual_dividend_per_share"] || 0),
              sector: row["sector"],
              last_updated: new Date().toISOString().replace("T"," ").substring(0,19)
            };

            if (row["account"] === "IG ISA") aurora.isa.holdings.ig_isa.push(obj);
            if (row["account"] === "TRADE212") aurora.isa.holdings.trade212_isa.push(obj);
          });

          // Save back
          fs.writeFileSync(auroraPath, JSON.stringify(aurora, null, 2));
          EOF

      # =====================================================
      # 5) COMMIT & PUSH
      # =====================================================
      - name: ðŸ“¤ Commit and Push
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "Aurora Automation"

          # NEW FIX
          git pull --rebase origin main

          git add AuroraSync.json
          git commit -m "ðŸŸ¢ ISA Updated with Live Prices (Watchlist Powered)" || echo "No changes to commit"
          git push
