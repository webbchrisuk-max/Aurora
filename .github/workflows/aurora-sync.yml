name: ğŸª„ Aurora Data Sync â€“ ISA Auto Builder (Market Hours)

on:
  schedule:
    - cron: "0 8-17 * * 1-5"   # Runs hourly between 08:00â€“17:00 Mondayâ€“Friday
  workflow_dispatch:

jobs:
  build_aurora:
    runs-on: ubuntu-latest

    steps:
      # ================================
      # STEP 1 â€” Checkout Repo
      # ================================
      - name: ğŸ§© Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ================================
      # STEP 2 â€” Python + jq
      # ================================
      - name: âš™ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install jq
        run: sudo apt-get install -y jq

      # ================================
      # STEP 3 â€” Fetch Google Sheets
      # ================================
      - name: ğŸŒ Fetch Sheets (Holdings + Dividends)
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings"  -o holdings.json
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" -o dividends.json

      # ================================
      # STEP 4 â€” Build ISA Summary
      # ================================
      - name: ğŸ§® Build ISA Summary + Dividend Planner
        run: |
          python3 << 'EOF'
          import json, datetime

          # Load sheets
          with open("holdings.json") as f:
              holdings = json.load(f)

          with open("dividends.json") as f:
              dividends = json.load(f)

          # --- IG ISA Snapshot (from Webby) ---
          ig_positions_value = 58250.00
          ig_book_cost = 55126.16
          ig_gain = ig_positions_value - ig_book_cost
          ig_gain_pct = (ig_gain / ig_book_cost) * 100
          ig_cash = 504.25

          # --- Trade212 ISA Snapshot (from Webby) ---
          t212_positions = 1886.52
          t212_cash = 19.94
          t212_total = 1906.46
          t212_book_cost = t212_positions
          t212_gain = t212_total - t212_book_cost
          t212_gain_pct = (t212_gain / t212_book_cost) * 100

          # --- Portfolio summary ---
          total_value = ig_positions_value + ig_cash + t212_total
          annual_income = sum(float(x.get("AnnualIncome",0)) for x in dividends)
          div_yield = (annual_income / total_value) * 100 if total_value else 0

          # Build monthly breakdown
          months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]
          monthly = {m:0 for m in months}
          for row in dividends:
              m = row.get("Month","")
              amt = float(row.get("Amount",0))
              if m in monthly:
                  monthly[m] += amt

          # Dividend Planner
          schedule = {}
          for row in dividends:
              name = row.get("Ticker","Unknown")
              schedule[name] = {
                  "next_pay_date": row.get("PayDate",""),
                  "next_ex_div": row.get("ExDiv",""),
                  "expected_dividend": float(row.get("Amount",0))
              }

          div_planner = {
              "received_ytd": sum(float(x.get("ReceivedYTD",0)) for x in dividends),
              "forecast_total": annual_income,
              "monthly_breakdown": monthly,
              "schedule_by_holding": schedule
          }

          # --- Build objects for JSON output ---
          ig_obj = {
              "account_name": "IG ISA",
              "balance": ig_positions_value + ig_cash,
              "positions_value": ig_positions_value,
              "book_cost": ig_book_cost,
              "unrealised_gain": round(ig_gain,2),
              "gain_percent": round(ig_gain_pct,2),
              "cash_balance": ig_cash
          }

          t212_obj = {
              "account_name": "Trade212 ISA",
              "balance": t212_total,
              "positions_value": t212_positions,
              "book_cost": t212_book_cost,
              "unrealised_gain": round(t212_gain,2),
              "gain_percent": round(t212_gain_pct,2),
              "cash_balance": t212_cash
          }

          portfolio_summary = {
              "total_value": round(total_value,2),
              "dividend_yield": round(div_yield,2),
              "annual_income_gbp": round(annual_income,2),
              "last_calculated": datetime.datetime.utcnow().isoformat()
          }

          build = {
              "isa": {
                  "ig_isa": ig_obj,
                  "trade212_isa": t212_obj,
                  "portfolio_summary": portfolio_summary
              },
              "dividend_planner": div_planner,
              "meta": {
                  "last_updated": datetime.datetime.utcnow().isoformat(),
                  "source": "Google Sheets + ISA Builder"
              }
          }

          with open("isa_build.json","w") as f:
              json.dump(build,f,indent=2)
          EOF

      # ================================
      # STEP 5 â€” Commit to Repo
      # ================================
      - name: ğŸš€ Commit ISA Build JSON
        run: |
          git config user.name "AuroraSync Bot"
          git config user.email "actions@github.com"
          git add isa_build.json
          git commit -m "ğŸ”„ Auto-update: ISA Build (Market Hours)" || echo "No changes"
          git push
