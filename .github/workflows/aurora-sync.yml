name: ðŸ”„ Aurora Data Sync

on:
  schedule:
    - cron: "0 8,16 * * *" # Runs twice daily at 08:00 and 16:00 UTC
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Pull data from OpenSheet feeds
        run: |
          curl -L "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" -o Holdings.json
          curl -L "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" -o Dividends.json

      - name: Merge data into AuroraSync.json
        run: |
          python3 .github/scripts/update_aurora_sync.py

      # âœ… Always sync latest main before commit to prevent push conflicts
      - name: Sync latest main branch
        run: |
          git config --global pull.rebase false
          git fetch origin main
          git merge origin/main --strategy-option ours || true

      - name: Commit & Push updated AuroraSync.json
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ”„ Auto-update AuroraSync.json (Enhanced Quarterly + Clean Monthly Breakdown)"
          file_pattern: AuroraSync.json
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          commit_author: webbchrisuk-max <240604100+webbchrisuk-max@users.noreply.github.com>
