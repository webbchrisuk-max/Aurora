name: Aurora ISA â€“ 5-Minute Live Shares Sync (Watchlist Prices)

on:
  schedule:
    - cron: "*/5 8-16 * * 1-5"
    - cron: "30 16 * * 1-5"
  workflow_dispatch:

concurrency:
  group: aurora-isa-sync
  cancel-in-progress: false

jobs:
  isa_sync:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =====================================================
      # FETCH HOLDINGS + WATCHLIST
      # =====================================================
      - name: ðŸŸ¢ Fetch Holdings sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" -o holdings.json

      - name: ðŸŸ£ Fetch Watchlist sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Watchlist" -o watchlist.json

      # =====================================================
      # PROCESS USING NODE
      # =====================================================
      - name: ðŸ”§ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ðŸ”„ Update ISA with Watchlist Prices
        run: |
          node << 'EOF'
          const fs = require("fs");

          const auroraPath = "AuroraSync.json";
          const holdings = JSON.parse(fs.readFileSync("holdings.json", "utf8"));
          const watchlist = JSON.parse(fs.readFileSync("watchlist.json", "utf8"));
          const aurora = JSON.parse(fs.readFileSync(auroraPath, "utf8"));

          const round = (v, d=2) => Number(Number(v).toFixed(d));

          // --------------------------------------------------
          // Build watchlist price lookup (ticker â†’ price)
          // Converts LON:MNG â†’ MNG.L for lookup
          // --------------------------------------------------
          const priceMap = {};
          watchlist.forEach(row => {
            let t = row["ticker"] || "";

            if (!t) return;

            // Remove smart chip label junk (OpenSheet already cleans most)
            t = String(t).trim();

            // Convert Google tickers to Yahoo-style
            if (t.startsWith("LON:")) {
              t = t.replace("LON:", "") + ".L";
            }

            // Astrid (6XS) stays raw
            if (t === "6XS") {
              // price_map defined later
            }

            priceMap[t] = Number(row["live_price"] || 0);
          });

          // --------------------------------------------------
          // EXTRA FIX: Astrid (6XS) price support
          // --------------------------------------------------
          if (priceMap["6XS"] === 0 && priceMap["6XS"] !== undefined) {
            // If Google returns 0 because it's too small, keep as 0
            priceMap["6XS"] = 0;
          }

          // --------------------------------------------------
          // Reset ISA section
          // --------------------------------------------------
          aurora.isa = aurora.isa || {};
          aurora.isa.holdings = { ig_isa: [], trade212_isa: [] };

          // --------------------------------------------------
          // Build holdings with real live prices
          // --------------------------------------------------
          holdings.forEach(row => {
            let ticker = (row["ticker"] || "").trim();

            // Convert holdings tickers too (if still using LON:MNG)
            if (ticker.startsWith("LON:"))
              ticker = ticker.replace("LON:", "") + ".L";

            const shares = Number(row["shares"] || 0);
            const book = Number(row["book_cost"] || 0);
            const dps = Number(row["annual_dividend_per_share"] || 0);
            const sector = row["sector"] || "";

            const live = priceMap[ticker] || 0;
            const value = shares * live;
            const gain = value - book;
            const gainPct = book ? (gain / book) * 100 : 0;
            const income = shares * dps;
            const yieldPct = live ? (dps / live) * 100 : 0;

            const item = {
              ticker,
              name: row["name"],
              shares,
              book_cost: round(book, 2),
              live_price: round(live, 4),
              value: round(value, 3),
              gain_value: round(gain, 3),
              gain_percentage: round(gainPct, 2),
              annual_dividend_per_share: round(dps, 4),
              annual_div_yield: round(yieldPct, 2),
              annual_income: round(income, 2),
              sector,
              last_updated: new Date().toISOString().replace("T"," ").substring(0,19)
            };

            if (row["account"] === "IG ISA")
              aurora.isa.holdings.ig_isa.push(item);

            if (row["account"] === "TRADE212")
              aurora.isa.holdings.trade212_isa.push(item);
          });

          // --------------------------------------------------
          // Save JSON
          // --------------------------------------------------
          fs.writeFileSync(auroraPath, JSON.stringify(aurora, null, 2));
          console.log("âœ… ISA updated using WATCHLIST prices.");
          EOF

      # =====================================================
      # GIT SAVE
      # =====================================================
      - name: ðŸ“¥ Pull latest
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "Aurora Automation"
          git pull --rebase origin main || true

      - name: ðŸ“¤ Commit & Push
        run: |
          git add AuroraSync.json
          git commit -m "ðŸ”„ ISA updated using Watchlist prices" || true
          git push origin main || true