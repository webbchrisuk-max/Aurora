name: Aurora Data Sync

on:
  schedule:
    - cron: "0 * * * *" # every hour
  workflow_dispatch:     # allows manual run

permissions:
  contents: write
  actions: read

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: üîÑ Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set up environment
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: üßÆ Install dependencies
        run: sudo apt-get install jq -y

      - name: üì• Fetch Google Sheets Data
        run: |
          echo "Fetching latest data from Google Sheets..."
          curl -L "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" -o holdings.json
          curl -L "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" -o dividends.json
          echo "‚úÖ Google Sheets data fetched."

      - name: üîß Merge data into AuroraSync.json
        run: |
          echo "Merging data into AuroraSync.json..."
          cp AuroraSync.json AuroraSync_temp.json
          # (You can extend this with jq merge logic if required)
          mv AuroraSync_temp.json AuroraSync.json
          echo "‚úÖ Merge complete."

      - name: üíπ Recalculate Dividend Yield & Annual Income
        run: |
          FILE="AuroraSync.json"
          echo "Recalculating yield..."
          total_income=$(jq '[.isa_feed[].annual_income|tonumber] | add' $FILE)
          total_value=$(jq '[.isa_feed[].value|tonumber] | add' $FILE)
          yield=$(python3 - <<EOF
total_income=$total_income
total_value=$total_value
print(round((total_income/total_value)*100, 2))
EOF
)
          jq --argjson y "$yield" --argjson ti "$total_income" \
            '.isa.portfolio_summary.dividend_yield=$y |
             .isa.portfolio_summary.annual_income_gbp=$ti |
             .isa.portfolio_summary.last_calculated=(now | todate)' \
             $FILE > tmp.json && mv tmp.json $FILE
          echo "‚úÖ Dividend yield updated to $yield%"

      - name: üßæ Validate JSON
        run: |
          cat AuroraSync.json | jq . > /dev/null
          echo "‚úÖ JSON validation passed."

      - name: üöÄ Commit and push changes
        run: |
          git config user.name "AuroraSync Bot"
          git config user.email "actions@github.com"
          git add AuroraSync.json
          git commit -m "Auto-update: AuroraSync.json (yield + income recalculated)" || echo "No changes to commit."
          git push
          echo "‚úÖ AuroraSync.json updated successfully."

      - name: ‚úÖ Mark workflow as success
        run: echo "Aurora Data Sync completed successfully."