name: Aurora ISA â€“ 5-Minute Live Shares + Dividends Sync

on:
  schedule:
    - cron: "*/5 8-16 * * 1-5"
    - cron: "30 16 * * 1-5"
  workflow_dispatch:

concurrency:
  group: aurora-isa-sync
  cancel-in-progress: false

jobs:
  isa_sync:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repo
        uses: actions/checkout@v4

      # -------------------------------------------------------
      # FETCH HOLDINGS + DIVIDENDS FROM GOOGLE SHEETS
      # -------------------------------------------------------
      - name: ðŸŸ¢ Fetch Holdings
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" \
          -o holdings.json

      - name: ðŸŸ£ Fetch Dividends
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" \
          -o dividends.json

      - name: ðŸ”§ Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -------------------------------------------------------
      # PROCESS + UPDATE AuroraSync.json (HOLDINGS + DIVIDENDS)
      # -------------------------------------------------------
      - name: ðŸ”„ Update AuroraSync.json
        run: |
          node << 'EOF'
          const fs = require("fs");

          const holdingsSheet = JSON.parse(fs.readFileSync("holdings.json", "utf8"));
          const dividendsSheet = JSON.parse(fs.readFileSync("dividends.json", "utf8"));

          const path = "AuroraSync.json";
          const aurora = JSON.parse(fs.readFileSync(path, "utf8"));

          aurora.isa = aurora.isa || {};
          aurora.isa.holdings = {
            ig_isa: [],
            trade212_isa: []
          };

          const now = new Date().toISOString().replace("T"," ").substring(0,19);

          async function getPrice(symbol) {
            try {
              const formatted = symbol.replace("LON:", "") + ".L";
              const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${formatted}`;
              const res = await fetch(url);
              const json = await res.json();
              return json.quoteResponse.result[0]?.regularMarketPrice ?? null;
            } catch {
              return null;
            }
          }

          // ------------------------------------------
          // HOLDINGS PROCESSING (MATCHED TO YOUR COLUMNS)
          // ------------------------------------------
          async function processHoldings() {
            for (const row of holdingsSheet) {
              const account = row["account"];
              const ticker = row["ticker"];
              const name = row["name"];
              const shares = parseFloat(row["shares"] || 0);
              const book = parseFloat(row["book_cost"] || 0);
              const sector = row["sector"] || "";
              const annualIncome = parseFloat(row["annual_income"] || 0);
              const annualDPS = parseFloat(row["annual_dividend_per_share"] || 0);

              const live = await getPrice(ticker);
              if (!live) continue;

              const value = live * shares;
              const gain = value - book;
              const gainPct = book > 0 ? (gain / book) * 100 : 0;

              const holdingObj = {
                ticker,
                name,
                shares,
                live_price: live,
                book_cost: book,
                value,
                gain_value: gain,
                gain_percentage: gainPct,
                annual_dividend_per_share: annualDPS,
                annual_income: annualIncome,
                sector,
                last_updated: now
              };

              if (account === "IG ISA") {
                aurora.isa.holdings.ig_isa.push(holdingObj);
              } else if (account === "TRADE212") {
                aurora.isa.holdings.trade212_isa.push(holdingObj);
              }
            }
          }

          // ------------------------------------------
          // DIVIDENDS PROCESSING
          // ------------------------------------------
          function processDividends() {
            const today = new Date().toISOString().split("T")[0];
            const upcoming = [];
            const nextFive = [];
            const monthlyTotals = {};
            let totalYear = 0;

            for (const d of dividendsSheet) {
              const pay = d["pay_date"];
              const total = parseFloat(d["total_dividend"] || 0);

              if (pay >= today) {
                upcoming.push(d);
              }

              if (pay) {
                const month = pay.substring(0,7);
                monthlyTotals[month] = (monthlyTotals[month] || 0) + total;
              }

              totalYear += total;
            }

            upcoming.sort((a,b) => a.pay_date.localeCompare(b.pay_date));

            aurora.isa.dividends = {
              last_updated: now,
              upcoming,
              next_five: upcoming.slice(0,5),
              monthly_totals: monthlyTotals,
              annual_total: totalYear
            };
          }

          (async () => {
            await processHoldings();
            processDividends();
            fs.writeFileSync(path, JSON.stringify(aurora, null, 2));
          })();
          EOF

      - name: ðŸ“¤ Commit & Push
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add AuroraSync.json
          git commit -m "ISA: Updated holdings + dividends" || echo "No changes"
          git push
