name: Aurora ISA â€“ 5-Minute Live Shares + Dividends Sync

on:
  schedule:
    - cron: "*/5 8-16 * * 1-5"      # Every 5 mins 08:00â€“16:59
    - cron: "30 16 * * 1-5"         # Final run at 16:30
  workflow_dispatch:

concurrency:
  group: aurora-isa-sync
  cancel-in-progress: false

jobs:
  isa_sync:
    runs-on: ubuntu-latest

    steps:
      # =====================================================
      # STEP 1 â€” Checkout repo
      # =====================================================
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # =====================================================
      # STEP 2 â€” Fetch Holdings sheet
      # =====================================================
      - name: ðŸŸ¢ Fetch Holdings sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" -o holdings.json

      # =====================================================
      # STEP 3 â€” Fetch Dividends sheet
      # =====================================================
      - name: ðŸŸ£ Fetch Dividends sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" -o dividends.json

      # =====================================================
      # STEP 4 â€” Install Node
      # =====================================================
      - name: ðŸ”§ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # =====================================================
      # STEP 5 â€” Update AuroraSync.json
      # =====================================================
      - name: ðŸ”„ Update ISA prices + dividends
        run: |
          node << 'EOF'
          const fs = require("fs");

          const holdings = JSON.parse(fs.readFileSync("holdings.json", "utf8"));
          const dividendsSheet = JSON.parse(fs.readFileSync("dividends.json", "utf8"));

          const auroraPath = "AuroraSync.json";
          const aurora = JSON.parse(fs.readFileSync(auroraPath, "utf8"));

          aurora.isa = aurora.isa || {};
          aurora.isa.ig_isa = aurora.isa.ig_isa || { holdings: {} };
          aurora.isa.trade212_isa = aurora.isa.trade212_isa || { holdings: {} };
          aurora.isa.dividends = aurora.isa.dividends || {};

          const now = new Date().toISOString().replace("T", " ").substring(0, 19);

          // -----------------------------------------------------
          // Fetch live price per ticker
          // -----------------------------------------------------
          async function getLivePrice(ticker) {
            try {
              const symbol = ticker.replace("LON:", "") + ".L";
              const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbol}`;
              const res = await fetch(url);
              const data = await res.json();
              return data.quoteResponse.result[0]?.regularMarketPrice ?? null;
            } catch {
              return null;
            }
          }

          // -----------------------------------------------------
          // Update ISA holdings with live prices
          // -----------------------------------------------------
          async function updateHoldings() {
            for (const row of holdings) {
              const account = row["account"];    // ðŸ”µ IMPORTANT
              const ticker = row["ticker"];
              const shares = parseFloat(row["shares"] || 0);
              const book = parseFloat(row["book_cost"] || 0);

              const price = await getLivePrice(ticker);
              if (!price) continue;

              const value = price * shares;
              const gain = value - book;

              const item = {
                name: row["name"] || "",
                shares,
                book_cost: book,
                live_price: price,
                value,
                gain_value: gain,
                gain_percent: book > 0 ? (gain / book) * 100 : 0,
                annual_dividend_per_share: parseFloat(row["annual_dividend_per_share"] || 0),
                annual_income: parseFloat(row["annual_income"] || 0),
                sector: row["sector"] || "",
                last_updated: now
              };

              // ðŸŸ¦ Correct separation
              if (account === "IG ISA") {
                aurora.isa.ig_isa.holdings[ticker] = item;
              }

              if (account === "TRADE212") {
                aurora.isa.trade212_isa.holdings[ticker] = item;
              }
            }
          }

          // -----------------------------------------------------
          // Process Dividends
          // -----------------------------------------------------
          function processDividends() {
            const today = new Date().toISOString().split("T")[0];

            const upcoming = [];
            const nextFive = [];
            const monthlyTotals = {};
            let yearlyTotal = 0;

            for (const d of dividendsSheet) {
              const ticker = d["ticker"];
              const exDiv = d["ex_div_date"];
              const payDate = d["pay_date"];
              const total = parseFloat(d["total_dividend"] || 0);
              const status = d["status"] || "Estimated";

              let autoStatus = status;
              if (payDate && payDate < today) autoStatus = "Paid";

              if (payDate && payDate >= today) {
                upcoming.push({
                  ticker: ticker,
                  name: d["name"] || "",
                  ex_div_date: exDiv,
                  pay_date: payDate,
                  dividend_per_share: d["dividend_per_share"],
                  shares_at_exdiv: d["shares_at_exdiv"],
                  total_dividend: total,
                  frequency: d["frequency"],
                  status: autoStatus
                });
              }

              if (payDate) {
                const month = payDate.substring(0, 7);
                monthlyTotals[month] = (monthlyTotals[month] || 0) + total;
              }

              yearlyTotal += total;
            }

            upcoming.sort((a, b) => a.pay_date.localeCompare(b.pay_date));
            nextFive.push(...upcoming.slice(0, 5));

            aurora.isa.dividends = {
              last_updated: now,
              upcoming,
              next_five: nextFive,
              monthly_totals: monthlyTotals,
              annual_total: yearlyTotal
            };
          }

          // -----------------------------------------------------
          // Run updates
          // -----------------------------------------------------
          (async () => {
            await updateHoldings();
            processDividends();
            fs.writeFileSync(auroraPath, JSON.stringify(aurora, null, 2));
          })();
          EOF

      # =====================================================
      # STEP 6 â€” Commit & Push
      # =====================================================
      - name: ðŸ“¤ Commit changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add AuroraSync.json
          git commit -m "ðŸ”„ Auto ISA update: prices + dividends $(date)" || echo "No changes"
          git push
