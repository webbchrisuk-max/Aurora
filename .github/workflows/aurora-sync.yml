name: Aurora ISA â€“ Live Price Sync (Watchlist Powered)

on:
  schedule:
    - cron: "*/10 8-16 * * 1-5"
  workflow_dispatch:

concurrency:
  group: aurora-isa-sync
  cancel-in-progress: false

jobs:
  isa_live_update:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repo
        uses: actions/checkout@v4

      # ==============================================
      # 1) FETCH HOLDINGS SHEET
      # ==============================================
      - name: ðŸŸ¢ Fetch Holdings sheet
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" \
            -o holdings.json

      # ==============================================
      # 2) FETCH WATCHLIST MASTER JSON
      # ==============================================
      - name: ðŸ”µ Fetch Watchlist Master JSON
        run: |
          curl -s \
            "https://webbchrisuk-max.github.io/watchlist_master.json" \
            -o watchlist_master.json

      # ==============================================
      # 3) APPLY PRICES INTO AURORASYNC.JSON
      # ==============================================
      - name: ðŸ”§ Apply Prices to ISA
        run: |
          node << 'EOF'
          const fs = require("fs");

          const auroraPath = "AuroraSync.json";
          const holdingsRaw = JSON.parse(fs.readFileSync("holdings.json", "utf8"));
          const watchlist = JSON.parse(fs.readFileSync("watchlist_master.json", "utf8"));
          const aurora = JSON.parse(fs.readFileSync(auroraPath, "utf8"));

          // FIND LIVE PRICE FROM MASTER
          function getPrice(ticker) {
            const w = watchlist.find(x => x.ticker?.toUpperCase() === ticker?.toUpperCase());
            if (!w) return 0;
            return Number(w.liveprice || 0);   // <-- correct field
          }

          aurora.isa = aurora.isa || {};
          aurora.isa.holdings = { ig_isa: [], trade212_isa: [] };

          holdingsRaw.forEach(row => {
            const live = getPrice(row["ticker"]);
            const shares = Number(row["shares"] || 0);
            const book = Number(row["book_cost"] || 0);

            const value = shares * live;
            const gain = value - book;
            const gainPct = book > 0 ? (gain / book * 100) : 0;

            const obj = {
              ticker: row["ticker"],
              name: row["name"],
              shares,
              book_cost: book,
              live_price: live,
              value,
              gain_value: gain,
              gain_percentage: gainPct,
              annual_dividend_per_share: Number(row["annual_dividend_per_share"] || 0),
              annual_div_yield: live > 0 ? (row["annual_dividend_per_share"] / live * 100) : 0,
              annual_income: shares * Number(row["annual_dividend_per_share"] || 0),
              sector: row["sector"],
              last_updated: new Date().toISOString().replace("T"," ").substring(0,19)
            };

            if (row["account"] === "IG ISA") aurora.isa.holdings.ig_isa.push(obj);
            if (row["account"] === "TRADE212") aurora.isa.holdings.trade212_isa.push(obj);
          });

          fs.writeFileSync(auroraPath, JSON.stringify(aurora, null, 2));
          EOF

      # ==============================================
      # 4) COMMIT & PUSH
      # ==============================================
      - name: ðŸ“¤ Commit and Push
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "Aurora Automation"

          git add .
          git commit -m "ðŸ”„ ISA Updated with Live Prices (Watchlist Master Powered)" || echo "No changes to commit"

          git pull --rebase --autostash
          git push
