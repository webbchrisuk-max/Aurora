name: Aurora ISA â€“ 5-Minute Live Shares + Dividends Sync

on:
  schedule:
    - cron: "*/5 8-16 * * 1-5"     # Every 5 mins during LSE market hours
    - cron: "30 16 * * 1-5"        # Safety run after close
  workflow_dispatch:

concurrency:
  group: aurora-isa-sync
  cancel-in-progress: false

jobs:
  isa_sync:
    runs-on: ubuntu-latest

    steps:
      # =====================================================
      # STEP 1 â€” Checkout repo
      # =====================================================
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =====================================================
      # STEP 2 â€” Fetch Holdings sheet
      # =====================================================
      - name: ðŸŸ¢ Fetch Holdings sheet
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" \
            -o holdings.json

      # =====================================================
      # STEP 3 â€” Fetch Dividends sheet
      # =====================================================
      - name: ðŸŸ£ Fetch Dividends sheet
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" \
            -o dividends.json

      # =====================================================
      # STEP 4 â€” Install Node.js
      # =====================================================
      - name: ðŸ”§ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # =====================================================
      # STEP 5 â€” FIX: Install node-fetch for Yahoo requests
      # =====================================================
      - name: ðŸ“¦ Install node-fetch
        run: npm install node-fetch@2

      # =====================================================
      # STEP 6 â€” SAFE UPDATE of ISA section using API prices
      # =====================================================
      - name: ðŸ”„ Update ISA Data Safely (API prices)
        run: |
          node << 'EOF'
          const fs = require("fs");
          const fetch = require("node-fetch");   // â­ REQUIRED FIX â­

          const auroraPath = "AuroraSync.json";
          const round = (v, dp = 2) => Number(v.toFixed(dp));

          // Convert ticker to Yahoo format
          const toYahoo = (t) => {
            if (!t) return null;
            t = String(t).trim();
            if (t.includes(":")) t = t.split(":").pop();
            if (/\.[A-Za-z]+$/.test(t)) return t;
            return t + ".L";
          };

          async function getPrices(symbols) {
            const uniq = [...new Set(symbols)].filter(Boolean);
            const priceMap = {};
            const chunk = 40;

            for (let i = 0; i < uniq.length; i += chunk) {
              const slice = uniq.slice(i, i + chunk);
              const url = "https://query1.finance.yahoo.com/v7/finance/quote?symbols=" +
                          encodeURIComponent(slice.join(","));
              const res = await fetch(url).catch(() => null);
              if (!res) continue;
              const json = await res.json().catch(() => null);
              const rows = json?.quoteResponse?.result || [];
              rows.forEach(r => {
                if (r.symbol && typeof r.regularMarketPrice === "number") {
                  priceMap[r.symbol] = r.regularMarketPrice;
                }
              });
            }

            return priceMap;
          }

          (async () => {
            const aurora = JSON.parse(fs.readFileSync(auroraPath, "utf8"));
            const holdings = JSON.parse(fs.readFileSync("holdings.json", "utf8"));
            const dividendsSheet = JSON.parse(fs.readFileSync("dividends.json", "utf8"));
            const now = new Date().toISOString().replace("T"," ").substring(0,19);

            const symbols = holdings.map(r => toYahoo(r["ticker"]));
            const priceMap = await getPrices(symbols);

            if (!aurora.isa) aurora.isa = {};
            aurora.isa.holdings = { ig_isa: [], trade212_isa: [] };

            holdings.forEach(row => {
              const ticker = row["ticker"];
              const y = toYahoo(ticker);
              const price = priceMap[y] || 0;

              const shares = Number(row["shares"]);
              const cost   = Number(row["book_cost"]);

              const dps    = Number(row["annual_dividend_per_share"] || 0);
              const value  = shares * price;
              const gain   = value - cost;

              const item = {
                ticker,
                name: row["name"],
                shares,
                book_cost: round(cost,2),
                live_price: round(price,4),
                value: round(value,3),
                gain_value: round(gain,3),
                gain_percentage: cost ? round((gain/cost)*100,2) : 0,
                annual_dividend_per_share: round(dps,4),
                annual_div_yield: price ? round((dps/price)*100,2) : 0,
                annual_income: round(dps * shares,2),
                sector: row["sector"],
                last_updated: now
              };

              if (row["account"] === "IG ISA") aurora.isa.holdings.ig_isa.push(item);
              if (row["account"] === "TRADE212") aurora.isa.holdings.trade212_isa.push(item);
            });

            // ----- Portfolio summaries -----
            const ig = aurora.isa.holdings.ig_isa;
            const t2 = aurora.isa.holdings.trade212_isa;

            const sum = (arr,f) => arr.reduce((s,h)=>s + (h[f]||0), 0);

            const igValue = sum(ig,"value");
            const igCost  = sum(ig,"book_cost");
            const igGain  = igValue - igCost;
            const igInc   = sum(ig,"annual_income");

            const tValue = sum(t2,"value");
            const tCost  = sum(t2,"book_cost");
            const tGain  = tValue - tCost;
            const tInc   = sum(t2,"annual_income");

            aurora.isa.ig_isa = {
              balance: round(igValue,4),
              unrealised_gain: round(igGain,4),
              gain_percent: igCost ? round((igGain/igCost)*100,6) : 0,
              annual_income: round(igInc,4)
            };

            aurora.isa.trade212_isa = {
              balance: round(tValue,4),
              unrealised_gain: round(tGain,4),
              gain_percent: tCost ? round((tGain/tCost)*100,6) : 0,
              annual_income: round(tInc,4)
            };

            aurora.isa.portfolio_summary = {
              total_value: round(igValue + tValue,4),
              annual_income_gbp: round(igInc + tInc,3),
              dividend_yield: (igValue+tValue) ?
                round(((igInc+tInc)/(igValue+tValue))*100,6) : 0
            };

            // ----- Dividends -----
            const today = new Date().toISOString().split("T")[0];
            const monthly = {};
            const upcoming = [];

            dividendsSheet.forEach(d => {
              const pay = d["pay_date"];
              const total = Number(d["total_dividend"] || 0);
              if (pay) {
                const m = pay.substring(0,7);
                monthly[m] = (monthly[m]||0) + total;
              }
              if (pay >= today) upcoming.push(d);
            });

            upcoming.sort((a,b)=>a.pay_date.localeCompare(b.pay_date));

            aurora.isa.dividends = {
              last_updated: now,
              upcoming,
              next_five: upcoming.slice(0,5),
              monthly_totals: monthly,
              annual_total: monthly
            };

            if (!aurora.meta) aurora.meta = {};
            aurora.meta.last_updated = now;
            aurora.meta.source = "Aurora ISA â€“ API Live Prices + Dividends";

            fs.writeFileSync(auroraPath, JSON.stringify(aurora, null, 2));
          })();
          EOF

      # =====================================================
      # STEP 7 â€” Pull latest to avoid conflicts
      # =====================================================
      - name: ðŸ“¥ Pull latest
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "Aurora Automation"
          git pull --rebase origin main || true

      # =====================================================
      # STEP 8 â€” Commit & Push
      # =====================================================
      - name: ðŸ“¤ Commit and push
        run: |
          git add AuroraSync.json
          git commit -m "ðŸ”„ ISA API Sync â€“ FIXED Yahoo fetch + updated values" || true
          git push origin main || true