name: ðŸª„ Aurora Data Sync (ISA Only)

on:
  schedule:
    # Every 10 minutes during UK market hours (Monâ€“Fri)
    - cron: "*/10 8-16 * * 1-5"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§° Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Install jq
        run: sudo apt-get install -y jq

      # =====================================================
      # STEP 1 â€” Fetch ISA data (Holdings + Dividends)
      # =====================================================
      - name: ðŸŒ Fetch ISA Sheets
        run: |
          curl -L "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" -o holdings.json
          curl -L "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" -o dividends.json
          echo "âœ… ISA sheets pulled."

      # =====================================================
      # STEP 2 â€” Build ISA block ONLY
      # =====================================================
      - name: ðŸ§© Build ISA block
        run: |
          jq -s '
          {
            isa: {
              holdings: (.[0]),
              dividends: (.[1])
            }
          }
          ' holdings.json dividends.json > isa_block.json

          echo "âœ… ISA block built."

      # =====================================================
      # STEP 3 â€” Load current AuroraSync.json
      # =====================================================
      - name: ðŸ“¥ Load existing AuroraSync.json
        run: |
          curl -L "https://raw.githubusercontent.com/webbchrisuk-max/Aurora/refs/heads/main/AuroraSync.json" -o AuroraSync_master.json
          echo "ðŸ“¥ Loaded existing AuroraSync.json."

      # =====================================================
      # STEP 4 â€” Merge new ISA data into AuroraSync.json
      #          WITHOUT touching monzo, reits_outlook, etc.
      # =====================================================
      - name: ðŸ”„ Merge ISA â†’ AuroraSync
        run: |
          jq -s '
            .[1].isa as $newISA |
            .[0] * { isa: $newISA }
          ' AuroraSync_master.json isa_block.json > AuroraSync.json

          echo "âœ… ISA data merged safely."

      # =====================================================
      # STEP 5 â€” Validate JSON
      # =====================================================
      - name: ðŸ§¾ Validate JSON
        run: |
          jq empty AuroraSync.json
          echo "âœ… JSON is valid."

      # =====================================================
      # STEP 6 â€” Commit updates
      # =====================================================
      - name: ðŸš€ Commit & Push
        run: |
          git config user.name "AuroraSync Bot"
          git config user.email "actions@github.com"
          git add AuroraSync.json
          git commit -m "ðŸ”„ ISA Sync (10-minute market update)" || echo "No changes to commit"
          git pull --no-rebase
          git push origin main
          echo "ðŸš€ Sync complete."
