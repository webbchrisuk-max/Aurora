name: Aurora ISA â€“ 5-Minute Sync (Watchlist Live Prices)

on:
  schedule:
    - cron: "*/5 8-16 * * 1-5"
    - cron: "30 16 * * 1-5"
  workflow_dispatch:

concurrency:
  group: aurora-isa-sync
  cancel-in-progress: false

jobs:
  isa_sync:
    runs-on: ubuntu-latest

    steps:
      # STEP 1 â€” Checkout repo
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # STEP 2 â€” Fetch Holdings sheet
      - name: ðŸŸ¢ Fetch Holdings sheet
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" \
            -o holdings.json

      # STEP 3 â€” Fetch Dividends sheet
      - name: ðŸŸ£ Fetch Dividends sheet
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" \
            -o dividends.json

      # STEP 4 â€” Fetch Watchlist sheet
      - name: ðŸ”µ Fetch Watchlist sheet
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Watchlist" \
            -o watchlist.json

      # STEP 5 â€” Install Node
      - name: ðŸ”§ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # STEP 6 â€” Build ISA using Watchlist live prices
      - name: ðŸ”„ Update ISA Data (Watchlist Prices)
        run: |
          node << 'EOF'
          const fs = require("fs");
          const auroraPath = "AuroraSync.json";

          // Load existing full JSON
          const aurora = JSON.parse(fs.readFileSync(auroraPath,"utf8"));

          // Load sheets
          const holdings = JSON.parse(fs.readFileSync("holdings.json","utf8"));
          const dividendsSheet = JSON.parse(fs.readFileSync("dividends.json","utf8"));
          const watchlist = JSON.parse(fs.readFileSync("watchlist.json","utf8"));

          // Convert watchlist into ticker â†’ price map
          const priceMap = {};
          watchlist.forEach(row => {
            const t = String(row["ticker"] || row["Ticker"] || "").trim();
            const p = Number(row["live_price"] || row["Live Price"] || 0);
            if (t) priceMap[t] = p;
          });

          const now = new Date().toISOString().replace("T"," ").substring(0,19);

          // Prepare ISA structure
          aurora.isa.holdings = { ig_isa: [], trade212_isa: [] };

          const round = (v,dp=2)=>Number(Number(v).toFixed(dp));

          holdings.forEach(row => {
            const ticker = String(row["ticker"] || "").trim();
            const account = row["account"] || "";

            // Live price from WATCHLIST sheet
            const live = Number(priceMap[ticker] || 0);

            const shares = Number(row["shares"] || 0);
            const book = Number(row["book_cost"] || 0);

            const value = shares * live;
            const gain = value - book;
            const gainPct = book ? (gain/book)*100 : 0;

            const dps = Number(row["annual_dividend_per_share"] || 0);
            const annualIncome = shares * dps;
            const yieldPct = live ? (dps/live)*100 : 0;

            const item = {
              ticker,
              name: row["name"],
              shares,
              book_cost: book,
              live_price: round(live,4),
              value: round(value,3),
              gain_value: round(gain,3),
              gain_percentage: round(gainPct,2),
              annual_dividend_per_share: dps,
              annual_div_yield: round(yieldPct,2),
              annual_income: round(annualIncome,2),
              sector: row["sector"],
              last_updated: now
            };

            if (account === "IG ISA") aurora.isa.holdings.ig_isa.push(item);
            if (account === "TRADE212") aurora.isa.holdings.trade212_isa.push(item);
          });

          // ISA totals
          const sum = (arr,f)=>arr.reduce((s,h)=>s+(h[f]||0),0);

          const ig = aurora.isa.holdings.ig_isa;
          const t2 = aurora.isa.holdings.trade212_isa;

          const igValue = sum(ig,"value");
          const igBook = sum(ig,"book_cost");
          const igGain = igValue - igBook;

          const t2Value = sum(t2,"value");
          const t2Book = sum(t2,"book_cost");
          const t2Gain = t2Value - t2Book;

          aurora.isa.ig_isa = {
            balance: round(igValue,4),
            unrealised_gain: round(igGain,4),
            gain_percent: igBook ? round((igGain/igBook)*100,6) : 0,
            annual_income: round(sum(ig,"annual_income"),4)
          };

          aurora.isa.trade212_isa = {
            balance: round(t2Value,4),
            unrealised_gain: round(t2Gain,4),
            gain_percent: t2Book ? round((t2Gain/t2Book)*100,6) : 0,
            annual_income: round(sum(t2,"annual_income"),4)
          };

          // Portfolio summary
          const totalValue = igValue + t2Value;
          const totalIncome = sum(ig,"annual_income") + sum(t2,"annual_income");
          const divYield = totalValue ? (totalIncome/totalValue)*100 : 0;

          aurora.isa.portfolio_summary = {
            total_value: round(totalValue,4),
            annual_income_gbp: round(totalIncome,3),
            dividend_yield: round(divYield,6)
          };

          // Save back
          fs.writeFileSync(auroraPath, JSON.stringify(aurora,null,2));

          EOF

      # STEP 7 â€” Commit & push
      - name: ðŸ“¤ Commit and push
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "Aurora Automation"
          git add AuroraSync.json
          git commit -m "ðŸ”„ ISA Sync Updated (Watchlist Live Prices)" || true
          git push origin main || true