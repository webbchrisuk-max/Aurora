name: ğŸª„ Aurora Data Sync

on:
  schedule:
    - cron: "0 8 * * *"   # â° Runs daily at 08:00 UTC
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§° Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install jq for JSON merging
        run: sudo apt-get install -y jq

      - name: ğŸŒ Fetch data from Google Sheets
        run: |
          echo "Fetching Google Sheets data..."
          curl -L "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" -o holdings.json
          curl -L "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" -o dividends.json
          curl -L "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/DirectDebits" -o directdebits.json
          curl -L "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transfers" -o transfers.json
          echo "âœ… Sheets pulled successfully."

      - name: ğŸ§© Build AuroraSync.json
        run: |
         echo "Building AuroraSync.json..."
         jq -s '
         {
          isa: {
            holdings: (.[0]),
            dividends: (.[1])
         },
         monzo: {},
         direct_debits: (.[2]),
         transfers: (.[3]),
         meta: {
            last_updated: now | todate,
            source: "Google Sheets + Monzo Merge"
          }
         }
         ' holdings.json dividends.json directdebits.json transfers.json > AuroraSync.json
    
          echo "âœ… Base AuroraSync.json created."
      - name: ğŸ”„ Merge Monzo JSON into AuroraSync
        run: |
          echo "Merging AuroraMonzo.json â†’ AuroraSync.json..."
          MONZO_URL="https://raw.githubusercontent.com/webbchrisuk-max/Aurora/refs/heads/main/AuroraMonzo.json"
          curl -L "$MONZO_URL" -o AuroraMonzo.json

          # Merge "monzo" section from AuroraMonzo.json into AuroraSync.json
          jq '.monzo = (input.monzo)' AuroraSync.json AuroraMonzo.json > temp.json && mv temp.json AuroraSync.json

          echo "âœ… AuroraMonzo.json merged successfully into AuroraSync.json."

      - name: ğŸ§¾ Validate final JSON
        run: |
          jq empty AuroraSync.json
          echo "âœ… AuroraSync.json validated successfully."

      - name: ğŸš€ Commit and push changes
        run: |
          git config user.name "AuroraSync Bot"
          git config user.email "actions@github.com"
          git pull --rebase
          git add AuroraSync.json
          git commit -m "ğŸ” Auto-update: Full Aurora Data Sync with Monzo merge" || echo "No changes to commit."
          git push

          echo "âœ… AuroraSync.json updated and pushed to GitHub successfully."
