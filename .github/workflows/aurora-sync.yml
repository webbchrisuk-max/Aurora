name: Aurora ISA ‚Äì 5-Minute Live Shares + Dividends Sync

on:
  schedule:
    - cron: "*/5 8-16 * * 1-5"
    - cron: "30 16 * * 1-5"
  workflow_dispatch:

concurrency:
  group: aurora-isa-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------
      # CHECKOUT
      # -----------------------------------------
      - name: üß© Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------------------
      # FETCH SHEETS (Holdings, Dividends, Watchlist)
      # -----------------------------------------
      - name: üü¢ Fetch Holdings
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" \
            -o holdings.json

      - name: üü£ Fetch Dividends
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" \
            -o dividends.json

      - name: üîµ Fetch Watchlist (LIVE PRICES)
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Watchlist" \
            -o watchlist.json

      # -----------------------------------------
      # NODE
      # -----------------------------------------
      - name: üîß Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -----------------------------------------
      # UPDATE JSON
      # -----------------------------------------
      - name: üîÑ Update ISA JSON Safely
        run: |
          node << 'EOF'
          const fs = require("fs");

          const auroraPath = "AuroraSync.json";
          const aurora = JSON.parse(fs.readFileSync(auroraPath, "utf8"));
          const holdings = JSON.parse(fs.readFileSync("holdings.json", "utf8"));
          const dividends = JSON.parse(fs.readFileSync("dividends.json", "utf8"));
          const watchlist = JSON.parse(fs.readFileSync("watchlist.json", "utf8"));

          const now = new Date().toISOString().replace("T"," ").substring(0,19);

          // -----------------------------------------
          // BUILD WATCHLIST MAP
          // -----------------------------------------
          const priceMap = {};
          watchlist.forEach(w => {
            const t = (w["ticker"] || "").trim();
            const p = Number(w["live_price"] || 0);
            if (t) priceMap[t] = p;
          });

          // -----------------------------------------
          // PREPARE HOLDINGS
          // -----------------------------------------
          aurora.isa = aurora.isa || {};
          aurora.isa.holdings = { ig_isa: [], trade212_isa: [] };

          function round(n, d=2){ return Number(Number(n).toFixed(d)); }

          holdings.forEach(row => {
            const ticker = (row["ticker"] || "").trim();
            const live_price = priceMap[ticker] || 0;

            const shares = Number(row["shares"]);
            const value = shares * live_price;
            const book = Number(row["book_cost"]);
            const gain = value - book;
            const gainPct = book ? (gain / book * 100) : 0;

            const dps = Number(row["annual_dividend_per_share"] || 0);
            const annualIncome = dps * shares;
            const annualYield = live_price ? (dps / live_price * 100) : 0;

            const item = {
              ticker,
              name: row["name"],
              shares,
              book_cost: round(book),
              live_price: round(live_price, 4),
              value: round(value, 3),
              gain_value: round(gain, 3),
              gain_percentage: round(gainPct, 2),
              annual_dividend_per_share: round(dps, 4),
              annual_div_yield: round(annualYield, 2),
              annual_income: round(annualIncome, 2),
              sector: row["sector"],
              last_updated: now
            };

            if (row["account"] === "IG ISA") {
              aurora.isa.holdings.ig_isa.push(item);
            }
            if (row["account"] === "TRADE212") {
              aurora.isa.holdings.trade212_isa.push(item);
            }
          });

          // -----------------------------------------
          // ISA SUMMARY
          // -----------------------------------------
          function sum(arr, field){ return arr.reduce((s,h)=>s + Number(h[field] || 0), 0); }

          const ig = aurora.isa.holdings.ig_isa;
          const t2 = aurora.isa.holdings.trade212_isa;

          const igVal = sum(ig,"value");
          const igBook = sum(ig,"book_cost");
          const igInc = sum(ig,"annual_income");

          const tVal = sum(t2,"value");
          const tBook = sum(t2,"book_cost");
          const tInc = sum(t2,"annual_income");

          aurora.isa.ig_isa = {
            balance: round(igVal,4),
            unrealised_gain: round(igVal - igBook,4),
            gain_percent: round(igBook ? ( (igVal-igBook)/igBook*100 ) : 0 ,4),
            annual_income: round(igInc,4)
          };

          aurora.isa.trade212_isa = {
            balance: round(tVal,4),
            unrealised_gain: round(tVal - tBook,4),
            gain_percent: round(tBook ? ( (tVal-tBook)/tBook*100 ) : 0 ,4),
            annual_income: round(tInc,4)
          };

          aurora.isa.portfolio_summary = {
            total_value: round(igVal + tVal, 4),
            annual_income_gbp: round(igInc + tInc, 4),
            dividend_yield: round((igInc + tInc)/(igVal + tVal) * 100 || 0, 4)
          };

          // -----------------------------------------
          // DIVIDENDS (same as before)
          // -----------------------------------------
          const today = new Date().toISOString().split("T")[0];
          const monthlyTotals = {};
          const upcoming = [];
          let annualTotal = 0;

          dividends.forEach(d => {
            const pay = d["pay_date"];
            const total = Number(d["total_dividend"] || 0);

            if (pay) {
              const month = pay.substring(0,7);
              monthlyTotals[month] = (monthlyTotals[month] || 0) + total;
            }

            if (pay && pay >= today) upcoming.push(d);
            annualTotal += total;
          });

          upcoming.sort((a,b)=>a.pay_date.localeCompare(b.pay_date));

          aurora.isa.dividends = {
            last_updated: now,
            upcoming,
            next_five: upcoming.slice(0,5),
            monthly_totals: monthlyTotals,
            annual_total: annualTotal
          };

          // -----------------------------------------
          // SAVE
          // -----------------------------------------
          fs.writeFileSync(auroraPath, JSON.stringify(aurora, null, 2));
          console.log("‚úì AuroraSync.json updated using WATCHLIST live prices.");
          EOF

      # -----------------------------------------
      # COMMIT
      # -----------------------------------------
      - name: üì§ Commit & Push
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "Aurora Automation"
          git add AuroraSync.json
          git commit -m "‚≠ê Updated ISA using Watchlist live prices" || true
          git push origin main || true