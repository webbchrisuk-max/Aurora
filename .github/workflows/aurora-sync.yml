name: Aurora ISA â€“ 5-Minute Live Shares Sync

on:
  schedule:
    # Every 5 minutes between 08:00â€“16:30 UK time (Nov = UTC)
    - cron: "*/5 8-16 * * 1-5"
    # Also run at 16:30 exactly
    - cron: "30 16 * * 1-5"
  workflow_dispatch:

concurrency:
  group: aurora-isa-sync
  cancel-in-progress: false

jobs:
  isa_sync:
    runs-on: ubuntu-latest

    steps:
      # =====================================================
      # STEP 1 â€” Checkout repo
      # =====================================================
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # =====================================================
      # STEP 2 â€” Fetch Holdings sheet
      # =====================================================
      - name: ðŸŸ¢ Fetch Holdings sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" -o holdings.json

      # =====================================================
      # STEP 3 â€” Install Node
      # =====================================================
      - name: ðŸ”§ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # =====================================================
      # STEP 4 â€” Update AuroraSync.json with new prices
      # =====================================================
      - name: ðŸ”„ Update ISA prices
        run: |
          node << 'EOF'
          const fs = require("fs");

          // Load Google Sheet holdings
          const holdings = JSON.parse(fs.readFileSync("holdings.json", "utf8"));

          // Load AuroraSync.json
          const auroraPath = "AuroraSync.json";
          const aurora = JSON.parse(fs.readFileSync(auroraPath, "utf8"));

          // Prepare date/time for last_updated field
          const now = new Date().toISOString().replace("T", " ").substring(0, 19);

          // Function to fetch live price
          async function getLivePrice(ticker) {
            try {
              const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${ticker}.L`;
              const res = await fetch(url);
              const data = await res.json();

              return data.quoteResponse.result[0]?.regularMarketPrice ?? null;
            } catch {
              return null;
            }
          }

          // Wrapper for async/await
          async function update() {
            for (const row of holdings) {
              const ticker = row["ticker"];
              const shares = parseFloat(row["shares"] || 0);
              const book = parseFloat(row["book cost"] || 0);

              // Fetch price
              const price = await getLivePrice(ticker.replace("LON:", ""));
              if (!price) continue;

              const value = price * shares;
              const gain = value - book;

              // Update AuroraSync JSON
              aurora.isa = aurora.isa || {};
              aurora.isa.holdings = aurora.isa.holdings || {};
              aurora.isa.holdings[ticker] = {
                name: row["name"] || "",
                shares,
                book_cost: book,
                live_price: price,
                value,
                gain_value: gain,
                gain_percent: book > 0 ? (gain / book) * 100 : 0,
                annual_dividend_per_share: parseFloat(row["annual_dividend_per_share"] || 0),
                annual_income: parseFloat(row["annual_income"] || 0),
                sector: row["sector"] || "",
                last_updated: now
              };
            }

            // Write updated file
            fs.writeFileSync(auroraPath, JSON.stringify(aurora, null, 2));
          }

          await update();
          EOF

      # =====================================================
      # STEP 5 â€” Commit & Push
      # =====================================================
      - name: ðŸ“¤ Commit changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add AuroraSync.json
          git commit -m "ðŸ”„ ISA Auto-Price Update $(date)" || echo "No changes"
          git push