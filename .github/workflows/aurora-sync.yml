name: Aurora ISA â€“ 5-Minute Live Shares + Dividends Sync

on:
  schedule:
    - cron: "*/5 8-16 * * 1-5"     # Every 5 minutes during UK market hours
    - cron: "30 16 * * 1-5"        # Final run at 16:30
  workflow_dispatch:

concurrency:
  group: aurora-isa-sync
  cancel-in-progress: false

jobs:
  isa_sync:
    runs-on: ubuntu-latest

    steps:
      # ============================
      # STEP 1 â€” Checkout repo
      # ============================
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      # ============================
      # STEP 2 â€” Fetch Holdings sheet
      # ============================
      - name: ðŸŸ¢ Fetch Holdings sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" -o holdings.json

      # ============================
      # STEP 3 â€” Fetch Dividends sheet
      # ============================
      - name: ðŸŸ£ Fetch Dividends sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" -o dividends.json

      # ============================
      # STEP 4 â€” Setup Node
      # ============================
      - name: ðŸ”§ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ============================
      # STEP 5 â€” Update ISA JSON
      # ============================
      - name: ðŸ”„ Update ISA prices + dividends + summaries
        run: |
          node << 'EOF'
          const fs = require("fs");

          const holdings = JSON.parse(fs.readFileSync("holdings.json", "utf8"));
          const dividendsSheet = JSON.parse(fs.readFileSync("dividends.json", "utf8"));

          const auroraPath = "AuroraSync.json";
          const aurora = JSON.parse(fs.readFileSync(auroraPath, "utf8"));

          aurora.isa = aurora.isa || {};
          aurora.isa.holdings = aurora.isa.holdings || { ig_isa: [], trade212_isa: [] };
          aurora.isa.dividends = aurora.isa.dividends || {};
          aurora.isa.portfolio_summary = aurora.isa.portfolio_summary || {};
          aurora.isa.ig_isa = aurora.isa.ig_isa || {};
          aurora.isa.trade212_isa = aurora.isa.trade212_isa || {};

          const now = new Date().toISOString().replace("T", " ").substring(0, 19);
          const today = new Date().toISOString().split("T")[0];

          // =====================================================
          // SPLIT IG ISA + TRADE212
          // =====================================================
          aurora.isa.holdings.ig_isa = holdings.filter(r => r.account === "IG ISA");
          aurora.isa.holdings.trade212_isa = holdings.filter(r => r.account === "TRADE212");

          // =====================================================
          // DIVIDEND PROCESSING
          // =====================================================
          let upcoming_exdiv = [];
          let upcoming_pay = [];
          let monthlyTotals = {};
          let annualTotal = 0;

          for (const d of dividendsSheet) {
            const total = parseFloat(d.total_dividend || 0);
            const exDiv = d.ex_div_date;
            const payDate = d.pay_date;

            annualTotal += total;

            // --- Monthly totals by PAY DATE (for charts)
            if (payDate) {
              const monthKey = payDate.substring(0, 7);
              monthlyTotals[monthKey] = (monthlyTotals[monthKey] || 0) + total;
            }

            // --- UPCOMING (EX-DIV DATE LOGIC)
            if (exDiv && exDiv >= today) {
              upcoming_exdiv.push({
                ticker: d.ticker,
                name: d.name,
                ex_div_date: d.ex_div_date,
                pay_date: d.pay_date,
                dividend_per_share: d.dividend_per_share,
                shares_at_exdiv: d.shares_at_exdiv,
                total_dividend: total,
                frequency: d.frequency,
                status: d.status
              });
            }

            // --- UPCOMING PAYMENTS (NEXT 5 CONFIRMED)
            if (payDate && payDate >= today && d.status === "Confirmed") {
              upcoming_pay.push({
                ticker: d.ticker,
                name: d.name,
                ex_div_date: d.ex_div_date,
                pay_date: d.pay_date,
                dividend_per_share: d.dividend_per_share,
                shares_at_exdiv: d.shares_at_exdiv,
                total_dividend: total,
                frequency: d.frequency,
                status: d.status
              });
            }
          }

          // Sort by date
          upcoming_exdiv.sort((a, b) => a.ex_div_date.localeCompare(b.ex_div_date));
          upcoming_pay.sort((a, b) => a.pay_date.localeCompare(b.pay_date));

          // Only show 5
          const upcoming5 = upcoming_exdiv.slice(0, 5);
          const next5 = upcoming_pay.slice(0, 5);

          aurora.isa.dividends = {
            last_updated: now,
            upcoming: upcoming5,     // <<< 5 EX-DIV ONLY
            next_five: next5,        // <<< 5 CONFIRMED PAYMENTS ONLY
            monthly_totals: monthlyTotals,
            annual_total: annualTotal
          };

          // =====================================================
          // SUMMARY CALCULATIONS
          // =====================================================
          function summary(rows) {
            const value = rows.reduce((s, r) => s + (parseFloat(r.value) || 0), 0);
            const book = rows.reduce((s, r) => s + (parseFloat(r.book_cost) || 0), 0);
            const gain = rows.reduce((s, r) => s + (parseFloat(r.gain_value) || 0), 0);
            const income = rows.reduce((s, r) => s + (parseFloat(r.annual_income) || 0), 0);

            return {
              balance: value,
              unrealised_gain: gain,
              gain_percent: book > 0 ? (gain / book) * 100 : 0,
              annual_income: income
            };
          }

          const ig = summary(aurora.isa.holdings.ig_isa);
          const t212 = summary(aurora.isa.holdings.trade212_isa);

          aurora.isa.ig_isa = ig;
          aurora.isa.trade212_isa = t212;

          aurora.isa.portfolio_summary = {
            total_value: ig.balance + t212.balance,
            annual_income_gbp: ig.annual_income + t212.annual_income,
            dividend_yield:
              (ig.balance + t212.balance) > 0
                ? ((ig.annual_income + t212.annual_income) / (ig.balance + t212.balance)) * 100
                : 0
          };

          // Write back
          fs.writeFileSync(auroraPath, JSON.stringify(aurora, null, 2));
          EOF

      # ============================
      # STEP 6 â€” Commit Changes
      # ============================
      - name: ðŸ“¤ Commit changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add AuroraSync.json
          git commit -m "ðŸ”„ Auto ISA update (5min sync)" || echo "No changes"
          git push