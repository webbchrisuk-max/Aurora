name: Aurora â€“ ISA Sync

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”¹ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ”¹ Fetch Holdings sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" -o holdings.json

      - name: ðŸ”¹ Fetch Watchlist sheet
        run: |
          curl -s "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Watchlist" -o watchlist.json

      - name: ðŸ”¹ Load & Merge Watchlist into AuroraSync
        run: |
          node << 'EOF'
          const fs = require("fs");

          const aurora = JSON.parse(fs.readFileSync("AuroraSync.json", "utf8"));
          const holdings = JSON.parse(fs.readFileSync("holdings.json", "utf8"));
          const watch = JSON.parse(fs.readFileSync("watchlist.json", "utf8"));

          function cleanTicker(t){
            return String(t || "")
              .replace("LON:", "")
              .replace("Â£", "")
              .trim();
          }

          // Build watchlist lookup for fast matching
          const watchMap = {};
          watch.forEach(row => {
            const t = cleanTicker(row.ticker);
            watchMap[t] = {
              live_price: Number(row.live_price || 0)
            };
          });

          function updateSection(arr){
            arr.forEach(h => {
              const t = cleanTicker(h.ticker);
              if(watchMap[t]){
                const live = watchMap[t].live_price;
                h.live_price = live;
                h.value = Number(h.shares) * live;
                h.gain_value = h.value - Number(h.book_cost);
                h.gain_percentage = h.book_cost > 0 ? (h.gain_value / h.book_cost) * 100 : 0;
              }
            });
          }

          updateSection(aurora.isa.holdings.ig_isa);
          updateSection(aurora.isa.holdings.trade212_isa);

          // update summary
          const igValue = aurora.isa.holdings.ig_isa.reduce((s,h)=>s + (h.value||0),0);
          const t212Value = aurora.isa.holdings.trade212_isa.reduce((s,h)=>s + (h.value||0),0);

          aurora.isa.portfolio_summary.total_value = igValue + t212Value;
          aurora.isa.ig_isa.balance = igValue;
          aurora.isa.trade212_isa.balance = t212Value;

          fs.writeFileSync("AuroraSync.json", JSON.stringify(aurora, null, 2));
          EOF

      - name: ðŸ”¹ Commit changes
        continue-on-error: true
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "Aurora Bot"
          git add AuroraSync.json watchlist.json holdings.json
          git commit -m "Auto-update: Live prices synced from Watchlist" || true
          git push