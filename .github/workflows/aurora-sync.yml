name: ðŸª„ Aurora Data Sync (Enhanced ISA)

on:
  schedule:
    # Every 10 minutes during UK market hours (Monâ€“Fri)
    - cron: "*/10 8-16 * * 1-5"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§° Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Install jq
        run: sudo apt-get install -y jq

      # =====================================================
      # STEP 1 â€” Fetch Sheets (Holdings + Dividends)
      # =====================================================
      - name: ðŸŒ Fetch ISA Sheets
        run: |
          curl -L "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" -o holdings.json
          curl -L "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" -o dividends.json

      # =====================================================
      # STEP 2 â€” Build ISA blocks + calculations
      # =====================================================
      - name: ðŸ§© Build ISA Calculations
        run: |
          # Read the sheet arrays
          HOLD=$(cat holdings.json)
          DIVS=$(cat dividends.json)

          # Calculate total value, yields, income
          TOTAL_VALUE=$(jq '[.[] | .CurrentValue | tonumber] | add' holdings.json)
          ANNUAL_INCOME=$(jq '[.[] | .AnnualIncome | tonumber] | add' dividends.json)
          DIV_YIELD=$(echo "$ANNUAL_INCOME / $TOTAL_VALUE * 100" | bc -l)

          # IG ISA + T212 summaries
          IG_BAL=$(jq '[.[] | select(.Account=="IG") | .CurrentValue | tonumber] | add' holdings.json)
          IG_GAIN=$(jq '[.[] | select(.Account=="IG") | .Gain | tonumber] | add' holdings.json)
          IG_GPCT=$(echo "$IG_GAIN / ($IG_BAL - $IG_GAIN) * 100" | bc -l)

          T212_BAL=$(jq '[.[] | select(.Account=="T212") | .CurrentValue | tonumber] | add' holdings.json)
          T212_GAIN=$(jq '[.[] | select(.Account=="T212") | .Gain | tonumber] | add' holdings.json)
          T212_GPCT=$(echo "$T212_GAIN / ($T212_BAL - $T212_GAIN) * 100" | bc -l)

          # Build portfolio summary
          jq -n --argjson holdings "$HOLD" \
                --argjson dividends "$DIVS" \
                --arg total "$TOTAL_VALUE" \
                --arg income "$ANNUAL_INCOME" \
                --arg dy "$DIV_YIELD" \
                --arg igbal "$IG_BAL" \
                --arg iggain "$IG_GAIN" \
                --arg igpct "$IG_GPCT" \
                --arg tbal "$T212_BAL" \
                --arg tgain "$T212_GAIN" \
                --arg tpct "$T212_GPCT" \
          '
          {
            isa: {
              holdings: $holdings,
              dividends: $dividends,
              portfolio_summary: {
                total_value: ($total|tonumber),
                annual_income_gbp: ($income|tonumber),
                dividend_yield: ($dy|tonumber)
              },
              ig_isa: {
                balance: ($igbal|tonumber),
                unrealised_gain: ($iggain|tonumber),
                gain_percent: ($igpct|tonumber)
              },
              trade212_isa: {
                balance: ($tbal|tonumber),
                unrealised_gain: ($tgain|tonumber),
                gain_percent: ($tpct|tonumber)
              }
            }
          }
          ' > isa_block.json

      # =====================================================
      # STEP 3 â€” Build dividend planner
      # =====================================================
      - name: ðŸ“… Build Dividend Planner
        run: |
          node << 'EOF'
          const fs = require("fs");

          const divs = JSON.parse(fs.readFileSync("dividends.json", "utf8"));

          const planner = {
            schedule_by_holding: {},
            monthly_breakdown: {
              Jan:0,Feb:0,Mar:0,Apr:0,May:0,Jun:0,
              Jul:0,Aug:0,Sep:0,Oct:0,Nov:0,Dec:0
            },
            forecast_total: 0,
            received_ytd: 0
          };

          for(const row of divs){
            const name = row["Ticker"];
            const pay = row["NextPaymentDate"];
            const ex = row["NextExDivDate"];
            const amt = parseFloat(row["AnnualIncome"]||"0");

            if(!planner.schedule_by_holding[name]) planner.schedule_by_holding[name]={};
            planner.schedule_by_holding[name].next_pay_date = pay;
            planner.schedule_by_holding[name].next_ex_div = ex;
            planner.schedule_by_holding[name].expected_dividend = amt;

            planner.forecast_total += amt;

            const month = row["Month"];
            if(planner.monthly_breakdown[month] !== undefined){
              planner.monthly_breakdown[month] += amt;
            }
          }

          fs.writeFileSync("planner_block.json", JSON.stringify({dividend_planner:planner}, null, 2));
          EOF

      # =====================================================
      # STEP 4 â€” Load Master AuroraSync
      # =====================================================
      - name: ðŸ“¥ Load Master AuroraSync.json
        run: |
          curl -L "https://raw.githubusercontent.com/webbchrisuk-max/Aurora/refs/heads/main/AuroraSync.json" -o AuroraSync_master.json

      # =====================================================
      # STEP 5 â€” Merge ESA + Planner safely
      # =====================================================
      - name: ðŸ”„ Merge ISA + Planner
        run: |
          jq -s '
            .[0] as $master
            | .[1].isa as $newISA
            | .[2].dividend_planner as $planner
            | $master
              * { isa: $newISA }
              * { dividend_planner: $planner }
          ' AuroraSync_master.json isa_block.json planner_block.json > AuroraSync.json

      # =====================================================
      # STEP 6 â€” Validate
      # =====================================================
      - name: ðŸ§¾ Validate JSON
        run: jq empty AuroraSync.json

      # =====================================================
      # STEP 7 â€” Commit
      # =====================================================
      - name: ðŸš€ Commit & Push
        run: |
          git config user.name "AuroraSync Bot"
          git config user.email "actions@github.com"
          git add AuroraSync.json
          git commit -m "ðŸ”„ Enhanced ISA Sync (live market update)" || echo "No changes"
          git pull --no-rebase
          git push origin main
