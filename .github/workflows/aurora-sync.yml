name: Aurora ISA â€“ 5-Minute Live Shares + Dividends Sync

on:
  schedule:
    - cron: "*/5 8-16 * * 1-5"
    - cron: "30 16 * * 1-5"
  workflow_dispatch:

concurrency:
  group: aurora-isa-sync
  cancel-in-progress: false

jobs:
  isa_sync:
    runs-on: ubuntu-latest

    steps:
      # =====================================================
      # STEP 1 â€” Checkout repo (fetch-depth 0 required)
      # =====================================================
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =====================================================
      # STEP 2 â€” Fetch Holdings sheet
      # =====================================================
      - name: ðŸŸ¢ Fetch Holdings sheet
        run: curl -s \
          "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" \
          -o holdings.json

      # =====================================================
      # STEP 3 â€” Fetch Dividends sheet
      # =====================================================
      - name: ðŸŸ£ Fetch Dividends sheet
        run: curl -s \
          "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" \
          -o dividends.json

      # =====================================================
      # STEP 4 â€” Install Node.js
      # =====================================================
      - name: ðŸ”§ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # =====================================================
      # STEP 5 â€” SAFE UPDATE of only the ISA section
      # =====================================================
      - name: ðŸ”„ Update ISA Data Safely
        run: |
          node << 'EOF'
          const fs = require("fs");
          const auroraPath = "AuroraSync.json";

          // Load existing JSON fully
          const aurora = JSON.parse(fs.readFileSync(auroraPath, "utf8"));

          // Load sheets
          const holdings = JSON.parse(fs.readFileSync("holdings.json", "utf8"));
          const dividendsSheet = JSON.parse(fs.readFileSync("dividends.json", "utf8"));

          const now = new Date().toISOString().replace("T"," ").substring(0,19);

          // ====================================================
          // CREATE ISA STRUCTURE WITHOUT TOUCHING OTHER SECTIONS
          // ====================================================
          if (!aurora.isa) aurora.isa = {};
          aurora.isa.holdings = { ig_isa: [], trade212_isa: [] };
          aurora.isa.dividends = {};

          // ====================================================
          // Process Holdings
          // ====================================================
          holdings.forEach(row => {
            const item = {
              ticker: row["ticker"],
              name: row["name"],
              shares: Number(row["shares"]),
              book_cost: Number(row["book_cost"]),
              live_price: Number(row["live_price"]),
              value: Number(row["value"]),
              gain_value: Number(row["gain_value"]),
              gain_percentage: Number(row["gain_percentage"]),
              annual_dividend_per_share: Number(row["annual_dividend_per_share"]),
              annual_div_yield: Number(row["annual_div_yield"]),
              annual_income: Number(row["annual_income"]),
              sector: row["sector"],
              last_updated: row["last_updated"]
            };

            if (row["account"] === "IG ISA") {
              aurora.isa.holdings.ig_isa.push(item);
            }
            if (row["account"] === "TRADE212") {
              aurora.isa.holdings.trade212_isa.push(item);
            }
          });

          // ====================================================
          // Process Dividends
          // ====================================================
          const today = new Date().toISOString().split("T")[0];
          const monthlyTotals = {};
          const upcoming = [];
          const nextFive = [];
          let annualTotal = 0;

          dividendsSheet.forEach(d => {
            const pay = d["pay_date"];
            const total = Number(d["total_dividend"] || 0);

            if (pay) {
              const month = pay.substring(0,7);
              monthlyTotals[month] = (monthlyTotals[month] || 0) + total;
            }

            annualTotal += total;

            if (pay && pay >= today) {
              upcoming.push({
                ticker: d["ticker"],
                name: d["name"],
                ex_div_date: d["ex_div_date"],
                pay_date: d["pay_date"],
                dividend_per_share: d["dividend_per_share"],
                shares_at_exdiv: d["shares_at_exdiv"],
                total_dividend: total,
                frequency: d["frequency"],
                status: d["status"]
              });
            }
          });

          // Sort & slice next 5
          upcoming.sort((a,b)=>a.pay_date.localeCompare(b.pay_date));
          nextFive.push(...upcoming.slice(0,5));

          aurora.isa.dividends = {
            last_updated: now,
            upcoming,
            next_five: nextFive,
            monthly_totals: monthlyTotals,
            annual_total: annualTotal
          };

          // SAVE BACK
          fs.writeFileSync(auroraPath, JSON.stringify(aurora, null, 2));
          EOF

      # =====================================================
      # STEP 6 â€” Pull latest main to avoid conflicts
      # =====================================================
      - name: ðŸ“¥ Pull latest
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "Aurora Automation"
          git pull --rebase origin main || true

      # =====================================================
      # STEP 7 â€” Commit & Push
      # =====================================================
      - name: ðŸ“¤ Commit and push
        run: |
          git add AuroraSync.json
          git commit -m "ðŸ”„ Safe ISA Sync â€“ Holdings + Dividends Updated" || true
          git push origin main || true