name: ðŸª„ Aurora Data Sync

on:
  schedule:
    - cron: "0 8 * * *"   # â° Runs daily at 08:00 UTC
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§° Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ðŸ“¦ Install jq for JSON merging
        run: sudo apt-get install -y jq

      - name: ðŸŒ Fetch data from Google Sheets
        run: |
          echo "Fetching Google Sheets data..."
          curl -L "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" -o holdings.json
          curl -L "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" -o dividends.json
          curl -L "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/DirectDebits" -o directdebits.json
          curl -L "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Transfers" -o transfers.json
          echo "âœ… Sheets pulled successfully."

      - name: ðŸ§© Build AuroraSync.json (temporary)
        run: |
          echo "Building temporary AuroraSync.json..."
          jq -s '
          {
            isa: {
              holdings: (.[0]),
              dividends: (.[1])
            },
            monzo: {},
            direct_debits: (.[2]),
            transfers: (.[3]),
            meta: {
              last_updated: now | todate,
              source: "Google Sheets + Monzo Merge"
            }
          }
          ' holdings.json dividends.json directdebits.json transfers.json > AuroraSync_temp.json

          echo "âœ… Temporary AuroraSync.json built."

      - name: ðŸ›¡ï¸ Protect & Merge with Master AuroraSync
        run: |
          echo "ðŸ›¡ï¸ Checking for write-protection..."
          MASTER_URL="https://raw.githubusercontent.com/webbchrisuk-max/Aurora/refs/heads/main/AuroraSync.json"
          curl -L "$MASTER_URL" -o AuroraSync_master.json

          # Backup the master file
          mkdir -p backups
          cp AuroraSync_master.json "backups/AuroraSync_$(date +'%Y%m%d_%H%M%S').json"
          echo "ðŸ“¦ Master backup created."

          # If write protection enabled, preserve protected sections
          if jq -e '.meta.write_protection == true' AuroraSync_master.json > /dev/null; then
            echo "âœ… Write protection active, preserving protected sections..."
            PROTECTED=$(jq -r '.meta.protected_sections[]' AuroraSync_master.json)
            cp AuroraSync_temp.json AuroraSync.json
            for section in $PROTECTED; do
              jq --arg path "$section" \
                 --slurpfile src AuroraSync_master.json \
                 'setpath(($path | split(".")); getpath(($path | split("."))) as $v | $v)' \
                 AuroraSync.json > temp.json && mv temp.json AuroraSync.json
            done
          else
            echo "âš ï¸ No write protection flag detected â€” proceeding with normal merge."
            mv AuroraSync_temp.json AuroraSync.json
          fi

          echo "âœ… Merge completed with protection."

      - name: ðŸ”„ Merge Monzo JSON into AuroraSync
        run: |
          echo "Merging AuroraMonzo.json â†’ AuroraSync.json..."
          MONZO_URL="https://raw.githubusercontent.com/webbchrisuk-max/Aurora/refs/heads/main/AuroraMonzo.json"
          curl -L "$MONZO_URL" -o AuroraMonzo.json
          jq '.monzo = (input.monzo)' AuroraSync.json AuroraMonzo.json > temp.json && mv temp.json AuroraSync.json
          echo "âœ… AuroraMonzo.json merged successfully."

      - name: ðŸ§¾ Validate final JSON
        run: |
          jq empty AuroraSync.json
          echo "âœ… AuroraSync.json validated successfully."

      - name: ðŸš€ Commit and push changes
        run: |
          git config user.name "AuroraSync Bot"
          git config user.email "actions@github.com"
          git add AuroraSync.json
          git commit -m "ðŸ”„ Auto-update: AuroraSync.json refreshed (Protected Merge)" || echo "No changes to commit"
          git fetch origin main
          git pull origin main --no-rebase --strategy-option ours || true
          git push origin main --force
          echo "âœ… AuroraSync.json updated and pushed to GitHub successfully."