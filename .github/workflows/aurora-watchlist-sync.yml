name: Aurora Watchlist â€“ Live Prices Sync

on:
  schedule:
    - cron: "*/15 * * * *"      # every 15 mins
  workflow_dispatch:

jobs:
  sync_watchlist:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout Repo
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Fetch Watchlist Sheet
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Watchlist" \
            -o watchlist_raw.json

      - name: ðŸ”§ Convert + Clean JSON
        run: |
          node << 'EOF'
          const fs = require("fs");

          const raw = JSON.parse(fs.readFileSync("watchlist_raw.json","utf8"));

          // Clean up keys (remove emojis, symbols, etc)
          const clean = raw.map(r => {
            const cleaned = {};
            for (const k of Object.keys(r)) {
              cleaned[k.replace(/[^a-zA-Z0-9 %/]/g,"").trim()] = r[k];
            }
            return cleaned;
          });

          fs.writeFileSync("watchlist.json", JSON.stringify(clean, null, 2));
          EOF

      - name: ðŸ“¤ Commit and Push Safely
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "Aurora Automation"

          git add watchlist.json
          git add watchlist_raw.json

          # prevent exit code 1 on "nothing to commit"
          git commit -m "ðŸ”„ Updated Watchlist JSON (Live Prices)" || true
          git push || true