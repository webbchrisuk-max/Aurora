name: Aurora â€“ Auto Update Direct Debit Dates

on:
  schedule:
    - cron: "0 0 1 * *"   # Run at midnight on the 1st of every month (UTC)
  workflow_dispatch:        # Allow manual trigger from the Actions tab

jobs:
  roll_forward_direct_debits:
    name: Roll Forward Direct Debit Dates
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout Aurora repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ” Update due_date month in AuroraMonzo.json
        run: |
          node <<'EOF'
          const fs = require('fs');
          const file = 'AuroraMonzo.json';
          const data = JSON.parse(fs.readFileSync(file, 'utf8'));

          const dds = data.monzo?.direct_debits || [];
          dds.forEach(dd => {
            try {
              const date = new Date(dd.due_date);
              if (!isNaN(date)) {
                date.setMonth(date.getMonth() + 1);
                // Keep same day if possible, handle overflow (e.g. Jan 31 â†’ Feb 28)
                dd.due_date = date.toISOString().split('T')[0];
              }
            } catch (e) {
              console.error('âš ï¸ Skipped invalid date for', dd.payee);
            }
          });

          // Update checksum to reflect change
          const now = new Date();
          data.monzo.integrity.checksum = `auto-roll-${now.toISOString()}`;
          data.monzo.integrity.verified = true;

          fs.writeFileSync(file, JSON.stringify(data, null, 2));
          console.log('âœ… AuroraMonzo.json updated successfully.');
          EOF

      - name: ğŸ“ Commit and push changes
        run: |
          git config --global user.name "aurora-bot"
          git config --global user.email "aurora@users.noreply.github.com"
          git add AuroraMonzo.json
          git commit -m "ğŸ•’ Auto-roll Monzo direct debit due dates" || echo "No changes to commit"
          git push