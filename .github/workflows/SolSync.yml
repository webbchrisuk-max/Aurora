name: Aurora â€“ Master Live Sync

on:
  schedule:
    - cron: "*/10 8-16 * * 1-5"
  workflow_dispatch:

concurrency:
  group: aurora-master-sync
  cancel-in-progress: false

jobs:
  aurora_master_update:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout Repo
        uses: actions/checkout@v4

      # ==============================================
      # 1) FETCH HOLDINGS SHEET (core data)
      # ==============================================
      - name: ðŸŸ¢ Fetch Holdings Sheet
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" \
            -o holdings.json

      # ==============================================
      # 2) FETCH WATCHLIST MASTER WITH LIVE PRICES
      # ==============================================
      - name: ðŸ”µ Fetch Watchlist Master JSON
        run: |
          curl -s \
            "https://raw.githubusercontent.com/webbchrisuk-max/Aurora/main/watchlist_master.json" \
            -o watchlist_master.json
                  # ==============================================
      # 3) PROCESS + MERGE EVERYTHING INTO AURORASYNC.JSON
      # ==============================================
      - name: ðŸ”§ Build ISA Section from Holdings + Live Prices
        run: |
          node << 'EOF'
          const fs = require("fs");

          const auroraPath = "AuroraSync.json";
          const aurora = JSON.parse(fs.readFileSync(auroraPath, "utf8"));
          const holdings = JSON.parse(fs.readFileSync("holdings.json", "utf8"));
          const master = JSON.parse(fs.readFileSync("watchlist_master.json", "utf8"));

          // -------------------------------
          // FIND LIVE PRICE MATCH in watchlist_master
          // -------------------------------
          function getWatchlistData(ticker) {
            return master.find(
              x => x.ticker?.toUpperCase() === ticker?.toUpperCase()
            );
          }

          // -------------------------------
          // RESET ISA HOLDINGS CLEANLY
          // -------------------------------
          aurora.isa = aurora.isa || {};
          aurora.isa.holdings = { ig_isa: [], trade212_isa: [] };

          // -------------------------------
          // PROCESS EACH HOLDING
          // -------------------------------
          holdings.forEach(row => {
            const tkr = row["ticker"];
            const wl = getWatchlistData(tkr);

            // Live price from watchlist master
            const live = wl ? Number(wl.liveprice || 0) : 0;

            // Core maths
            const shares = Number(row["shares"] || 0);
            const book = Number(row["book_cost"] || 0);
            const dps = Number(row["annual_dividend_per_share"] || row["annual_dps"] || 0);

            const value = shares * live;
            const gain = value - book;
            const gainPct = book > 0 ? (gain / book * 100) : 0;
            const income = shares * dps;
            const yieldPct = live > 0 ? (dps / live * 100) : 0;

            const obj = {
              ticker: tkr,
              name: row["name"],
              shares,
              book_cost: book,
              live_price: live,
              value,
              gain_value: gain,
              gain_percentage: gainPct,
              annual_dividend_per_share: dps,
              annual_div_yield: yieldPct,
              annual_income: income,
              sector: row["sector"],
              last_updated: new Date().toISOString().replace("T"," ").substring(0,19),

              // Extra â€” inject watchlist tags for REIT/VALUATION dashboarding
              fair_value: wl ? wl.fairvalue : null,
              discount_pct: wl ? wl["Discount %"] : null,
              rating: wl ? wl.Status : null
            };

            // Sort into IG or T212
            if (row["account"] === "IG ISA") aurora.isa.holdings.ig_isa.push(obj);
            if (row["account"] === "TRADE212") aurora.isa.holdings.trade212_isa.push(obj);
          });

          // -------------------------------
          // SAVE UPDATED FILE
          // -------------------------------
          fs.writeFileSync(auroraPath, JSON.stringify(aurora, null, 2));
          EOF

      # ==============================================
      # 4) COMMIT + PUSH BACK TO AURORA REPO
      # ==============================================
     
      - name: ðŸ§¼ Format JSON with Prettier
        run: |
          npx prettier --write "*.json" "**/*.json"
      
      - name: ðŸ“¤ Commit and Push Changes
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "Aurora Automation"

          git add -A
          git commit -m "ðŸ”„ Aurora Master Sync â€“ Live ISA Update" || echo "No changes"
          git pull --rebase --autostash
          git push
