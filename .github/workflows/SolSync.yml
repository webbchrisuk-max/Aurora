name: Aurora â€“ Master Live Sync

on:
  schedule:
    - cron: "*/10 8-16 * * 1-5"
  workflow_dispatch:

concurrency:
  group: aurora-master-sync
  cancel-in-progress: false

jobs:
  aurora_master_update:
    runs-on: ubuntu-latest

    steps:
      # ==========================================================================
      # 0) CHECKOUT
      # ==========================================================================
      - name: ðŸ§© Checkout Repo
        uses: actions/checkout@v4

      # ==========================================================================
      # 1) FETCH GOOGLE SHEETS
      # ==========================================================================
      - name: ðŸŸ¢ Fetch Holdings Sheet
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" \
            -o holdings.json

      - name: ðŸŸ¢ Fetch Watchlist Sheet
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Watchlist" \
            -o watchlist.json

      - name: ðŸŸ¢ Fetch Dividends Sheet
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" \
            -o dividends.json

      # ==========================================================================
      # 2) PROCESS + BUILD AURORASYNC.JSON
      # ==========================================================================
      - name: ðŸ”§ Build AuroraSync.json
        run: |
          node << 'EOF'
          const fs = require("fs");

          const aurora = JSON.parse(fs.readFileSync("AuroraSync.json", "utf8"));
          const holdings = JSON.parse(fs.readFileSync("holdings.json", "utf8"));
          const watchlist = JSON.parse(fs.readFileSync("watchlist.json", "utf8"));
          const dividends = JSON.parse(fs.readFileSync("dividends.json", "utf8"));

          //-------------------------------------------
          // UTILITIES
          //-------------------------------------------
          const num = x => Number(String(x).replace(/[^0-9.-]/g,"")) || 0;
          const today = new Date();

          //-------------------------------------------
          // 1) BUILD ISA HOLDINGS (split IG + T212)
          //-------------------------------------------
          aurora.isa = aurora.isa || {};
          aurora.isa.holdings = { ig_isa: [], trade212_isa: [] };

          holdings.forEach(row => {
            const liveRow = watchlist.find(w => w.ticker?.toUpperCase() === row.ticker?.toUpperCase());
            const live = num(liveRow?.live_price);

            const shares = num(row.shares);
            const book = num(row.book_cost);
            const dps = num(row.annual_dividend_per_share);

            const obj = {
              ticker: row.ticker,
              name: row.name,
              shares,
              book_cost: book,
              live_price: live,
              value: shares * live,
              gain_value: shares * live - book,
              gain_percentage: book > 0 ? ((shares * live - book) / book) * 100 : 0,
              annual_dividend_per_share: dps,
              annual_income: shares * dps,
              annual_div_yield: live > 0 ? (dps / live * 100) : 0,
              sector: row.sector,
              last_updated: new Date().toISOString()
            };

            if (row.account === "IG ISA") aurora.isa.holdings.ig_isa.push(obj);
            if (row.account === "TRADE212") aurora.isa.holdings.trade212_isa.push(obj);
          });

          //-------------------------------------------
          // 2) BUILD REITS + FINANCIALS OUTLOOK
          //-------------------------------------------
          const reitList = ["SUPR", "PHP", "FSFL", "GCP", "RGL"];
          const finList = ["LGEN", "MNG", "PHNX"];

          aurora.reits_outlook = {};
          aurora.financials_outlook = {};

          const wlFetch = t => watchlist.find(w => w.ticker?.toUpperCase() === t);

          reitList.forEach(t => {
            const w = wlFetch(t);
            if (w) aurora.reits_outlook[t] = {
              ticker: t,
              live_price: num(w.live_price),
              fair_value: num(w.fair_value),
              discount_pct: num(w["discount%"]),
              current_yield: num(w.current_yield),
              status: w.status,
              buy_strength: w.buy_strength,
              updated: new Date().toISOString()
            };
          });

          finList.forEach(t => {
            const w = wlFetch(t);
            if (w) aurora.financials_outlook[t] = {
              ticker: t,
              live_price: num(w.live_price),
              fair_value: num(w.fair_value),
              discount_pct: num(w["premium_discount_to_NAV%"]),
              current_yield: num(w.current_yield),
              status: w.status,
              buy_strength: w.buy_strength,
              updated: new Date().toISOString()
            };
          });

          //-------------------------------------------
          // 3) DIVIDENDS â†’ Option 3 Logic
          //-------------------------------------------
          aurora.dividends = aurora.dividends || {};
          aurora.dividends.upcoming = [];
          aurora.dividends.history = [];

          dividends.forEach(row => {
            const pay = new Date(row.pay_date + "T00:00:00");
            const logged = String(row.logged_to_json || "").trim().toLowerCase() === "yes";

            const entry = {
              account: row.account,
              ticker: row.ticker,
              name: row.name,
              ex_div_date: row.ex_div_date,
              pay_date: row.pay_date,
              dividend_per_share: num(row.dividend_per_share),
              shares: num(row.shares),
              total_dividend: num(row.total_dividend),
              frequency: row.frequency,
              status: row.status
            };

            // UPCOMING â€” future pay_date or blank status
            if (pay >= today && !logged) {
              aurora.dividends.upcoming.push(entry);
            }

            // Helper: normalise tickbox TRUE/FALSE or text "yes"
            function isLogged(v) {
            if (v === undefined || v === null) return false;

            const s = String(v).trim().toLowerCase();
            return (s === "yes" || s === "true");
            }

           // HISTORY + UPCOMING logic
           rows.forEach(entry => {.   
           const ex = new Date(entry.ex_div_date);
           const pay = new Date(entry.pay_date);

           const logged = isLogged(entry.logged_to_json);

           // UPCOMING â€” future paydate
           if (pay >= today) {
           aurora.isa.dividends.upcoming.push(entry);
           }

          // HISTORY â€” paid + logged_to_json marked yes/true
          if (pay < today && logged) {
          aurora.isa.dividends.history.push(entry);
          }
          });

          //-------------------------------------------
          // SAVE
          //-------------------------------------------
          fs.writeFileSync("AuroraSync.json", JSON.stringify(aurora, null, 2));
          console.log("âœ“ AuroraSync.json updated successfully");
          EOF

      # ==========================================================================
      # 3) FORMAT + COMMIT
      # ==========================================================================
      - name: ðŸ§¼ Format JSON
        run: |
          npx prettier --write "*.json" "**/*.json"

      - name: ðŸ“¤ Commit and Push
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "Aurora Automation"
          git add -A
          git commit -m "ðŸ”„ Aurora Master Sync â€“ Full Update" || echo "No changes"
          git pull --rebase --autostash
          git push
