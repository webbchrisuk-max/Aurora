name: Aurora â€“ Master Live Sync

on:
  schedule:
    - cron: "*/10 8-16 * * 1-5"
  workflow_dispatch:

concurrency:
  group: aurora-master-sync
  cancel-in-progress: false

jobs:
  aurora_master_update:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout Repo
        uses: actions/checkout@v4

      # ==============================================
      # 1) FETCH GOOGLE SHEETS
      # ==============================================
      - name: ðŸŸ¢ Fetch Holdings Sheet
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Holdings" \
            -o holdings.json

      - name: ðŸ”µ Fetch Watchlist Sheet
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Watchlist" \
            -o watchlist.json

      - name: ðŸŸ£ Fetch Dividends Sheet
        run: |
          curl -s \
            "https://opensheet.elk.sh/10MdgQKc4tParno7pNkz40eBGz308wxHu1u3gvJe_WsE/Dividends" \
            -o dividends.json

      # ==============================================
      # 2) BUILD AURORASYNC.JSON
      # ==============================================
      - name: ðŸ”§ Build AuroraSync.json
        run: |
          node << 'EOF'
          const fs = require("fs");

          const auroraPath = "AuroraSync.json";
          const aurora = JSON.parse(fs.readFileSync(auroraPath, "utf8"));
          const holdings = JSON.parse(fs.readFileSync("holdings.json", "utf8"));
          const watchlist = JSON.parse(fs.readFileSync("watchlist.json", "utf8"));
          const dividends = JSON.parse(fs.readFileSync("dividends.json", "utf8"));

          const num = x => Number(String(x).replace(/[^0-9.-]/g, "")) || 0;
          const today = new Date();

          // =========================
          // ISA HOLDINGS
          // =========================
          aurora.isa = aurora.isa || {};
          aurora.isa.holdings = { ig_isa: [], trade212_isa: [] };

          holdings.forEach(row => {
            const liveRow = watchlist.find(w =>
              (w.ticker || "").toUpperCase() === (row.ticker || "").toUpperCase()
            );

            const live = num(liveRow?.live_price);
            const shares = num(row.shares);
            const book = num(row.book_cost);
            const dps = num(row.annual_dividend_per_share);

            const obj = {
              ticker: row.ticker,
              name: row.name,
              shares,
              book_cost: book,
              live_price: live,
              value: shares * live,
              gain_value: shares * live - book,
              gain_percentage: book > 0 ? ((shares * live - book) / book) * 100 : 0,
              annual_dividend_per_share: dps,
              annual_income: shares * dps,
              current_yield: live > 0 ? (dps / live) * 100 : 0,
              sector: row.sector,
              last_updated: new Date().toISOString().replace("T"," ").substring(0,19)
            };

            if (row.account === "IG ISA")
              aurora.isa.holdings.ig_isa.push(obj);

            if (row.account === "TRADE212")
              aurora.isa.holdings.trade212_isa.push(obj);
          });

          // =========================
          // REITS OUTLOOK
          // =========================
          const REITS = ["SUPR", "PHP", "FSFL", "GCP", "RGL"];

          aurora.reits_outlook = {};

          REITS.forEach(tkr => {
            const row = watchlist.find(w =>
              (w.ticker || "").toUpperCase() === tkr
            );
            if (!row) return;

            aurora.reits_outlook[tkr] = {
              ticker: tkr,
              live_price: num(row.live_price),
              fair_value: num(row.fair_value),
              discount_pct: num(row["discount%"]),
              status: row.status,
              current_yield: num(row.current_yield),
              buy_strength: row.buy_strength
            };
          });

          // =========================
          // FINANCIALS OUTLOOK
          // =========================
          const FINANCIALS = ["LGEN", "MNG", "PHNX"];

          aurora.financials_outlook = {};

          FINANCIALS.forEach(tkr => {
            const row = watchlist.find(w =>
              (w.ticker || "").toUpperCase() === tkr
            );
            if (!row) return;

            aurora.financials_outlook[tkr] = {
              ticker: tkr,
              live_price: num(row.live_price),
              fair_value: num(row.fair_value),
              discount_pct: num(row["discount%"]),
              status: row.status,
              current_yield: num(row.current_yield),
              buy_strength: row.buy_strength
            };
          });

          // =========================
          // DIVIDENDS
          // =========================
          aurora.dividends = aurora.dividends || {};
          aurora.dividends.upcoming = [];
          aurora.dividends.history = [];

          dividends.forEach(row => {
            const payDate = new Date(row.pay_date);
            const logged = String(row.logged_to_json || "").toLowerCase() === "yes";

            const entry = {
              ticker: row.ticker,
              name: row.name,
              pay_date: row.pay_date,
              ex_div_date: row.ex_div_date,
              dividend_per_share: num(row.dividend_per_share),
              shares: num(row.shares_at_exdiv),
              total: num(row.total_dividend),
              frequency: row.frequency
            };

            if (payDate >= today) {
              aurora.dividends.upcoming.push(entry);
            } else {
              if (logged) aurora.dividends.history.push(entry);
            }
          });

          // =========================
          // SAVE FILE
          // =========================
          fs.writeFileSync(auroraPath, JSON.stringify(aurora, null, 2));
          EOF

      # ==============================================
      # 3) COMMIT + PUSH
      # ==============================================
      - name: ðŸ§¼ Format JSON
        run: |
          npx prettier --write "*.json" "**/*.json"

      - name: ðŸ“¤ Commit and Push Changes
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "Aurora Automation"
          git add -A
          git commit -m "ðŸ”„ Aurora Master Sync â€“ Live ISA Update" || echo "No changes"
          git pull --rebase --autostash
          git push