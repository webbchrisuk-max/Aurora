<!-- ===================== SECTION: Aurora Monzo Dashboard v1.6 (Direct Debits Fix + Payday Summary) ===================== -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Aurora Monzo Dashboard v1.6 â€“ Neon Blue + Coral Glow</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Orbitron:wght@500&display=swap" rel="stylesheet" />

<style>

:root {
  --bg-color:#05060a;
  --card-bg:rgba(255,255,255,0.05);
  --text-color:#ffffff;
  --glow-cyan:#00fff7;
  --glow-coral:#ff6f61;
}

/* ===================== GLOBAL ===================== */

body {
  margin: 0;
  padding: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg-color);
  color: var(--text-color);
  overflow-x: hidden;
}

h1, h2, h3 {
  font-family: 'Orbitron', sans-serif;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.container {
  max-width: 1100px;
  margin: auto;
  padding: 20px;
}

/* ===================== HEADER ===================== */

header {
  text-align: center;
  padding: 25px 10px;
  background: linear-gradient(90deg, var(--glow-cyan), var(--glow-coral));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: pulseGlow 4s ease-in-out infinite;
}

@keyframes pulseGlow {
  0%,100% { text-shadow: 0 0 10px var(--glow-coral), 0 0 20px var(--glow-cyan); }
  50%     { text-shadow: 0 0 25px var(--glow-coral), 0 0 35px var(--glow-cyan); }
}

/* ===================== CARD STYLE ===================== */

.card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 20px 22px;
  margin: 25px 0;
  box-shadow: 0 0 20px rgba(0,255,247,0.12);
  backdrop-filter: blur(6px);
  transition: transform 0.25s ease, box-shadow 0.25s ease;
  animation: cardGlow 2s ease-in-out infinite alternate;
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 0 25px rgba(255,111,97,0.3);
}

@keyframes cardGlow {
  0%   { box-shadow: 0 0 8px rgba(0,255,247,0.15), 0 0 20px rgba(255,111,97,0.08); }
  50%  { box-shadow: 0 0 14px rgba(0,255,247,0.25), 0 0 35px rgba(255,111,97,0.15); }
  100% { box-shadow: 0 0 8px rgba(0,255,247,0.15), 0 0 20px rgba(255,111,97,0.08); }
}

/* ===================== PROGRESS BAR ===================== */

.progress-container {
  background: rgba(255,255,255,0.08);
  border-radius: 10px;
  height: 14px;
  overflow: hidden;
  margin-top: 6px;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--glow-cyan), var(--glow-coral));
  border-radius: 10px;
  width: 0;
  transition: width .8s ease-in-out;
}

/* ===================== POTS CAROUSEL ===================== */

.pot-carousel {
  display: flex;
  flex-direction: row;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  scroll-behavior: smooth;
  gap: 80px;
  padding: 45px 0 30px 20px;
  scroll-padding-left: 40px;
  -webkit-overflow-scrolling: touch;
}

.pot-carousel::after {
  content: "";
  flex: 0 0 20px;
}

/* Individual cards */
.pot-card {
  flex: 0 0 80%;
  scroll-snap-align: start;
  background: rgba(255,255,255,0.05);
  border-radius: 14px;
  padding: 18px;
  text-align: center;
  margin-top: 10px;
  box-shadow: 0 0 15px var(--glow-cyan);
  animation: potPulse 2s infinite alternate;
  transition: transform 0.3s ease;
  display: block;
}

.pot-card:hover {
  transform: scale(1.03);
}

/* ===================== RESPONSIVE ===================== */

@media(max-width:600px) {
  .container { padding: 10px; }
  .card { padding: 18px 16px; margin: 22px 0; }
}

</style>
</head>

<body>

<header>
  <h1>Aurora Monzo Dashboard</h1>
  <h3>Live Data Sync â€“ Neon Blue + Coral Glow Edition</h3>
</header>

<div class="container">

  <!-- ===================== MAIN ACCOUNT ===================== -->
  <section class="card">
    <h2>ğŸ¦ Main Account</h2>
    <p><strong>Balance:</strong> Â£<span id="mainBalance">0.00</span></p>
    <p><strong>Payday:</strong> <span id="payday">â€“</span> (Received Â£<span id="payReceived">0.00</span>)</p>
  </section>

  <!-- ===================== DAILY SPENDING TRACKER ===================== -->
  <section class="card">
    <h2>ğŸ•“ Daily Spending Tracker</h2>
    <p><strong>Todayâ€™s Spend:</strong> Â£<span id="todaySpend">0.00</span></p>
    <div class="progress-container"><div id="dailyBar" class="progress-bar"></div></div>
    <p><small id="remainingText">Remaining: Â£0.00</small></p>
    <p><small id="weeklyOverview">Week total: Â£0.00 / Â£0.00</small></p>
  </section>

  <!-- ===================== PAYDAY SUMMARY (INSERTED HERE) ===================== -->
  <section class="card">
    <h2>ğŸ“… Payday Summary</h2>
    <p id="paydaySummaryContent">Loading...</p>
  </section>
  <!-- ===================== END PAYDAY SUMMARY ===================== -->

  <!-- ===================== FLEX ===================== -->
  <section class="card">
    <h2>ğŸ’³ Flex Summary</h2>
    <p><strong>Total Balance:</strong> Â£<span id="flexBalance">0.00</span></p>
    <p><strong>Next Payment:</strong> Â£419.00 on 2025-12-01</p>
  </section>

  <!-- ===================== POTS OVERVIEW ===================== -->
  <section class="card">
    <h2>ğŸ’° Pots Overview</h2>
    <div id="potCarousel" class="pot-carousel"></div>
  </section>

  <!-- ===================== WORK SPENDING TRACKER ===================== -->
  <section class="card">
    <h2>ğŸ’¼ Work Spending Tracker</h2>
    <p><strong>This weekâ€™s work spend:</strong> Â£<span id="workSpend">0.00</span></p>
    <p id="workTransferStatus">Auto-transfer scheduled: Friday 08:00</p>
  </section>

  <!-- ===================== DIRECT DEBITS ===================== -->
  <section class="card">
    <h2>ğŸ” Direct Debits</h2>
    <table id="ddTable">
      <thead>
        <tr>
          <th>Payee</th>
          <th>Amount (Â£)</th>
          <th>Due Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
    <!-- ===================== SUBSCRIPTIONS ===================== -->
  <section class="card">
    <h2>ğŸ“± Subscriptions</h2>
    <table id="subTable">
      <thead>
        <tr>
          <th>Service</th>
          <th>Amount (Â£)</th>
          <th>Renewal Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ===================== RECENT TRANSACTIONS ===================== -->
  <section class="card">
    <h2>ğŸ§¾ Recent Transactions</h2>
    <table id="txnTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Merchant</th>
          <th>Amount (Â£)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

</div> <!-- end container -->

<footer>
  <span id="syncStatus">ğŸŸ¢ Connected â€“ Live Sync Active</span>
</footer>

<!-- ===================== FIXED JS ===================== -->
<script>
async function loadAuroraMonzo() {

  const status = document.getElementById("syncStatus");

  try {

    /* ===================== FETCH AURORA MONZO JSON ===================== */
    const res = await fetch(
      "https://raw.githubusercontent.com/webbchrisuk-max/Aurora/refs/heads/main/AuroraMonzo.json?nocache=" +
      Date.now()
    );

    const data = await res.json();

    const monzo = data.monzo || {};
    const core = monzo.account_core || { pots: {} };
    const pots = core.pots || {};

    const dd = monzo.direct_debits || [];               // Direct Debits
    const subs = monzo.subscriptions_from_main || [];   // Subscriptions
    const txns = monzo.transactions || [];              // Transactions

    /* ===================== ACCOUNT ===================== */
    document.getElementById("mainBalance").textContent =
      core.main_balance?.toFixed(2) || "0.00";

    document.getElementById("payday").textContent =
      core.payday_last || "â€”";

    document.getElementById("payReceived").textContent =
      core.income_received?.toFixed(2) || "0.00";

    document.getElementById("flexBalance").textContent =
      (pots["Flex Repayment"] || 0).toFixed(2);


    /* ===================== DATE RANGE FOR SPENDING ===================== */

    const today = new Date();
    const weekday = today.getDay();
    let lastFriday = new Date(today);

    const offset = weekday >= 5 ? weekday - 5 : 7 - (5 - weekday);
    lastFriday.setDate(today.getDate() - offset);

    const nextFriday = new Date(lastFriday);
    nextFriday.setDate(lastFriday.getDate() + 7);

    const weeklyLimit = core.main_balance / 4;
    const dailyAllowance = weeklyLimit / 7;


    /* ===================== DATE PARSER (Flexible) ===================== */

    function parseDateFlexible(input) {
      if (!input) return null;

      if (input instanceof Date) return input;

      if (!isNaN(Date.parse(input))) {
        return new Date(input);
      }

      if (/^\d{4}-\d{2}-\d{2}$/.test(input)) {
        const [y, m, d] = input.split("-").map(Number);
        return new Date(y, m - 1, d);
      }

      if (/^\d{2}\/\d{2}\/\d{4}$/.test(input)) {
        const [d, m, y] = input.split("/").map(Number);
        return new Date(y, m - 1, d);
      }

      return null;
    }


    /* ===================== SPENDING TRACKER ===================== */

    let todaySpend = 0;
    let weekSpend = 0;

    txns.forEach(tx => {
      const date = parseDateFlexible(tx.Date);
      const amt = parseFloat(tx["Amount (Â£)"]) || 0;
      if (!date) return;

      if (date.toDateString() === today.toDateString()) {
        todaySpend += amt;
      }
      if (date >= lastFriday && date < nextFriday) {
        weekSpend += amt;
      }
    });

    const remainingToday = Math.max(dailyAllowance - todaySpend, 0);
    const pctUsed = Math.min((todaySpend / dailyAllowance) * 100, 100);

    document.getElementById("todaySpend").textContent =
      todaySpend.toFixed(2);

    document.getElementById("remainingText").textContent =
      "Remaining: Â£" + remainingToday.toFixed(2);

    document.getElementById("weeklyOverview").textContent =
      `Week total: Â£${weekSpend.toFixed(2)} / Â£${weeklyLimit.toFixed(2)}`;

    document.getElementById("dailyBar").style.width =
      (100 - pctUsed) + "%";


    /* ===================== WORK SPENDING ===================== */

    let workSpend = 0;

    txns.forEach(tx => {
      const cat = (tx.Category || "").toLowerCase();
      const date = parseDateFlexible(tx.Date);
      const amt = parseFloat(tx["Amount (Â£)"]) || 0;

      if (cat === "work" && date >= lastFriday && date < nextFriday) {
        workSpend += amt;
      }
    });

    document.getElementById("workSpend").textContent =
      workSpend.toFixed(2);
          /* ===================== DIRECT DEBITS (FULL FIX) ===================== */

    const ddBody = document.querySelector("#ddTable tbody");
    ddBody.innerHTML = "";

    // Payday range
    const start = new Date(); 
    start.setHours(0, 0, 0, 0);

    const paydayNextDate = parseDateFlexible(core.payday_next);
    const end = new Date(paydayNextDate);
    end.setHours(23, 59, 59, 999);

    // Fix: map lowercase or uppercase JSON fields safely
    const ddMapped = dd.map(item => {
      return {
        date: parseDateFlexible(item.date || item.DATE),
        payee: item.payee || item.NAME,
        amount: Number(item.amount || item.AMOUNT || 0),
        pot: item.pot || item.POT,
        status: item.status || item.STATUS,
        paid: item.paid ?? item.PAID
      };
    });

    // Filter DDs between now and payday
    const filtered = ddMapped
      .filter(e => e.date && e.date >= start && e.date <= end)
      .sort((a, b) => a.date - b.date);

    let totalDue = 0;

    if (filtered.length === 0) {
      ddBody.innerHTML = `
        <tr>
          <td colspan="3" style="text-align:center;color:#777;">
            No direct debits before payday
          </td>
        </tr>`;
    } else {
      filtered.forEach(item => {
        totalDue += item.amount;

        ddBody.innerHTML += `
          <tr>
            <td>${item.payee}</td>
            <td>${item.amount.toFixed(2)}</td>
            <td>${item.date.toISOString().split("T")[0]}</td>
          </tr>`;
      });

      // Total row
      ddBody.innerHTML += `
        <tr style="color:var(--glow-cyan);font-weight:bold;">
          <td>Total Due Before Payday</td>
          <td colspan="2">Â£${totalDue.toFixed(2)}</td>
        </tr>`;
    }


    /* ===================== SUBSCRIPTIONS ===================== */

    const subBody = document.querySelector("#subTable tbody");
    subBody.innerHTML = "";

    subs.forEach(s => {
      subBody.innerHTML += `
        <tr>
          <td>${s.service}</td>
          <td>${Number(s.amount).toFixed(2)}</td>
          <td>${s.renewal_date}</td>
        </tr>`;
    });

    /* ===================== RECENT TRANSACTIONS (UPGRADED) ===================== */
   
const txnBody = document.querySelector("#txnTable tbody");
txnBody.innerHTML = "";

// ICON MAPPING based on Merchant / Category words
function getTxnIcon(tx) {
  const m = (tx.Merchant || "").toLowerCase();
  const c = (tx.Category || "").toLowerCase();

  if (c.includes("work")) return "ğŸ’¼";
  if (c.includes("bills")) return "ğŸ§¾";
  if (c.includes("food") || m.includes("eat")) return "ğŸ½ï¸";
  if (c.includes("shopping") || m.includes("shop")) return "ğŸ›ï¸";
  if (c.includes("travel")) return "ğŸš†";
  if (m.includes("monzo")) return "ğŸ¦";
  if (c.includes("transfer")) return "ğŸ”";
  if (c.includes("salary")) return "ğŸ’°";

  return "ğŸ’¸"; // default
}

// Convert & sort newest â†’ oldest
const sortedTxns = txns
  .map(tx => ({
    ...tx,
    _dateObj: parseDateFlexible(tx.Date)
  }))
  .filter(tx => tx._dateObj)
  .sort((a, b) => b._dateObj - a._dateObj);

// Take most recent 5
sortedTxns.slice(0, 5).forEach(tx => {
  const amt = parseFloat(tx["Amount (Â£)"]) || 0;
  const icon = getTxnIcon(tx);

  // Colour & glow for money IN/OUT
  const amtColor = amt < 0 ? "style='color:#ff6f61; font-weight:bold;'" 
                           : "style='color:#00fff7; font-weight:bold;'";

  const glow = Math.abs(amt) >= 50 ? "text-shadow:0 0 8px var(--glow-coral);" : "";

  txnBody.innerHTML += `
    <tr>
      <td>${tx.Date}</td>
      <td>${icon} ${tx.Merchant}</td>
      <td ${amtColor} style="${glow}">${amt.toFixed(2)}</td>
    </tr>`;
});
    

    /* ===================== POTS OVERVIEW ===================== */

    const goals = {
      "Flex Repayment": 810.77,
      "Direct Debits": 459.45,
      "Holiday": 297.79,
      "Coventry City FC": 500,
      "IGTrading": 400,
      "Car Maintenance": 400,
      "Work Buffer": 65,
      "Savings": 1000,
      "Dentist": 1800
    };

    const carousel = document.getElementById("potCarousel");
    carousel.innerHTML = "";

    Object.entries(pots).forEach(([name, bal]) => {
      if (name === "Flex Repayment") return;

      const goal = goals[name] || 500;
      const pct = Math.min((bal / goal) * 100, 100);

      carousel.innerHTML += `
        <div class="pot-card">
          <h3>${name}</h3>
          <p>Â£${bal.toFixed(2)} / Â£${goal}</p>
          <div class="progress-container">
            <div class="progress-bar" style="width:${pct}%;"></div>
          </div>
        </div>`;
    });


    /* ===================== PAYDAY SUMMARY ===================== */

    const paydayNext = parseDateFlexible(core.payday_next);
    const todayDate = new Date();

    const daysToPayday = Math.ceil(
      (paydayNext.getTime() - todayDate.getTime()) / (1000 * 60 * 60 * 24)
    );

    // Your fixed event spending amounts:
    const event22 = 60;  // Â£40 meal + Â£20 match
    const event29 = 120; // Â£100 night + Â£20 match
    const totalEvents = event22 + event29;

    const remainingAfterEvents = core.main_balance - totalEvents;
    const dailyAllowanceFinal = daysToPayday > 0
      ? remainingAfterEvents / daysToPayday
      : 0;

    document.getElementById("paydaySummaryContent").innerHTML = `
      <strong>Current Balance:</strong> Â£${core.main_balance.toFixed(2)}<br>
      <strong>Events:</strong> Â£${totalEvents.toFixed(2)}<br>
      <strong>Remaining After Events:</strong> Â£${remainingAfterEvents.toFixed(2)}<br>
      <strong>Days to Payday:</strong> ${daysToPayday}<br>
      <strong>Daily Allowance:</strong> Â£${dailyAllowanceFinal.toFixed(2)}/day
    `;


    /* ===================== STATUS ===================== */

    status.innerHTML = "ğŸŸ¢ Connected â€“ Live Sync Active";

  } catch (err) {
    console.error("Aurora Monzo load error:", err);
    status.innerHTML = "ğŸ”´ Disconnected â€“ Retryingâ€¦";
    status.style.color = "#ff6666";
  }
}

document.addEventListener("DOMContentLoaded", loadAuroraMonzo);
</script>

</body>
</html>
      