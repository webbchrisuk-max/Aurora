<!-- ===================== AURORA MONZO DASHBOARD v2.0 â€“ Option E Engine ===================== -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Aurora Monzo Dashboard â€“ Option E Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Orbitron:wght@500&display=swap" rel="stylesheet" />

<style>
:root {
  --bg-color:#05060a;
  --card-bg:rgba(255,255,255,0.05);
  --text-color:#ffffff;
  --glow-cyan:#00fff7;
  --glow-coral:#ff6f61;
}

/* === GLOBAL === */
body{
  margin:0;
  padding:0;
  font-family:'Inter',sans-serif;
  background:var(--bg-color);
  color:var(--text-color);
  overflow-x:hidden;
}
h1,h2,h3{
  font-family:'Orbitron',sans-serif;
  text-transform:uppercase;
  letter-spacing:1px;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:20px;
}

/* === HEADER === */
header{
  text-align:center;
  padding:25px 10px;
  background:linear-gradient(90deg,var(--glow-cyan),var(--glow-coral));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  animation:pulseGlow 4s ease-in-out infinite;
}
@keyframes pulseGlow{
  0%,100%{text-shadow:0 0 10px var(--glow-coral),0 0 20px var(--glow-cyan);}
  50%{text-shadow:0 0 25px var(--glow-coral),0 0 35px var(--glow-cyan);}
}

/* === CARD === */
.card{
  background:var(--card-bg);
  border-radius:16px;
  padding:20px 22px;
  margin:25px 0;
  box-shadow:0 0 20px rgba(0,255,247,0.12);
  backdrop-filter:blur(6px);
  animation:cardGlow 2s ease-in-out infinite alternate;
}
@keyframes cardGlow{
  0%{box-shadow:0 0 8px rgba(0,255,247,0.15),0 0 20px rgba(255,111,97,0.08);}
  50%{box-shadow:0 0 14px rgba(0,255,247,0.25),0 0 35px rgba(255,111,97,0.15);}
  100%{box-shadow:0 0 8px rgba(0,255,247,0.15),0 0 20px rgba(255,111,97,0.08);}
}

/* === PROGRESS BARS === */
.progress-container{
  background:rgba(255,255,255,0.08);
  border-radius:10px;
  height:14px;
  overflow:hidden;
  margin-top:6px;
}
.progress-bar{
  height:100%;
  background:linear-gradient(90deg,var(--glow-cyan),var(--glow-coral));
  border-radius:10px;
  width:0;
  transition:width .8s ease-in-out;
}

/* ===================== POT CAROUSEL ===================== */
.pot-carousel {
  display:flex;
  flex-direction:row;
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  gap:80px;
  padding:45px 0 30px 20px;
}
.pot-card {
  flex:0 0 80%;
  scroll-snap-align:start;
  background:rgba(255,255,255,0.05);
  border-radius:14px;
  padding:18px;
  text-align:center;
  box-shadow:0 0 15px var(--glow-cyan);
  animation:potPulse 2s infinite alternate;
}

/* ===================== TRANSACTION FILTER BAR ===================== */
.filter-bar {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:15px;
}
.filter-btn {
  padding:8px 14px;
  border-radius:20px;
  border:1px solid var(--glow-cyan);
  color:var(--glow-cyan);
  cursor:pointer;
  background:rgba(255,255,255,0.05);
}
.filter-btn.active {
  background:var(--glow-cyan);
  color:#000;
  font-weight:bold;
  box-shadow:0 0 10px var(--glow-cyan);
}

/* ===================== TRANSACTION PANEL ===================== */
.txn-panel {
  max-height:350px;
  overflow-y:auto;
  padding-right:6px;
}
.txn-entry {
  padding:10px 0;
  border-bottom:1px solid rgba(255,255,255,0.08);
}
.txn-entry:last-child {
  border-bottom:none;
}

@media(max-width:600px){
  .container{padding:10px;}
  .card{padding:18px 16px;margin:22px 0;}
}
</style>
</head>

<body>
<header>
  <h1>Aurora Monzo Dashboard</h1>
  <h3>Live Data Sync â€“ Option E Payday Engine</h3>
</header>

<div class="container">

  <!-- ğŸ¦ MAIN ACCOUNT -->
  <section class="card">
    <h2>ğŸ¦ Main Account</h2>
    <p><strong>Balance:</strong> Â£<span id="mainBalance">0.00</span></p>
    <p><strong>Payday:</strong> <span id="payday">â€“</span> (Received Â£<span id="payReceived">0.00</span>)</p>
  </section>

  <!-- ğŸ•“ DAILY TRACKER -->
  <section class="card">
    <h2>ğŸ•“ Daily Spending Tracker</h2>
    <p><strong>Todayâ€™s Spend:</strong> Â£<span id="todaySpend">0.00</span></p>
    <div class="progress-container"><div id="dailyBar" class="progress-bar"></div></div>
    <p><small id="remainingText">Remaining: Â£0.00</small></p>
    <p><small id="weeklyOverview">Week total: Â£0.00 / Â£0.00</small></p>
  </section>

  <!-- ğŸ“… PAYDAY SUMMARY -->
  <section class="card">
    <h2>ğŸ“… Payday Summary</h2>
    <p><strong>Remaining Direct Debits:</strong> Â£<span id="remainingDD">0.00</span></p>
    <p><strong>Remaining Spending Money:</strong> Â£<span id="remainingSpending">0.00</span></p>
    <hr style="opacity:0.3;">
    <p id="finalSummary" style="color:var(--glow-cyan);font-size:15px;line-height:1.45;"></p>
  </section>

  <!-- ğŸ’³ FLEX -->
  <section class="card">
    <h2>ğŸ’³ Flex Summary</h2>
    <p><strong>Total Balance:</strong> Â£<span id="flexBalance">0.00</span></p>
    <p><strong>Next Payment:</strong> Â£419.00 on 2025-12-01</p>
  </section>

  <!-- ğŸ’° POTS -->
  <section class="card">
    <h2>ğŸ’° Pots Overview</h2>
    <div id="potCarousel" class="pot-carousel"></div>
  </section>

  <!-- ğŸ’¼ WORK -->
  <section class="card">
    <h2>ğŸ’¼ Work Spending Tracker</h2>
    <p><strong>This weekâ€™s work spend:</strong> Â£<span id="workSpend">0.00</span></p>
    <p id="workTransferStatus">Auto-transfer scheduled: Friday 08:00</p>
  </section>

  <!-- ğŸ” DIRECT DEBITS -->
  <section class="card">
    <h2>ğŸ” Direct Debits</h2>
    <table id="ddTable">
      <thead><tr><th>Payee</th><th>Amount (Â£)</th><th>Due Date</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ğŸ§¾ TRANSACTIONS -->
  <section class="card">
    <h2>ğŸ§¾ Transactions</h2>

    <!-- FILTER BAR -->
    <div class="filter-bar">
      <div class="filter-btn active" data-filter="all">All</div>
      <div class="filter-btn" data-filter="work">Work</div>
      <div class="filter-btn" data-filter="groceries">Groceries</div>
      <div class="filter-btn" data-filter="fuel">Fuel</div>
      <div class="filter-btn" data-filter="food">Food/Drink</div>
      <div class="filter-btn" data-filter="transfer">Transfers</div>
      <div class="filter-btn" data-filter="bills">Bills</div>
      <div class="filter-btn" data-filter="subscription">Subs</div>
    </div>

    <!-- SCROLLABLE TRANSACTION PANEL -->
    <div id="txnPanel" class="txn-panel"></div>
  </section>

</div>

<footer><span id="syncStatus">ğŸŸ¢ Connected â€“ Live Sync Active</span></footer>

<!-- ===================== JAVASCRIPT PART 2 BELOW ===================== -->
  <script>
async function loadAuroraMonzo() {

  const status = document.getElementById("syncStatus");
  const txnPanel = document.getElementById("txnPanel");

  try {
    const res = await fetch(
      "https://raw.githubusercontent.com/webbchrisuk-max/Aurora/refs/heads/main/AuroraMonzo.json?nocache=" + Date.now()
    );
    const data = await res.json();

    const monzo = data.monzo || {};
    const core = monzo.account_core || {};
    const pots = core.pots || {};
    const dd = monzo.direct_debits || [];
    const txns = monzo.transactions || [];

    /* ===================== ACCOUNT CORE ===================== */
    document.getElementById("mainBalance").textContent =
      (core.main_balance || 0).toFixed(2);

    document.getElementById("payday").textContent = core.payday_last || "â€”";
    document.getElementById("payReceived").textContent =
      (core.income_received || 0).toFixed(2);

    document.getElementById("flexBalance").textContent =
      (pots["Flex Repayment"] || 0).toFixed(2);

    /* ===================== DATE HELPERS ===================== */
    function parseDateFlexible(input) {
      if (!input) return null;

      // Already a Date
      if (Object.prototype.toString.call(input) === "[object Date]") {
        return isNaN(input.getTime()) ? null : input;
      }

      // ISO
      if (/^\d{4}-\d{2}-\d{2}/.test(input)) {
        const d = new Date(input);
        return isNaN(d.getTime()) ? null : d;
      }

      // UK DD/MM/YYYY
      if (/^\d{2}\/\d{2}\/\d{4}/.test(input)) {
        const [dd, mm, yyyy] = input.split("/");
        const d = new Date(yyyy, mm - 1, dd);
        return isNaN(d.getTime()) ? null : d;
      }

      const fallback = new Date(input);
      return isNaN(fallback.getTime()) ? null : fallback;
    }

    /* ===================== WEEK / DAY SPENDING ===================== */
    const today = new Date();
    const weekday = today.getDay();

    // Last Friday:
    let lastFriday = new Date(today);
    const offset = weekday >= 5 ? weekday - 5 : 7 - (5 - weekday);
    lastFriday.setDate(today.getDate() - offset);
    lastFriday.setHours(0,0,0,0);

    let nextFriday = new Date(lastFriday);
    nextFriday.setDate(lastFriday.getDate() + 7);
    nextFriday.setHours(23,59,59,999);

    let todaySpend = 0;
    let weekSpend = 0;

    txns.forEach(tx => {
      const date = parseDateFlexible(tx.Date);
      const amt = parseFloat(tx["Amount (Â£)"]) || 0;

      // Skip excluded
      if (tx["Exclude From Spend"] === "TRUE") return;

      if (date && date.toDateString() === today.toDateString()) {
        todaySpend += amt;
      }
      if (date && date >= lastFriday && date <= nextFriday) {
        weekSpend += amt;
      }
    });

    const weeklyLimit = (core.main_balance || 0) / 4;
    const dailyAllowance = weeklyLimit / 7;
    const remainingToday = Math.max(dailyAllowance - todaySpend, 0);
    const pctUsed = Math.min((todaySpend / dailyAllowance) * 100, 100);

    document.getElementById("todaySpend").textContent = todaySpend.toFixed(2);
    document.getElementById("remainingText").textContent =
      "Remaining: Â£" + remainingToday.toFixed(2);
    document.getElementById("weeklyOverview").textContent =
      `Week total: Â£${weekSpend.toFixed(2)} / Â£${weeklyLimit.toFixed(2)}`;

    document.getElementById("dailyBar").style.width = (100 - pctUsed) + "%";

    /* ===================== WORK SPENDING ===================== */
    let workSpend = 0;

    txns.forEach(tx => {
      const cat = (tx.Category || "").toLowerCase();
      const amt = parseFloat(tx["Amount (Â£)"]) || 0;
      const date = parseDateFlexible(tx.Date);

      if (tx["Exclude From Spend"] === "TRUE") return;

      if (cat.includes("work") && date >= lastFriday && date <= nextFriday) {
        workSpend += amt;
      }
    });

    document.getElementById("workSpend").textContent = workSpend.toFixed(2);

    /* ===================== DIRECT DEBITS TABLE ===================== */
    const ddBody = document.querySelector("#ddTable tbody");
    ddBody.innerHTML = "";

    const nextPay = parseDateFlexible(core.payday_next);

    const ddFiltered = dd
      .filter(item => item.DATE && item.AMOUNT)
      .map(item => ({
        ...item,
        dateObj: parseDateFlexible(item.DATE),
        amountNum: parseFloat(item.AMOUNT) || 0,
        paid: item.PAID === "TRUE"
      }))
      .filter(item => item.dateObj && item.dateObj <= nextPay)
      .sort((a, b) => a.dateObj - b.dateObj);

    let ddTotal = 0;

    ddFiltered.forEach(item => {
      if (!item.paid) ddTotal += item.amountNum;

      ddBody.innerHTML += `
        <tr>
          <td>${item.NAME}</td>
          <td>Â£${item.amountNum.toFixed(2)}</td>
          <td>${item.DATE}</td>
        </tr>`;
    });

    if (ddFiltered.length > 0) {
      ddBody.innerHTML += `
        <tr style="color:var(--glow-cyan)">
          <td><strong>Total Remaining</strong></td>
          <td colspan="2"><strong>Â£${ddTotal.toFixed(2)}</strong></td>
        </tr>`;
    } else {
      ddBody.innerHTML = `
        <tr><td colspan="3" style="text-align:center;color:#777">No direct debits before next payday</td></tr>`;
    }

    document.getElementById("remainingDD").textContent = ddTotal.toFixed(2);

    /* ===================== OPTION E â€” AUTO POT TARGET ENGINE ===================== */

    const potTargets = [
      { name:"Flex Repayment",       target:896.71,      deadline:"2026-01-01",  type:"fixed" },
      { name:"Coventry City FC",     target:500,         deadline:"2026-05-31",  type:"fixed" },
      { name:"Christmas",            target:300,         deadline:"2025-12-05",  type:"fixed" },

      // Rolling pots
      { name:"Dentist",              perPayday:50,       type:"rolling" },
      { name:"Car Maintenance",      perPayday:0,        monthly:0, type:"rolling" },
      { name:"Work Buffer",          perPayday:60,       type:"rolling" }
    ];

    function getPaydaysUntil(deadline) {
      const next = parseDateFlexible(core.payday_next);
      const end  = parseDateFlexible(deadline);
      if (!next || !end) return 1;

      let count = 0;
      let t = new Date(next);

      while (t <= end) {
        count++;
        t.setDate(t.getDate() + 28);
      }
      return Math.max(count,1);
    }

    let autoCommitments = 0;

    potTargets.forEach(pt => {
      const bal = pots[pt.name] || 0;

      if (pt.type === "fixed") {
        const need = Math.max(pt.target - bal, 0);
        const paydays = getPaydaysUntil(pt.deadline);
        autoCommitments += need / paydays;
      }

      if (pt.type === "rolling" && pt.perPayday) {
        autoCommitments += pt.perPayday;
      }
    });

    /* Mandatory silent items */
    const petrol    = 60;
    const personal  = 21;
    const essentials = 750;

    const plannedCommitments =
      autoCommitments + petrol + personal + essentials;

    const remainingSpendMoney =
      (core.main_balance || 0) - plannedCommitments;

    document.getElementById("remainingSpending").textContent =
      remainingSpendMoney.toFixed(2);

    /* ===================== FINAL SUMMARY ===================== */

    const nextPayday = parseDateFlexible(core.payday_next);
    const today2 = new Date();
    const daysLeft = Math.ceil((nextPayday - today2) / (1000*60*60*24));

    const daily = remainingSpendMoney / Math.max(daysLeft,1);

    let statusColor = "var(--glow-cyan)";
    if (daily < 5) statusColor = "var(--glow-coral)";
    if (daily < 2) statusColor = "red";

    document.getElementById("finalSummary").style.color = statusColor;

    document.getElementById("finalSummary").innerHTML = `
      ğŸ’° You have: Â£${(core.main_balance || 0).toFixed(2)} until payday<br>
      ğŸ§¾ Events total: Â£${plannedCommitments.toFixed(2)}<br>
      ğŸ¯ Left after events: Â£${remainingSpendMoney.toFixed(2)}<br>
      ğŸ“† Days to payday: ${daysLeft}<br>
      ğŸ’µ Daily allowance: Â£${daily.toFixed(2)} / day<br>
      ${daily >= 5 ? "ğŸŸ¢ You're still safe" : daily >= 3 ? "ğŸŸ  Warning" : "ğŸ”´ Critical"}
    `;

    /* ===================== POT CAROUSEL ===================== */
    const goals = {};
    potTargets.forEach(pt => goals[pt.name] = pt.target || pt.perPayday * 10 || 500);

    const carousel = document.getElementById("potCarousel");
    carousel.innerHTML = "";

    Object.entries(pots).forEach(([name, bal]) => {
      if (name === "Flex Repayment") return;

      const goal = goals[name] || 500;
      const pct = Math.min((bal / goal) * 100, 100);

      carousel.innerHTML += `
        <div class="pot-card">
          <h3>${name}</h3>
          <p>Â£${bal.toFixed(2)} / Â£${goal}</p>
          <div class="progress-container">
            <div class="progress-bar" style="width:${pct}%;"></div>
          </div>
        </div>`;
    });

    /* ===================== PREP TRANSACTIONS FOR PART 3 ===================== */
    window.AllTransactions = txns
      .map(tx => ({
        ...tx,
        dateObj: parseDateFlexible(tx.Date),
        amountNum: parseFloat(tx["Amount (Â£)"]) || 0,
        category: (tx.Category || "").toLowerCase(),
        merchant: (tx.Merchant || "")
      }))
      .filter(tx => tx.dateObj)
      .sort((a, b) => b.dateObj - a.dateObj);

    status.innerHTML = "ğŸŸ¢ Connected â€“ Live Sync Active";

  } catch (err) {
    console.error(err);
    status.innerHTML = "ğŸ”´ Disconnected â€“ Retryingâ€¦";
    status.style.color = "#ff6666";
  }
}

document.addEventListener("DOMContentLoaded", loadAuroraMonzo);
</script>
<script>
/* ===================== ICON MAPPING ===================== */
function getTxnIcon(tx) {
  const m = tx.merchant.toLowerCase();
  const c = tx.category.toLowerCase();

  if (c.includes("work")) return "ğŸ’¼";
  if (c.includes("fuel") || m.includes("petrol")) return "â›½";
  if (c.includes("grocer") || m.includes("asda") || m.includes("tesco") || m.includes("one stop"))
    return "ğŸ›’";
  if (c.includes("food") || c.includes("takeaway") || m.includes("just eat"))
    return "ğŸ”";
  if (c.includes("drink") || m.includes("pub")) return "ğŸ»";
  if (c.includes("transfer")) return "ğŸ”";
  if (c.includes("gaming")) return "ğŸ®";
  if (c.includes("bills") || c.includes("finance")) return "ğŸ§¾";
  if (c.includes("subscription")) return "ğŸ””";

  return "ğŸ’¸";
}

/* ===================== COLOUR LOGIC ===================== */
function getAmountStyle(tx) {
  let style = "";

  const outgoing =
    tx.type === "Debit" ||
    (!tx.category.includes("salary") && !tx.category.includes("refund"));

  if (outgoing) {
    style = "color:#ff6f61; font-weight:bold; text-shadow:0 0 6px rgba(255,111,97,0.8);";
  } else {
    style = "color:#00fff7; font-weight:bold; text-shadow:0 0 8px rgba(0,255,247,0.8);";
  }

  return style;
}

/* ===================== FILTER LOGIC ===================== */
function passesFilter(tx, filter) {
  if (filter === "all") return true;

  if (filter === "work") return tx.category.includes("work");
  if (filter === "groceries") return tx.category.includes("groc");
  if (filter === "fuel") return tx.category.includes("fuel");
  if (filter === "food")
    return (
      tx.category.includes("food") ||
      tx.category.includes("takeaway") ||
      tx.category.includes("drink")
    );
  if (filter === "transfer") return tx.category.includes("transfer");
  if (filter === "bills")
    return (
      tx.category.includes("bill") ||
      tx.category.includes("finance") ||
      tx.category.includes("car maintenance")
    );
  if (filter === "subscription")
    return (
      tx.category.includes("subscription") ||
      tx.merchant.toLowerCase().includes("apple") ||
      tx.merchant.toLowerCase().includes("spotify")
    );

  return true;
}

/* ===================== RENDER TRANSACTIONS PANEL ===================== */
function renderTransactions(filter = "all") {
  const panel = document.getElementById("txnPanel");
  panel.innerHTML = "";

  const txns = window.AllTransactions || [];

  txns.forEach(tx => {
    if (!passesFilter(tx, filter)) return;

    const icon = getTxnIcon(tx);
    const style = getAmountStyle(tx);

    panel.innerHTML += `
      <div class="txn-entry">
        <strong>${tx.Date}</strong> â€” ${icon} ${tx.merchant}
        <span style="float:right; ${style}">Â£${tx.amountNum.toFixed(2)}</span>
      </div>
    `;
  });

  if (panel.innerHTML.trim() === "") {
    panel.innerHTML = `<p style="text-align:center; opacity:0.6;">No transactions</p>`;
  }
}

/* ===================== FILTER BUTTON HANDLING ===================== */
document.addEventListener("DOMContentLoaded", () => {
  const filterButtons = document.querySelectorAll(".filter-btn");

  filterButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      filterButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const filter = btn.getAttribute("data-filter");
      renderTransactions(filter);
    });
  });

  // Render initial view
  setTimeout(() => renderTransactions("all"), 300);
});
</script>

</body>
</html>
