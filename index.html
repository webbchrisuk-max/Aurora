<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta content="width=device-width, initial-scale=1.0" name="viewport" />
<title>Aurora Tracker – Core v2 (Endpoint-Rotation)</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet" />
<style>
  :root{--cyan:#00ffff;--green:#00ff99;--bg1:#060018;--bg2:#120035;--bg3:#001a33;}
  body{margin:0;padding:18px;font-family:'Orbitron',sans-serif;color:#fff;
       background:linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3));background-size:600% 600%;
       animation:auroraDrift 45s ease-in-out infinite;}
  @keyframes auroraDrift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  h1{margin:0 0 10px;text-shadow:0 0 14px rgba(0,255,255,.7)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media(max-width:840px){.row{grid-template-columns:1fr}}
  .card{background:rgba(10,10,30,.65);border:1px solid rgba(0,255,255,.25);border-radius:10px;padding:16px}
  table{width:100%;border-collapse:collapse;font-size:.9rem}
  th,td{padding:6px 8px;text-align:left;border-bottom:1px solid rgba(255,255,255,.06)}
  th{color:#fff;text-shadow:0 0 8px rgba(0,255,255,.45)}
  .value{color:var(--cyan)}
  .gain-pos{color:var(--green)}
  .gain-neg{color:#ff5555}
  .pill{display:inline-block;padding:3px 8px;border:1px solid rgba(0,255,255,.4);border-radius:8px;margin-left:8px;font-size:.75rem;color:#dff}
  #syncDot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#888;margin-right:6px;box-shadow:0 0 10px #888;vertical-align:middle}
  #debug{white-space:pre-wrap;background:rgba(0,0,0,.35);border:1px dashed rgba(255,255,255,.25);padding:10px;border-radius:8px;font-size:.8rem;color:#cfe}
  button{background:transparent;color:#fff;border:1px solid var(--cyan);border-radius:8px;padding:6px 10px;cursor:pointer}
  button:hover{box-shadow:0 0 8px var(--cyan)}
</style>
</head>
<body>
  <h1>Aurora Tracker – Core v2 <span id="env" class="pill">init…</span></h1>
  <div style="margin:6px 0 14px;">
    <span id="syncDot"></span><span id="syncText">Waiting…</span>
    <button id="hardRefresh" style="margin-left:10px">Hard refresh</button>
  </div>

  <div class="row">
    <div class="card">
      <h2>Portfolio Summary</h2>
      <p>Total Target: £<span id="targetValue">0</span></p>
      <p>Dividend Yield: <span id="divYield">0</span>%</p>
      <p>IG ISA Balance: £<span id="igBalance">0</span></p>
      <p>Trade212 Balance: £<span id="t212Balance">0</span></p>
    </div>

    <div class="card">
      <h2>Debug</h2>
      <div id="debug">Ready.</div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>IG ISA Holdings</h2>
    <div class="table-holder">
      <table id="igTable">
        <thead>
          <tr>
            <th>Name</th><th>Shares</th><th>Live Price (£)</th><th>Value (£)</th>
            <th>Gain (£)</th><th>Gain (%)</th><th>Yield (%)</th><th>Income (£)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h2>Trade212 ISA Holdings</h2>
    <div class="table-holder">
      <table id="t212Table">
        <thead>
          <tr>
            <th>Name</th><th>Shares</th><th>Live Price (£)</th><th>Value (£)</th>
            <th>Gain (£)</th><th>Gain (%)</th><th>Yield (%)</th><th>Income (£)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
/* ===================== CONFIG ===================== */
const RAW_GITHUB   = "https://raw.githubusercontent.com/webbchrisuk-max/Aurora/refs/heads/main/AuroraSync.json";
const JSDELIVR     = "https://cdn.jsdelivr.net/gh/webbchrisuk-max/Aurora@main/AuroraSync.json";
const GH_API_RAW   = "https://api.github.com/repos/webbchrisuk-max/Aurora/contents/AuroraSync.json"; // needs Accept: raw

const ENDPOINTS = [
  { url: RAW_GITHUB, headers: {} },
  { url: JSDELIVR,   headers: {} },
  { url: GH_API_RAW, headers: { "Accept":"application/vnd.github.v3.raw" } }
];

const asNum = v => isNaN(+v) ? 0 : +v;
const d = (sel) => document.querySelector(sel);
const debug = (...m) => { const el=d("#debug"); el.textContent += "\n" + m.join(" "); el.scrollTop = el.scrollHeight; };
const setDot = (ok) => {
  const dot = d("#syncDot");
  dot.style.background = ok ? "#00ffcc" : "#ff4444";
  dot.style.boxShadow = ok ? "0 0 12px #00ffcc" : "0 0 12px #ff4444";
};

/* ===================== FETCH WITH ROTATION ===================== */
function fetchWithTimeout(resource, options = {}) {
  const { timeout = 10000 } = options;
  return new Promise((resolve, reject) => {
    const timer = setTimeout(() => reject(new Error("Timeout " + timeout + "ms")), timeout);
    fetch(resource, options).then(
      (res) => { clearTimeout(timer); resolve(res); },
      (err) => { clearTimeout(timer); reject(err); }
    );
  });
}

async function getAuroraSync(force = false) {
  const ts = Date.now() + (force ? ("."+Math.random()) : "");
  let lastErr = null;

  for (let i=0;i<ENDPOINTS.length;i++) {
    const ep = ENDPOINTS[i];
    const url = ep.url + (ep.url.includes("?") ? "&" : "?") + "ts=" + ts;
    try {
      debug(`Trying [${i+1}/${ENDPOINTS.length}]: ${url}`);
      const res = await fetchWithTimeout(url, {
        cache: "no-store",
        headers: { "Cache-Control":"no-cache, no-store, must-revalidate", "Pragma":"no-cache", "Expires":"0", ...ep.headers },
        timeout: 12000
      });
      if (!res.ok) throw new Error("HTTP " + res.status);

      const data = await res.json();
      d("#env").textContent = new URL(ep.url).host;
      return data;
    } catch (e) {
      debug("Failed:", e.message);
      lastErr = e;
    }
  }
  throw lastErr || new Error("All endpoints failed");
}

/* ===================== RENDER ===================== */
function renderAll(data){
  // Summary
  d("#targetValue").textContent = asNum(data?.isa?.portfolio_summary?.annual_target_value).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  d("#divYield").textContent = asNum(data?.isa?.portfolio_summary?.dividend_yield).toFixed(2);
  d("#igBalance").textContent = asNum(data?.isa?.ig_isa?.balance).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  d("#t212Balance").textContent = asNum(data?.isa?.trade212_isa?.balance).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

  // Tables
  const igRows   = (data?.isa_feed || []).filter(x => (x.account||"").toUpperCase()==="IG ISA");
  const t212Rows = (data?.isa_feed || []).filter(x => (x.account||"").toUpperCase()==="TRADE212");

  fillTable("#igTable tbody", igRows);
  fillTable("#t212Table tbody", t212Rows);
}

function fillTable(sel, list){
  const tb = d(sel);
  tb.innerHTML = "";
  list.forEach(h => {
    const tr = document.createElement("tr");
    const gainVal = asNum(h.gain_value);
    tr.innerHTML = `
      <td>${h.name||""}</td>
      <td>${asNum(h.shares)}</td>
      <td class="value">${asNum(h.live_price).toFixed(4)}</td>
      <td class="value">${asNum(h.value).toFixed(2)}</td>
      <td class="${gainVal>=0?"gain-pos":"gain-neg"}">${gainVal.toFixed(2)}</td>
      <td class="${gainVal>=0?"gain-pos":"gain-neg"}">${asNum(h.gain_percentage).toFixed(2)}%</td>
      <td>${asNum(h.annual_dividend_per_share? (asNum(h.annual_dividend_per_share)/asNum(h.live_price||1))*100 : h.annual_div_yield).toFixed(2)}%</td>
      <td>${asNum(h.annual_income).toFixed(2)}</td>
    `;
    tb.appendChild(tr);
  });
}

/* ===================== ORCHESTRATION ===================== */
async function syncOnce(force=false){
  setDot(false);
  d("#syncText").textContent = "Syncing…";
  try{
    const data = await getAuroraSync(force);
    renderAll(data);
    setDot(true);
    const now = new Date();
    d("#syncText").textContent = `Last updated ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
    debug("✅ Sync OK.");
  }catch(e){
    setDot(false);
    d("#syncText").textContent = "❌ Failed to fetch AuroraSync.json — see Debug.";
    debug("❌ Final error:", e.message);
  }
}

document.getElementById("hardRefresh").addEventListener("click", ()=>syncOnce(true));

/* Init: one clean load, then 5-min interval */
syncOnce(true);
setInterval(()=>syncOnce(false), 300000);
</script>
</body>
</html>
