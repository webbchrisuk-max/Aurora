<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta content="width=device-width, initial-scale=1.0" name="viewport" />
<title>Aurora Tracker ‚Äì Core v3</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet" />

<!-- ===================== SECTION: CORE THEME ===================== -->
<style>
:root{
  --cyan:#00ffff;
  --magenta:#ff00ff;
  --green:#00ff99;
  --bg1:#060018;
  --bg2:#120035;
  --bg3:#001a33;
}

/* Background */
body{
  margin:0;padding:0;
  font-family:'Orbitron',sans-serif;
  color:#fff;
  background:linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3));
  background-size:600% 600%;
  animation:auroraDrift 45s ease-in-out infinite;
  overflow-x:hidden;
}
@keyframes auroraDrift{
  0%{background-position:0% 50%;}
  25%{background-position:50% 100%;}
  50%{background-position:100% 50%;}
  75%{background-position:50% 0%;}
  100%{background-position:0% 50%;}
}

/* Headings */
h1{text-align:center;font-size:1.8rem;margin:20px 0;color:#fff;
    text-shadow:0 0 14px rgba(0,255,255,0.7),0 0 28px rgba(0,255,255,0.35);}
h2,h3{color:#fff;text-shadow:0 0 10px rgba(0,255,255,0.55);margin-top:.5em;}

/* Grid */
.dashboard{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;
  margin:0 auto;max-width:1200px;padding:0 20px 30px;align-items:start;}
@media(max-width:820px){.dashboard{grid-template-columns:1fr;padding:0 16px 24px;}}

/* Cards */
.card{background:rgba(10,10,30,0.65);border:1px solid rgba(0,255,255,0.25);
  border-radius:10px;padding:20px;box-shadow:0 0 20px rgba(0,255,255,0.15);
  backdrop-filter:blur(6px);animation:fadeIn .8s ease-in-out;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

/* Tables */
.table-holder{overflow-x:auto;max-height:350px;}
table{width:100%;border-collapse:collapse;font-size:.9rem;}
th,td{padding:6px 8px;text-align:left;}
th{color:#fff;text-shadow:0 0 8px rgba(0,255,255,0.45);}
tr:nth-child(even){background:rgba(255,255,255,0.05);}
tr:hover{background:rgba(0,255,255,0.10);}
.value{color:var(--cyan);}
.gain-pos{color:var(--green);}
.gain-neg{color:#ff5555;}

/* Sync indicator */
#auroraSyncStatus{position:fixed;top:10px;right:20px;font-size:.85rem;color:#fff;}
#auroraSyncDot{display:inline-block;width:10px;height:10px;border-radius:50%;
  background:var(--cyan);box-shadow:0 0 10px var(--cyan);
  margin-right:6px;vertical-align:middle;animation:pulseGlow 3s ease-in-out infinite;}
@keyframes pulseGlow{0%,100%{box-shadow:0 0 10px var(--cyan);}50%{box-shadow:0 0 25px var(--cyan);}}
#syncTime{display:block;font-size:.75rem;color:#aaa;margin-top:2px;}

/* Highlight helpers */
.amount-green{color:var(--green);}
.date-pink{color:#ff66cc;}

/* Sector bars (static visual) */
.sector-bars{margin-top:25px;display:flex;flex-direction:column;gap:10px;}
.sector-bar{display:flex;align-items:center;justify-content:space-between;gap:10px;font-size:.9rem;}
.sector-bar span{min-width:110px;text-shadow:0 0 8px rgba(255,255,255,0.6);}
.sector-bar .val{min-width:40px;text-align:right;}
.bar{flex-grow:1;height:10px;border-radius:5px;background:rgba(255,255,255,0.1);position:relative;overflow:hidden;}
.bar::after{content:"";position:absolute;top:0;left:0;height:100%;width:var(--p);
  background:linear-gradient(90deg,var(--cyan),#9dfcff);
  border-radius:5px;box-shadow:0 0 8px var(--cyan);
  animation:growBar 1.2s ease-out forwards;}
@keyframes growBar{from{width:0;opacity:.5;}to{width:var(--p);opacity:1;}}
</style>
</head>
<body>
<h1>Aurora Tracker ‚Äì Core v3</h1>

<div id="auroraSyncStatus">
  <span id="auroraSyncDot"></span>Synced
  <span id="syncTime">Last updated --:-- ¬∑ Next sync in 5 min</span>
</div>

<div class="dashboard">

  <!-- ===== Portfolio Summary ===== -->
  <div class="card" id="portfolio-summary">
    <h2>Portfolio Summary</h2>
    <p>Total Target: ¬£<span id="targetValue">0.00</span></p>
    <p>Dividend Yield: <span id="divYield">0.00</span>%</p>
    <p>Total Gain: <span id="totalGain">0.00</span> ( <span id="gainPercent">0.00</span>% )</p>
  </div>

  <!-- ===== ISA Balances ===== -->
  <div class="card" id="isa-balances">
    <h2>ISA Balances</h2>
    <p>IG ISA: ¬£<span id="igBalance">0.00</span></p>
    <p>Trade212 ISA: ¬£<span id="t212Balance">0.00</span></p>
  </div>

  <!-- ===== Unified Holdings ===== -->
  <div class="card" id="holdings-unified">
    <h2>Holdings</h2>
    <div class="table-holder" style="margin-bottom:18px;">
      <h3>IG ISA</h3>
      <table id="igTable">
        <thead><tr><th>Name</th><th>Value (¬£)</th><th>Gain (¬£)</th><th>Gain (%)</th><th>Yield (%)</th><th>Income (¬£)</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="table-holder">
      <h3>Trade212 ISA</h3>
      <table id="t212Table">
        <thead><tr><th>Name</th><th>Value (¬£)</th><th>Gain (¬£)</th><th>Gain (%)</th><th>Yield (%)</th><th>Income (¬£)</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ===== Dividends Centre ===== -->
  <div class="card" id="dividends">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Dividends Centre</h2>
    </div>
    <div id="dividendListView">
      <h3>Next 5 Dividends</h3><ul id="nextDivs"></ul>
      <h3>Next 5 Ex-Dividends</h3><ul id="nextExDivs"></ul>
    </div>
  </div>

  <!-- ===== Dividend Forecast & Quarterly Overview ===== -->
  <div class="card" id="dividend-forecast">
    <h2>Dividend Forecast</h2>
    <p style="text-align:center;">
      Forecast Annual Income: ¬£<span id="forecastTotal">0.00</span> ¬∑ YTD Received: ¬£<span id="receivedYTD">0.00</span>
    </p>
    <div style="width:90%;margin:10px auto 20px;background:rgba(255,255,255,0.1);
                border-radius:8px;height:16px;overflow:hidden;">
      <div id="forecastProgress"
           style="height:100%;width:0%;
                  background:linear-gradient(90deg,var(--cyan),#9dfcff);
                  box-shadow:0 0 10px var(--cyan);
                  transition:width 1s ease;"></div>
    </div>
    <p style="text-align:center;font-size:.8rem;margin-bottom:30px;">
      Progress to ¬£6 000 Goal: <span id="forecastPercent">0%</span>
    </p>
    <h3 style="text-align:center;">Quarterly Totals</h3>
    <div id="quarterlyBars"
         style="display:flex;justify-content:space-around;align-items:flex-end;
                height:220px;margin-top:10px;gap:14px;"></div>
  </div>
  <!-- ===================== SCRIPT ENGINE (SYNC + RENDER) ===================== -->
<script>
/* üîó Live JSON feed (locked to your repo) */
const JSON_URL = "https://raw.githubusercontent.com/webbchrisuk-max/Aurora/refs/heads/main/AuroraSync.json?ts=";
let lastGain = 0;

/* Helpers */
const asNum = v => isNaN(+v) ? 0 : +v;

/* ===================== SMART SYNC ===================== */
async function loadAuroraSync(attempt = 1, hard = false) {
  const dot = document.getElementById("auroraSyncDot");
  const time = document.getElementById("syncTime");

  try {
    const fullUrl = JSON_URL + (hard ? (Date.now() + "." + Math.random()) : Date.now());
    console.log("Fetching:", fullUrl);
    const res = await fetch(fullUrl, {
      cache: "no-store",
      headers: {
        "Cache-Control": "no-cache, no-store, must-revalidate",
        "Pragma": "no-cache",
        "Expires": "0"
      }
    });
    if (!res.ok) throw new Error("HTTP " + res.status);

    const data = await res.json();
    renderAll(data);

    const now = new Date();
    time.textContent =
      `Last updated ${now.getHours().toString().padStart(2,"0")}:${now.getMinutes()
        .toString().padStart(2,"0")} ¬∑ Next sync in 5 min`;
    dot.style.background = "#00ffcc";
    dot.style.boxShadow = "0 0 10px #00ffcc";
  } catch (e) {
    console.error("‚ùå Sync failed (attempt " + attempt + "):", e);
    if (attempt < 3) setTimeout(() => loadAuroraSync(attempt + 1, hard), 2000);
    else {
      dot.style.background = "#ff3333";
      dot.style.boxShadow = "0 0 15px #ff3333";
      time.textContent = "Sync Error after 3 attempts";
    }
  }
}

/* ===================== RENDER CORE ===================== */
function renderAll(data){
  // --- Portfolio Summary ---
  const g = asNum(data.isa?.ig_isa?.unrealised_gain) + asNum(data.isa?.trade212_isa?.unrealised_gain);
  const pct = ((g / (asNum(data.isa?.ig_isa?.book_cost) + asNum(data.isa?.trade212_isa?.book_cost))) * 100) || 0;
  document.getElementById("targetValue").textContent = asNum(data.isa.portfolio_summary.annual_target_value).toFixed(2);
  document.getElementById("divYield").textContent = asNum(data.isa.portfolio_summary.dividend_yield).toFixed(2);
  document.getElementById("totalGain").textContent = g.toFixed(2);
  document.getElementById("gainPercent").textContent = pct.toFixed(2);

  // --- Balances ---
  document.getElementById("igBalance").textContent = asNum(data.isa.ig_isa.balance).toFixed(2);
  document.getElementById("t212Balance").textContent = asNum(data.isa.trade212_isa.balance).toFixed(2);

  // --- Holdings Tables ---
  renderTable("#igTable tbody", data.isa_feed.filter(x=>x.account==="IG ISA"));
  renderTable("#t212Table tbody", data.isa_feed.filter(x=>x.account==="TRADE212"));

  // --- Dividends ---
  renderDividends(data);

  // --- Forecast + Chart ---
  renderForecast(data);
}

/* ===================== TABLES ===================== */
function renderTable(sel,list){
  const el=document.querySelector(sel);
  el.innerHTML="";
  list.forEach(h=>{
    el.insertAdjacentHTML("beforeend",
      `<tr><td>${h.name}</td>
       <td class='value'>${asNum(h.value).toFixed(2)}</td>
       <td class='${asNum(h.gain_value)>=0?"gain-pos":"gain-neg"}'>${asNum(h.gain_value).toFixed(2)}</td>
       <td class='${asNum(h.gain_value)>=0?"gain-pos":"gain-neg"}'>${asNum(h.gain_percentage).toFixed(2)}%</td>
       <td>${asNum(h.annual_div_yield).toFixed(2)}%</td>
       <td>${asNum(h.annual_income).toFixed(2)}</td></tr>`);
  });
}

/* ===================== DIVIDEND LISTS ===================== */
function renderDividends(data){
  const now=new Date();
  const next=document.getElementById("nextDivs");
  const nextEx=document.getElementById("nextExDivs");
  next.innerHTML=""; nextEx.innerHTML="";
  const pays=(data.dividends_feed||[]).filter(d=>new Date(d.pay_date)>now)
              .sort((a,b)=>new Date(a.pay_date)-new Date(b.pay_date)).slice(0,5);
  const exes=(data.dividends_feed||[]).filter(d=>new Date(d.ex_div_date)>now)
              .sort((a,b)=>new Date(a.ex_div_date)-new Date(b.ex_div_date)).slice(0,5);
  pays.forEach(d=>{
    next.insertAdjacentHTML("beforeend",
      `<li>${d.name} ‚Äì <span class='amount-green'>¬£${asNum(d.total_dividend).toFixed(2)}</span>
       on <span class='date-pink'>${d.pay_date}</span></li>`);
  });
  exes.forEach(d=>{
    nextEx.insertAdjacentHTML("beforeend",
      `<li>${d.name} ‚Äì Ex-Div <span class='date-pink'>${d.ex_div_date}</span></li>`);
  });
}

/* ===================== DIVIDEND FORECAST + QUARTERLY ===================== */
function renderForecast(data){
  const f=data.dividend_planner || {};
  document.getElementById("forecastTotal").textContent=asNum(f.forecast_total).toFixed(2);
  document.getElementById("receivedYTD").textContent=asNum(f.received_ytd).toFixed(2);
  const pct=(asNum(f.forecast_total)/6000*100).toFixed(1);
  document.getElementById("forecastPercent").textContent=pct+"%";
  document.getElementById("forecastProgress").style.width=Math.min(pct,100)+"%";

  const el=document.getElementById("quarterlyBars");
  el.innerHTML="";
  const qd=f.quarterly_breakdown || {};
  const max=Math.max(1,...Object.values(qd));
  Object.entries(qd).forEach(([q,v])=>{
    const w=document.createElement("div");
    w.style.display="flex";w.style.flexDirection="column";w.style.alignItems="center";
    const b=document.createElement("div");
    b.style.width="55px";
    b.style.height=(v/max*180)+"px";
    b.style.borderRadius="6px 6px 0 0";
    b.style.background="linear-gradient(180deg,#9dfcff,var(--cyan))";
    b.style.boxShadow="0 0 12px var(--cyan)";
    w.appendChild(b);
    const l=document.createElement("div");
    l.innerHTML=`${q}<br>¬£${v.toFixed(2)}`;
    l.style.fontSize=".8rem";l.style.textAlign="center";l.style.marginTop="6px";
    w.appendChild(l);
    el.appendChild(w);
  });
}

/* ===================== INIT ===================== */
document.addEventListener("DOMContentLoaded", () => {
  loadAuroraSync(true); // first load
  setInterval(loadAuroraSync, 300000); // every 5 min
});
</script>
</body>
</html>
  
