<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta content="width=device-width, initial-scale=1.0" name="viewport" />
<title>Aurora Master Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet" />

<!-- ===================== SECTION: CORE THEME ===================== -->
<style>
:root{
  --cyan:#00ffff;
  --magenta:#ff00ff;
  --green:#00ff99;
  --teal:#00ffd0;
  --amber:#ffb347;
  --bg1:#060018;
  --bg2:#120035;
  --bg3:#001a33;
}

body{
  margin:0;padding:0;
  font-family:'Orbitron',sans-serif;
  color:#fff;
  background:linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3));
  background-size:600% 600%;
  animation:auroraDrift 45s ease-in-out infinite;
  overflow-x:hidden;
}
@keyframes auroraDrift{
  0%{background-position:0% 50%;}
  25%{background-position:50% 100%;}
  50%{background-position:100% 50%;}
  75%{background-position:50% 0%;}
  100%{background-position:0% 50%;}
}

h1{text-align:center;font-size:1.8rem;margin:20px 0;color:#fff;
    text-shadow:0 0 14px rgba(0,255,255,0.7),0 0 28px rgba(0,255,255,0.35);}
h2,h3{color:#fff;text-shadow:0 0 10px rgba(0,255,255,0.55);margin-top:.5em;}

.dashboard{
  display:grid;grid-template-columns:repeat(2,1fr);gap:20px;
  margin:0 auto;max-width:1200px;padding:0 20px 30px;align-items:start;
}
@media(max-width:820px){.dashboard{grid-template-columns:1fr;padding:0 16px 24px;}}

.card{
  background:rgba(10,10,30,0.65);
  border:1px solid rgba(0,255,255,0.25);
  border-radius:10px;padding:20px;
  box-shadow:0 0 20px rgba(0,255,255,0.15);
  backdrop-filter:blur(6px);
  animation:fadeIn .8s ease-in-out;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

/* Sync indicator */
#auroraSyncStatus{position:fixed;top:10px;right:20px;font-size:.85rem;color:#fff;}
#auroraSyncDot{display:inline-block;width:10px;height:10px;border-radius:50%;
  background:var(--cyan);box-shadow:0 0 10px var(--cyan);
  margin-right:6px;vertical-align:middle;animation:pulseGlow 3s ease-in-out infinite;}
@keyframes pulseGlow{0%,100%{box-shadow:0 0 10px var(--cyan);}50%{box-shadow:0 0 25px var(--cyan);}}
#syncTime{display:block;font-size:.75rem;color:#aaa;margin-top:2px;}

/* Collapsible headers */
.collapsible{
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(0,255,255,0.2);
  color:#fff;
  cursor:pointer;
  padding:12px 18px;
  width:100%;
  border-radius:8px;
  text-align:left;
  font-size:1rem;
  text-shadow:0 0 6px rgba(0,255,255,0.4);
  transition:background .3s;
}
.collapsible:hover{background:rgba(0,255,255,0.08);}
.content{padding:0 18px;max-height:0;overflow:hidden;transition:max-height 0.4s ease-out;}
.collapsible.active + .content{max-height:1200px;}

/* Colour accents for IG ISA & Trade212 */
#ig-zone .collapsible{border-color:var(--teal);text-shadow:0 0 8px var(--teal);}
#t212-zone .collapsible{border-color:var(--amber);text-shadow:0 0 8px var(--amber);}

/* Portfolio target bar */
.targetBar{
  width:100%;background:rgba(255,255,255,0.1);
  border-radius:10px;height:16px;overflow:hidden;margin-top:8px;
}
.targetFill{
  height:100%;width:0%;
  background:linear-gradient(90deg,var(--cyan),#9dfcff);
  box-shadow:0 0 10px var(--cyan);
  transition:width 1s ease;
}
</style>
</head>

<body>
<h1>Aurora Master Dashboard</h1>

<!-- ===================== SECTION: SYNC STATUS ===================== -->
<div id="auroraSyncStatus">
  <span id="auroraSyncDot"></span>Synced
  <span id="syncTime">Last updated --:-- ¬∑ Next sync in 5 min</span>
</div>

<!-- ===================== SECTION: DASHBOARD ===================== -->
<div class="dashboard">

  <!-- ===== Portfolio Summary ===== -->
  <div class="card" id="portfolio-summary">
    <h2>Portfolio Summary</h2>
    <p>Total Target: ¬£<span id="targetValue">0.00</span></p>
    <div class="targetBar"><div id="targetFill" class="targetFill"></div></div>
    <p>Dividend Yield: <span id="divYield">0.00</span>%</p>
    <p>Total Gain: <span id="totalGain">0.00</span> ( <span id="gainPercent">0.00</span>% )</p>
  </div>

  <!-- ===== ISA Balances ===== -->
  <div class="card" id="isa-balances">
    <h2>ISA Balances</h2>
    <p>IG ISA: ¬£<span id="igBalance">0.00</span></p>
    <p>Trade212 ISA: ¬£<span id="t212Balance">0.00</span></p>
  </div>

  <!-- ===== Dividends Centre (summary) ===== -->
  <div class="card" id="dividends-centre">
    <h2>üìÖ Upcoming Dividends</h2>
    <h3>Next 5 Dividends üí∞</h3>
    <ul id="nextDivs"></ul>
    <h3>Next 5 Ex-Dividends üóìÔ∏è</h3>
    <ul id="nextExDivs"></ul>
  </div>

  <!-- ===== Dividend Forecast & Charts ===== -->
  <div class="card" id="dividend-overview">
    <h2>Dividend Overview</h2>
    <p>Forecast Annual Income: ¬£<span id="forecastTotal">0.00</span></p>
    <p>YTD Received: ¬£<span id="receivedYTD">0.00</span></p>
    <div class="targetBar"><div id="forecastProgress" class="targetFill"></div></div>
    <p style="font-size:.8rem;margin-top:6px;">
      Progress to ¬£6 000 Goal: <span id="forecastPercent">0%</span>
    </p>
    <h3>Quarterly Totals</h3>
    <div id="quarterlyBars"
         style="display:flex;justify-content:space-around;align-items:flex-end;height:220px;margin-top:12px;gap:10px;"></div>
  </div>

  
  <!-- ===== PLACEHOLDER: IG ISA + Trade212 ISA zones (Part 2 will fill these) ===== -->
  <div id="ig-zone">
    <button class="collapsible">‚ñ∂ IG ISA Details</button>
    <div class="content" id="igContent"></div>
  </div>

  <div id="t212-zone">
    <button class="collapsible">‚ñ∂ Trade212 ISA Details</button>
    <div class="content" id="t212Content"></div>
  </div>

</div>
<!-- ===================== SCRIPT ENGINE (SYNC + RENDER) ===================== -->
<script>
/* üîó Live JSON feed (locked to your repository) */
const JSON_URL = "https://raw.githubusercontent.com/webbchrisuk-max/Aurora/refs/heads/main/AuroraSync.json?ts=";
let lastGain = 0;

/* Helpers */
const asNum = v => isNaN(+v) ? 0 : +v;
const shortMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
function monthKey(d){const dt=new Date(d+"T00:00:00Z");return shortMonths[dt.getUTCMonth()]+" "+dt.getUTCFullYear();}

/* ===================== SMART SYNC ===================== */
async function loadAuroraSync(attempt=1,hard=false){
  const dot=document.getElementById("auroraSyncDot");
  const time=document.getElementById("syncTime");
  try{
    const url=JSON_URL+(hard?(Date.now()+"."+Math.random()):Date.now());
    console.log("Fetching:",url);
    const res=await fetch(url,{cache:"no-store",headers:{
      "Cache-Control":"no-cache, no-store, must-revalidate",
      "Pragma":"no-cache","Expires":"0"}});
    if(!res.ok)throw new Error("HTTP "+res.status);
    const data=await res.json();
    renderAll(data);
    const now=new Date();
    time.textContent=`Last updated ${now.getHours().toString().padStart(2,"0")}:${now.getMinutes().toString().padStart(2,"0")} ¬∑ Next sync in 5 min`;
    dot.style.background="#00ffcc";dot.style.boxShadow="0 0 10px #00ffcc";
  }catch(e){
    console.error("‚ùå Sync failed (attempt "+attempt+"):",e);
    if(attempt<3)setTimeout(()=>loadAuroraSync(attempt+1,hard),2000);
    else{dot.style.background="#ff3333";dot.style.boxShadow="0 0 15px #ff3333";time.textContent="Sync Error after 3 attempts";}
  }
}

/* ===================== MAIN RENDER ===================== */
function renderAll(data){
  // Portfolio summary + target bar
  const g=asNum(data.isa?.ig_isa?.unrealised_gain)+asNum(data.isa?.trade212_isa?.unrealised_gain);
  const pct=((g/(asNum(data.isa?.ig_isa?.book_cost)+asNum(data.isa?.trade212_isa?.book_cost)))*100)||0;
  const target=asNum(data.isa.portfolio_summary.annual_target_value)||0;
  const totalBal=asNum(data.isa.ig_isa.balance)+asNum(data.isa.trade212_isa.balance);
  const progress=Math.min((totalBal/target)*100,100);
  document.getElementById("targetValue").textContent=target.toFixed(2);
  document.getElementById("divYield").textContent=asNum(data.isa.portfolio_summary.dividend_yield).toFixed(2);
  document.getElementById("totalGain").textContent=g.toFixed(2);
  document.getElementById("gainPercent").textContent=pct.toFixed(2);
  document.getElementById("targetFill").style.width=progress+"%";
  const card=document.getElementById("portfolio-summary");
  if(g>lastGain)pulse(card,"#00ffcc");else if(g<lastGain)pulse(card,"#ffaa33");lastGain=g;

  // Balances
  document.getElementById("igBalance").textContent=asNum(data.isa.ig_isa.balance).toFixed(2);
  document.getElementById("t212Balance").textContent=asNum(data.isa.trade212_isa.balance).toFixed(2);

  renderDividends(data);
  renderForecast(data);
  renderQuarterly(data);
  renderHoldings(data);
}

/* ===================== DIVIDENDS ===================== */
function renderDividends(data){
  const now=new Date();const next=document.getElementById("nextDivs"),nextEx=document.getElementById("nextExDivs");
  next.innerHTML="";nextEx.innerHTML="";
  const pays=(data.dividends_feed||[]).filter(d=>new Date(d.pay_date)>now)
     .sort((a,b)=>new Date(a.pay_date)-new Date(b.pay_date)).slice(0,5);
  const exes=(data.dividends_feed||[]).filter(d=>new Date(d.ex_div_date)>now)
     .sort((a,b)=>new Date(a.ex_div_date)-new Date(b.ex_div_date)).slice(0,5);
  pays.forEach(d=>next.insertAdjacentHTML("beforeend",
    `<li>üí∞ ${d.name} ‚Äì <span style='color:#00ffcc'>¬£${asNum(d.total_dividend).toFixed(2)}</span> on <span style='color:#ff66cc'>${d.pay_date}</span></li>`));
  exes.forEach(d=>nextEx.insertAdjacentHTML("beforeend",
    `<li>üóìÔ∏è ${d.name} ‚Äì Ex-Div <span style='color:#ff66cc'>${d.ex_div_date}</span></li>`));
}

/* ===================== FORECAST ===================== */
function renderForecast(data){
  const f=data.dividend_planner||{};
  document.getElementById("forecastTotal").textContent=asNum(f.forecast_total).toFixed(2);
  document.getElementById("receivedYTD").textContent=asNum(f.received_ytd).toFixed(2);
  const pct=(asNum(f.forecast_total)/6000*100).toFixed(1);
  document.getElementById("forecastPercent").textContent=pct+"%";
  document.getElementById("forecastProgress").style.width=Math.min(pct,100)+"%";
}
 /* ===================== QUARTERLY CHART ===================== */
function renderQuarterly(data){
  const el=document.getElementById("quarterlyBars");el.innerHTML="";
  const qd=data.dividend_planner?.quarterly_breakdown||{};
  const max=Math.max(1,...Object.values(qd));
  Object.entries(qd).forEach(([q,v])=>{
    const bar=document.createElement("div");
    bar.style.width="60px";bar.style.height=(v/max*190)+"px";
    bar.style.borderRadius="6px 6px 0 0";
    bar.style.background="linear-gradient(180deg,#9dfcff,var(--cyan))";
    bar.style.boxShadow="0 0 15px var(--cyan)";
    const lbl=document.createElement("div");
    lbl.innerHTML=`${q}<br>¬£${v.toFixed(2)}`;
    lbl.style.fontSize=".8rem";lbl.style.textAlign="center";lbl.style.marginTop="6px";
    const wrap=document.createElement("div");
    wrap.style.display="flex";wrap.style.flexDirection="column";wrap.style.alignItems="center";
    wrap.appendChild(bar);wrap.appendChild(lbl);el.appendChild(wrap);
  });
}

/* ===================== ISA SECTIONS ===================== */
function renderHoldings(data){
  renderSection("igContent",data.isa_feed.filter(x=>x.account==="IG ISA"),"var(--teal)");
  renderSection("t212Content",data.isa_feed.filter(x=>x.account==="TRADE212"),"var(--amber)");
}
function renderSection(id,list,color){
  const el=document.getElementById(id);el.innerHTML="";
  if(!list.length){el.innerHTML="<p>No holdings available.</p>";return;}
  let html=`<table style="width:100%;border-collapse:collapse;font-size:.9rem;">
  <thead><tr style="color:${color};text-shadow:0 0 8px ${color};">
  <th>Name</th><th>Value (¬£)</th><th>Gain (¬£)</th><th>Gain (%)</th><th>Yield (%)</th><th>Income (¬£)</th></tr></thead><tbody>`;
  list.forEach(h=>{
    const gainCls=asNum(h.gain_value)>=0?"style='color:#00ffcc'":"style='color:#ff5555'";
    html+=`<tr><td>${h.name}</td><td>${asNum(h.value).toFixed(2)}</td>
           <td ${gainCls}>${asNum(h.gain_value).toFixed(2)}</td>
           <td ${gainCls}>${asNum(h.gain_percentage).toFixed(2)}%</td>
           <td>${asNum(h.annual_div_yield).toFixed(2)}%</td>
           <td>${asNum(h.annual_income).toFixed(2)}</td></tr>`;
  });
  html+="</tbody></table>";el.innerHTML=html;
}
/* ===================== EFFECTS ===================== */
function pulse(el,color){
  el.style.boxShadow=`0 0 26px ${color}`;
  setTimeout(()=>el.style.boxShadow="0 0 20px rgba(0,255,255,0.15)",900);
}

/* Collapsible logic */
document.querySelectorAll(".collapsible").forEach(btn=>{
  btn.addEventListener("click",function(){
    this.classList.toggle("active");
    const c=this.nextElementSibling;
    c.style.maxHeight?(c.style.maxHeight=null):(c.style.maxHeight=c.scrollHeight+"px");
  });
});

/* ===================== INIT ===================== */
document.addEventListener("DOMContentLoaded",()=>{
  loadAuroraSync(true);
  setInterval(loadAuroraSync,300000);
});
</script>

<!-- ===================== SECTION: NAV DISCOUNT LEADERBOARD ===================== -->
<section style="max-width:1200px;margin:18px auto 32px;padding:0 20px;">
  <!-- Glowing section header bar -->
  <div style="
    display:flex;align-items:center;gap:10px;margin:0 0 12px;
    ">
    <div style="flex:1;height:2px;background:linear-gradient(90deg, rgba(0,255,255,0.0), rgba(0,255,255,0.8), rgba(0,255,255,0.0)); box-shadow:0 0 16px rgba(0,255,255,0.6);"></div>
    <div style="white-space:nowrap;font-weight:700;letter-spacing:.3px;color:#bfffff;text-shadow:0 0 10px rgba(0,255,255,.9);">NAV Discount Leaderboard</div>
    <div style="flex:1;height:2px;background:linear-gradient(90deg, rgba(0,255,255,0.0), rgba(0,255,255,0.8), rgba(0,255,255,0.0)); box-shadow:0 0 16px rgba(0,255,255,0.6);"></div>
  </div>

  <!-- Card container -->
  <section id="navDiscountCard" class="aurora-nav-leaderboard" aria-label="NAV Discount Leaderboard">
    <div class="navlb-header">
      <div class="navlb-title">NAV Discount Leaderboard</div>
      <div class="navlb-meta" id="navlbMeta">Loading‚Ä¶</div>
    </div>

    <!-- ===================== SECTION: TOP MOVERS ===================== -->
    <div class="navlb-movers" id="navlbMovers" hidden>
      <div class="navlb-movers-col">
        <h4>Top 3 Weekly Wideners</h4>
        <ul id="navlbWideners"></ul>
      </div>
      <div class="navlb-movers-col">
        <h4>Top 3 Weekly Narrowers</h4>
        <ul id="navlbNarrowers"></ul>
      </div>
    </div>

    <!-- ===================== SECTION: CATEGORY ‚Äì GREEN (DEEP DISCOUNT) ===================== -->
    <div class="navlb-category cat-green" id="navlbGreen" hidden>
      <div class="navlb-cat-title">üü© Deep discount (‚â§ ‚àí10%)</div>
      <div class="navlb-list" id="navlbGreenList"></div>
    </div>

    <!-- ===================== SECTION: CATEGORY ‚Äì YELLOW (MODERATE DISCOUNT) ===================== -->
    <div class="navlb-category cat-yellow" id="navlbYellow" hidden>
      <div class="navlb-cat-title">üü® Moderate discount (‚àí5% to ‚àí9%)</div>
      <div class="navlb-list" id="navlbYellowList"></div>
    </div>

    <!-- ===================== SECTION: CATEGORY ‚Äì WHITE (TIGHT DISCOUNT) ===================== -->
    <div class="navlb-category cat-white" id="navlbWhite" hidden>
      <div class="navlb-cat-title">‚¨úÔ∏è Tight discount (0% to ‚àí4%)</div>
      <div class="navlb-list" id="navlbWhiteList"></div>
    </div>

    <div class="navlb-footnote" id="navlbFoot">Figures auto-sourced from AuroraSync.json ‚Ä¢ Times shown Europe/London</div>
  </section>
</section>

<!-- ===================== SECTION: NAV DISCOUNT LEADERBOARD STYLES (CYAN GLOW) ===================== -->
<style>
  .aurora-nav-leaderboard {
    padding: 14px 16px;
    border-radius: 12px;
    background: rgba(10,10,30,0.65);
    border: 1px solid rgba(0,255,255,0.25);
    box-shadow: 0 0 20px rgba(0,255,255,0.15);
    backdrop-filter: blur(6px);
  }
  .aurora-nav-leaderboard .navlb-header { display:flex; justify-content:space-between; align-items:baseline; gap:12px; margin-bottom:10px; }
  .aurora-nav-leaderboard .navlb-title { font-weight:700; letter-spacing:0.2px; color:#00ffff; text-shadow:0 0 10px rgba(0,255,255,.6); }
  .aurora-nav-leaderboard .navlb-meta { opacity:0.85; font-size:0.88rem; }
  .aurora-nav-leaderboard .navlb-movers { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:10px 0 12px; }
  .aurora-nav-leaderboard .navlb-movers h4 { margin:0 0 6px; font-size:0.95rem; color:#ffd580; text-shadow:0 0 8px rgba(255,213,128,.5); }
  .aurora-nav-leaderboard .navlb-movers ul { margin:0; padding-left:18px; line-height:1.35; }
  .aurora-nav-leaderboard .navlb-category { margin:12px 0; padding:10px 10px 8px; border-left:4px solid transparent; border-radius:10px; }
  .aurora-nav-leaderboard .navlb-cat-title { font-weight:600; margin-bottom:8px; color:#fff; }
  .aurora-nav-leaderboard .navlb-list { display:grid; gap:8px; }
  .aurora-nav-leaderboard .navlb-row { display:grid; grid-template-columns: 64px 1fr 1fr 100px 104px 108px; gap:10px; align-items:center; padding:10px; border:1px solid rgba(255,255,255,0.08); border-radius:10px; background:rgba(255,255,255,0.02); }
  .aurora-nav-leaderboard .navlb-row .ticker { font-weight:700; color:#00ffc8; text-shadow:0 0 6px rgba(0,255,200,.7); }
  .aurora-nav-leaderboard .navlb-row .mono { font-variant-numeric: tabular-nums; }
  .aurora-nav-leaderboard .badge { padding:2px 8px; border-radius:999px; font-size:0.8rem; border:1px solid rgba(255,255,255,0.12); }
  .aurora-nav-leaderboard .cat-green { border-left-color: rgba(0,255,170,0.6); }
  .aurora-nav-leaderboard .cat-yellow { border-left-color: rgba(255,220,0,0.7); }
  .aurora-nav-leaderboard .cat-white { border-left-color: rgba(255,255,255,0.55); }
  .aurora-nav-leaderboard .navlb-footnote { margin-top:12px; opacity:0.75; font-size:0.84rem; text-align:center; }
  @media (max-width: 560px){
    .aurora-nav-leaderboard .navlb-row { grid-template-columns: 62px 1fr; row-gap:6px; }
    .aurora-nav-leaderboard .navlb-row .c2, .c3, .c4, .c5, .c6 { grid-column: 1 / -1; }
  }
</style>

<!-- ===================== SECTION: NAV DISCOUNT LEADERBOARD SCRIPT ===================== -->
<script>
(async function renderNavDiscountCard(containerId = "navDiscountCard"){
  const url = "https://raw.githubusercontent.com/webbchrisuk-max/Aurora/refs/heads/main/AuroraSync.json?nocache=" + Date.now();
  const meta = document.getElementById("navlbMeta");
  const moversWrap = document.getElementById("navlbMovers");
  const widenersEl = document.getElementById("navlbWideners");
  const narrowersEl = document.getElementById("navlbNarrowers");
  const greenWrap = document.getElementById("navlbGreen");
  const yellowWrap = document.getElementById("navlbYellow");
  const whiteWrap = document.getElementById("navlbWhite");
  const greenList = document.getElementById("navlbGreenList");
  const yellowList = document.getElementById("navlbYellowList");
  const whiteList = document.getElementById("navlbWhiteList");
  const foot = document.getElementById("navlbFoot");

  function rowHTML(e){
    const disc = Number(e.discount_percent);
    const wow = (e.wow_change_percent ?? null);
    const wowTxt = (wow === null || isNaN(wow)) ? "n/a" : (wow > 0 ? `+${wow.toFixed(1)}%` : `${wow.toFixed(1)}%`);
    const price = e.share_price ?? "n/a";
    const navfv = e.nav_or_fair_value ?? "n/a";
    const discTxt = isFinite(disc) ? `${disc.toFixed(1)}%` : "n/a";
    return `
      <div class="navlb-row">
        <div class="ticker">${e.ticker || ""}</div>
        <div class="c2">${e.name || ""}</div>
        <div class="c3 mono">¬£${price}</div>
        <div class="c4 mono">¬£${navfv}</div>
        <div class="c5 mono badge">${discTxt}</div>
        <div class="c6 mono badge">${wowTxt}</div>
      </div>`;
  }

  function bucket(e){
    const d = Number(e.discount_percent);
    if (!isFinite(d)) return "other";
    if (d <= -10) return "green";
    if (d <= -5) return "yellow";
    if (d <= 0) return "white";
    return "other";
  }

  try {
    const resp = await fetch(url, { cache: "no-store" });
    const data = await resp.json();

    const weekly = data.nav_discount_leaderboard?.weekly || {};
    const weekKeys = Object.keys(weekly);
    if (!weekKeys.length) {
      meta.textContent = "No leaderboard found yet. It will appear after the first Friday 16:45 run.";
      return;
    }
    const latestKey = weekKeys.sort().slice(-1)[0];
    const pack = weekly[latestKey] || {};
    meta.textContent = `Week ${latestKey} ‚Ä¢ Generated ${pack.generated_at || "n/a"}`;

    const entries = Array.isArray(pack.entries) ? pack.entries.slice() : [];
    entries.sort((a,b)=>Number(a.discount_percent)-Number(b.discount_percent));
    const greens = entries.filter(e=>bucket(e)==="green");
    const yellows = entries.filter(e=>bucket(e)==="yellow");
    const whites  = entries.filter(e=>bucket(e)==="white");

    if (greens.length){ greenWrap.hidden=false; greenList.innerHTML=greens.map(rowHTML).join(""); }
    if (yellows.length){ yellowWrap.hidden=false; yellowList.innerHTML=yellows.map(rowHTML).join(""); }
    if (whites.length){ whiteWrap.hidden=false; whiteList.innerHTML=whites.map(rowHTML).join(""); }

    const tm = pack.top_movers || {};
    const wid = Array.isArray(tm.wideners) ? tm.wideners : [];
    const nar = Array.isArray(tm.narrowers) ? tm.narrowers : [];
    if (wid.length || nar.length){
      moversWrap.hidden=false;
      widenersEl.innerHTML = wid.slice(0,3).map(x => `<li><strong>${x.ticker}</strong> ${x.change_text || (isFinite(x.wow_change_percent)? (x.wow_change_percent>0? `+${x.wow_change_percent.toFixed(1)}%`:`${x.wow_change_percent.toFixed(1)}%`):"")}</li>`).join("");
      narrowersEl.innerHTML = nar.slice(0,3).map(x => `<li><strong>${x.ticker}</strong> ${x.change_text || (isFinite(x.wow_change_percent)? (x.wow_change_percent>0? `+${x.wow_change_percent.toFixed(1)}%`:`${x.wow_change_percent.toFixed(1)}%`):"")}</li>`).join("");
    }

    if (data.integrity?.last_validated){
      foot.textContent = `Figures auto-sourced from AuroraSync.json ‚Ä¢ Last validated ${data.integrity.last_validated}`;
    }
  } catch(err){
    meta.textContent = "Error loading leaderboard. Check AuroraSync.json path.";
    console.error(err);
  }
})();
</script>
<!-- ===================== END: NAV DISCOUNT LEADERBOARD ===================== -->

</body>
</html>