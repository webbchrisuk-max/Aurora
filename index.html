<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Aurora Tracker – Stable Step 3</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet" />
<style>
:root{
  --cyan:#00ffff;
  --green:#00ff99;
  --bg1:#060018;
  --bg2:#120035;
  --bg3:#001a33;
}
body{
  margin:0;padding:0;
  font-family:'Orbitron',sans-serif;color:#fff;
  background:linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3));
  background-size:600% 600%;animation:aurora 45s ease-in-out infinite;
}
@keyframes aurora{
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}
h1{text-align:center;margin:18px 0;text-shadow:0 0 14px rgba(0,255,255,.6);}
.dashboard{display:grid;grid-template-columns:1fr 1fr;gap:18px;max-width:1200px;margin:0 auto;padding:0 16px 32px;}
@media(max-width:820px){.dashboard{grid-template-columns:1fr;}}
.card{background:rgba(10,10,30,.65);border:1px solid rgba(0,255,255,.25);
  border-radius:10px;padding:18px;box-shadow:0 0 18px rgba(0,255,255,.12);}
h2{margin-top:0;text-shadow:0 0 10px rgba(0,255,255,.6);}
table{width:100%;border-collapse:collapse;font-size:.9rem;}
th,td{padding:6px 8px;text-align:left;}
tr:nth-child(even){background:rgba(255,255,255,.05);}
.value{color:var(--cyan);} .gain-pos{color:var(--green);} .gain-neg{color:#ff5555;}
#auroraSyncStatus{position:fixed;top:10px;right:16px;font-size:.8rem}
#auroraSyncDot{display:inline-block;width:10px;height:10px;border-radius:50%;
  background:#888;margin-right:6px;box-shadow:0 0 10px #888;}
.amount-green{color:var(--green);} .date-pink{color:#ff66cc;}
</style>
</head>
<body>
<h1>Aurora Tracker</h1>

<div id="auroraSyncStatus">
  <span id="auroraSyncDot"></span>
  <span id="syncTime">Syncing…</span>
</div>

<div class="dashboard">

  <div class="card" id="portfolio-summary">
    <h2>Portfolio Summary</h2>
    <p>Total Target: £<span id="targetValue">0.00</span></p>
    <p>Dividend Yield: <span id="divYield">0.00</span>%</p>
    <p>Total Gain: £<span id="totalGain">0.00</span> ( <span id="gainPercent">0.00</span>% )</p>
  </div>

  <div class="card" id="isa-balances">
    <h2>ISA Balances</h2>
    <p>IG ISA: £<span id="igBalance">0.00</span></p>
    <p>Trade212 ISA: £<span id="t212Balance">0.00</span></p>
  </div>

  <div class="card" id="holdings">
    <h2>IG ISA Holdings</h2>
    <table id="igTable">
      <thead><tr><th>Name</th><th>Value (£)</th><th>Gain (£)</th><th>Gain (%)</th><th>Yield (%)</th><th>Income (£)</th></tr></thead>
      <tbody></tbody>
    </table>
    <h2 style="margin-top:20px;">Trade212 ISA Holdings</h2>
    <table id="t212Table">
      <thead><tr><th>Name</th><th>Value (£)</th><th>Gain (£)</th><th>Gain (%)</th><th>Yield (%)</th><th>Income (£)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card" id="dividends">
    <h2>Dividends Centre</h2>
    <h3>Next 5 Dividends</h3>
    <ul id="nextDivs"></ul>
    <h3>Next 5 Ex-Dividends</h3>
    <ul id="nextExDivs"></ul>
  </div>

</div>

<script>
const JSON_URL = "https://raw.githubusercontent.com/webbchrisuk-max/Aurora/main/AuroraSync.json?ts=";
let lastGain = 0;
const asNum = v => isNaN(+v)?0:+v;

/* ===================== LOAD + SYNC ===================== */
async function loadAuroraSync(attempt=1,hard=false){
  const dot=document.getElementById("auroraSyncDot");
  const time=document.getElementById("syncTime");
  try{
    const res=await fetch(JSON_URL+Date.now(),{cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const data=await res.json();
    renderAll(data);
    dot.style.background="#00ffcc";dot.style.boxShadow="0 0 10px #00ffcc";
    const now=new Date();
    time.textContent=`Last updated ${now.getHours().toString().padStart(2,"0")}:${now.getMinutes().toString().padStart(2,"0")}`;
  }catch(e){
    console.error("❌ Sync failed",e);
    dot.style.background="#ff3333";dot.style.boxShadow="0 0 10px #ff3333";
    time.textContent="Sync Error";
  }
}

/* ===================== RENDER ENGINE ===================== */
function renderAll(data){
  const g=asNum(data.isa.ig_isa.unrealised_gain)+asNum(data.isa.trade212_isa.unrealised_gain);
  const pct=(g/(asNum(data.isa.ig_isa.book_cost)+asNum(data.isa.trade212_isa.book_cost))*100)||0;
  document.getElementById("targetValue").textContent=asNum(data.isa.portfolio_summary.annual_target_value).toFixed(2);
  document.getElementById("divYield").textContent=asNum(data.isa.portfolio_summary.dividend_yield).toFixed(2);
  document.getElementById("totalGain").textContent=g.toFixed(2);
  document.getElementById("gainPercent").textContent=pct.toFixed(2);
  document.getElementById("igBalance").textContent=asNum(data.isa.ig_isa.balance).toFixed(2);
  document.getElementById("t212Balance").textContent=asNum(data.isa.trade212_isa.balance).toFixed(2);
  renderTable("#igTable tbody",data.isa_feed.filter(x=>x.account==="IG ISA"));
  renderTable("#t212Table tbody",data.isa_feed.filter(x=>x.account==="TRADE212"));
  renderDividends(data);
}

/* ===================== TABLES ===================== */
function renderTable(sel,list){
  const el=document.querySelector(sel);el.innerHTML="";
  list.forEach(h=>{
    el.insertAdjacentHTML("beforeend",
      `<tr>
        <td>${h.name}</td>
        <td class='value'>${asNum(h.value).toFixed(2)}</td>
        <td class='${asNum(h.gain_value)>=0?"gain-pos":"gain-neg"}'>${asNum(h.gain_value).toFixed(2)}</td>
        <td class='${asNum(h.gain_value)>=0?"gain-pos":"gain-neg"}'>${asNum(h.gain_percentage).toFixed(2)}%</td>
        <td>${asNum(h.annual_div_yield).toFixed(2)}%</td>
        <td>${asNum(h.annual_income).toFixed(2)}</td>
      </tr>`);
  });
}

/* ===================== DIVIDENDS ===================== */
function renderDividends(data){
  const now=new Date();
  const next=document.getElementById("nextDivs");
  const nextEx=document.getElementById("nextExDivs");
  next.innerHTML="";nextEx.innerHTML="";
  const pays=(data.dividends_feed||[]).filter(d=>new Date(d.pay_date)>now)
    .sort((a,b)=>new Date(a.pay_date)-new Date(b.pay_date)).slice(0,5);
  const exes=(data.dividends_feed||[]).filter(d=>new Date(d.ex_div_date)>now)
    .sort((a,b)=>new Date(a.ex_div_date)-new Date(b.ex_div_date)).slice(0,5);
  pays.forEach(d=>next.insertAdjacentHTML("beforeend",
    `<li>${d.name} – <span class='amount-green'>£${asNum(d.total_dividend).toFixed(2)}</span> on <span class='date-pink'>${d.pay_date}</span></li>`));
  exes.forEach(d=>nextEx.insertAdjacentHTML("beforeend",
    `<li>${d.name} – Ex-Div <span class='date-pink'>${d.ex_div_date}</span></li>`));
}

/* ===================== INIT ===================== */
document.addEventListener("DOMContentLoaded",()=>{loadAuroraSync();setInterval(loadAuroraSync,300000);});
</script>
</body>
</html>
