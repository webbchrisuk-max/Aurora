<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta content="width=device-width, initial-scale=1.0" name="viewport" />
<title>Aurora Tracker – Known Good Build</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet" />
<style>
  :root{--cyan:#00ffff;--green:#00ff99;--bg1:#060018;--bg2:#120035;--bg3:#001a33;}
  body{margin:0;padding:0;font-family:'Orbitron',sans-serif;color:#fff;
       background:linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3));
       background-size:600% 600%;animation:auroraDrift 45s ease-in-out infinite;}
  @keyframes auroraDrift{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
  h1{text-align:center;margin:18px 0;text-shadow:0 0 14px rgba(0,255,255,.6);}
  .wrap{max-width:1100px;margin:0 auto;padding:0 16px 32px;display:grid;grid-template-columns:1fr 1fr;gap:18px;}
  @media (max-width:820px){.wrap{grid-template-columns:1fr;}}
  .card{background:rgba(10,10,30,.65);border:1px solid rgba(0,255,255,.25);border-radius:10px;padding:16px;
        box-shadow:0 0 20px rgba(0,255,255,.12);backdrop-filter:blur(6px);}
  .kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px}
  .kv b{opacity:.9}
  table{width:100%;border-collapse:collapse;font-size:.9rem}
  th,td{padding:6px 8px;text-align:left}
  tr:nth-child(even){background:rgba(255,255,255,.06)}
  .val{color:var(--cyan)}
  .pos{color:var(--green)} .neg{color:#ff6464}
  /* sync */
  #sync{position:fixed;top:10px;right:12px;font-size:.8rem}
  #dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#888;margin-right:6px;box-shadow:0 0 8px #888}
  /* debug */
  #dbg{font-family:ui-monospace,Consolas,monospace;font-size:.78rem;background:rgba(0,0,0,.35);
       border:1px dashed rgba(0,255,255,.3);padding:10px;border-radius:8px;max-height:140px;overflow:auto}
</style>
</head>
<body>
<h1>Aurora Tracker – Core (Rollback)</h1>

<div id="sync"><span id="dot"></span><span id="syncText">Waiting…</span></div>

<div class="wrap">
  <div class="card">
    <h2>Portfolio Summary</h2>
    <div class="kv">
      <b>Total Target:</b> <span>£<span id="targetValue">0.00</span></span>
      <b>Dividend Yield:</b> <span><span id="divYield">0.00</span>%</span>
      <b>Total Gain:</b> <span>£<span id="totalGain">0.00</span> (<span id="gainPercent">0.00</span>%)</span>
    </div>
  </div>

  <div class="card">
    <h2>ISA Balances</h2>
    <div class="kv">
      <b>IG ISA:</b> <span>£<span id="igBalance">0.00</span></span>
      <b>Trade212 ISA:</b> <span>£<span id="t212Balance">0.00</span></span>
    </div>
  </div>

  <div class="card" style="grid-column:1 / -1">
    <h2>IG ISA Holdings</h2>
    <div style="overflow:auto">
      <table id="igTable">
        <thead>
          <tr>
            <th>Name</th><th>Shares</th><th>Price (£)</th><th>Value (£)</th>
            <th>Gain (£)</th><th>Gain (%)</th><th>Yield (%)</th><th>Income (£)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="grid-column:1 / -1">
    <h2>Trade212 ISA Holdings</h2>
    <div style="overflow:auto">
      <table id="t212Table">
        <thead>
          <tr>
            <th>Name</th><th>Shares</th><th>Price (£)</th><th>Value (£)</th>
            <th>Gain (£)</th><th>Gain (%)</th><th>Yield (%)</th><th>Income (£)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="grid-column:1 / -1">
    <h3>Connectivity Debug (safe to leave)</h3>
    <div id="dbg">Ready.</div>
  </div>
</div>

<script>
(function(){
  // ---- Config: three mirrors + hard cache-bust
  var SOURCES = [
    "https://raw.githubusercontent.com/webbchrisuk-max/Aurora/refs/heads/main/AuroraSync.json?ts=",
    "https://cdn.jsdelivr.net/gh/webbchrisuk-max/Aurora@main/AuroraSync.json?ts=",
    "https://api.github.com/repos/webbchrisuk-max/Aurora/contents/AuroraSync.json?ts="
  ];
  var dot = document.getElementById("dot");
  var syncText = document.getElementById("syncText");
  var dbg = document.getElementById("dbg");

  function log(s){ dbg.textContent += "\n" + s; dbg.scrollTop = dbg.scrollHeight; }

  function asNum(v){ var n = Number(v); return isNaN(n) ? 0 : n; }

  function renderAll(data){
    // If GitHub API endpoint used, the file is base64 in `content`
    if (data && data.content && data.encoding === "base64") {
      try {
        var decoded = atob(data.content.replace(/\n/g,""));
        data = JSON.parse(decoded);
      } catch(e) {
        log("Decode error: " + e);
        throw e;
      }
    }

    // Portfolio summary
    var ig = (data.isa && data.isa.ig_isa) ? data.isa.ig_isa : {};
    var t2 = (data.isa && data.isa.trade212_isa) ? data.isa.trade212_isa : {};
    var ps = (data.isa && data.isa.portfolio_summary) ? data.isa.portfolio_summary : {};

    var g = asNum(ig.unrealised_gain) + asNum(t2.unrealised_gain);
    var denom = asNum(ig.book_cost) + asNum(t2.book_cost);
    var pct = denom ? (g/denom*100) : 0;

    document.getElementById("targetValue").textContent = asNum(ps.annual_target_value).toFixed(2);
    document.getElementById("divYield").textContent = asNum(ps.dividend_yield).toFixed(2);
    document.getElementById("totalGain").textContent = g.toFixed(2);
    document.getElementById("gainPercent").textContent = pct.toFixed(2);

    document.getElementById("igBalance").textContent = asNum(ig.balance).toFixed(2);
    document.getElementById("t212Balance").textContent = asNum(t2.balance).toFixed(2);

    // Tables
    var feed = Array.isArray(data.isa_feed) ? data.isa_feed : [];
    drawTable("igTable", feed.filter(function(x){return (x.account||"").toUpperCase()==="IG ISA";}));
    drawTable("t212Table", feed.filter(function(x){return (x.account||"").toUpperCase()==="TRADE212";}));
  }

  function drawTable(id, list){
    var tbody = document.querySelector("#"+id+" tbody");
    tbody.innerHTML = "";
    list.forEach(function(h){
      var tr = document.createElement("tr");
      var price = asNum(h.latest_price || h.price);
      var gainVal = asNum(h.gain_value);
      var gainPct = asNum(h.gain_percentage);
      tr.innerHTML =
        "<td>"+(h.name||"-")+"</td>"+
        "<td>"+asNum(h.shares||0)+"</td>"+
        "<td class='val'>"+price.toFixed(4)+"</td>"+
        "<td class='val'>"+asNum(h.value||0).toFixed(2)+"</td>"+
        "<td class='"+(gainVal>=0?"pos":"neg")+"'>"+gainVal.toFixed(2)+"</td>"+
        "<td class='"+(gainPct>=0?"pos":"neg")+"'>"+gainPct.toFixed(2)+"%</td>"+
        "<td>"+asNum(h.annual_div_yield||0).toFixed(2)+"%</td>"+
        "<td>"+asNum(h.annual_income||0).toFixed(2)+"</td>";
      tbody.appendChild(tr);
    });
  }

  function setOK(){
    dot.style.background = "#00ffcc";
    dot.style.boxShadow = "0 0 12px #00ffcc";
  }
  function setFail(){
    dot.style.background = "#ff4343";
    dot.style.boxShadow = "0 0 12px #ff4343";
  }

  function nowTime(){
    var d=new Date();
    return d.getHours().toString().padStart(2,"0")+":"+
           d.getMinutes().toString().padStart(2,"0")+":"+
           d.getSeconds().toString().padStart(2,"0");
  }

  function hardBust(){
    return Date.now()+"."+Math.random();
  }

  function tryFetch(idx){
    if (idx >= SOURCES.length) {
      setFail();
      syncText.textContent = "❌ Final error: Load failed";
      log("❌ Final error: Load failed");
      return;
    }
    var url = SOURCES[idx] + hardBust();
    log("Trying ["+(idx+1)+"/"+SOURCES.length+"]: "+url);

    fetch(url, { cache:"no-store", headers:{
      "Cache-Control":"no-cache, no-store, must-revalidate",
      "Pragma":"no-cache","Expires":"0"
    }})
    .then(function(res){
      if(!res.ok) throw new Error("HTTP "+res.status);
      return res.json();
    })
    .then(function(json){
      renderAll(json);
      setOK();
      syncText.textContent = "Last updated "+nowTime();
      log("✅ Loaded from source #"+(idx+1));
    })
    .catch(function(err){
      log("Failed: "+err.message);
      tryFetch(idx+1);
    });
  }

  // First load + 5-min refresh
  tryFetch(0);
  setInterval(function(){ tryFetch(0); }, 300000);
})();
</script>
</body>
</html>
