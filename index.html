<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Aurora Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<!-- ===================== SECTION: CORE THEME + AURORA BACKGROUND ===================== -->
<style>
:root{
  --cyan:#00ffff;
  --magenta:#ff00ff;
  --pink:#ff66cc;
  --green:#00ff99;
  --bg1:#060018;
  --bg2:#120035;
  --bg3:#001a33;
}

/* full-screen animated aurora gradient */
body{
  margin:0;
  padding:0;
  font-family:'Orbitron',sans-serif;
  color:#fff;
  background:
    repeating-linear-gradient(
      to right,
      rgba(0,255,255,0.04) 0px,
      rgba(0,255,255,0.04) 1px,
      transparent 1px,
      transparent 60px
    ),
    repeating-linear-gradient(
      to bottom,
      rgba(0,255,255,0.04) 0px,
      rgba(0,255,255,0.04) 1px,
      transparent 1px,
      transparent 60px
    ),
    linear-gradient(135deg,#000010 0%,#050020 60%,#0b001e 100%);
  background-size:800% 800%;
  animation:auroraDrift 35s linear infinite;
  overflow-x:hidden;
}

/* titles and general grid */
h1{
  text-align:center;
  font-size:1.8rem;
  margin:20px 0;
  color:var(--cyan);
  text-shadow:0 0 20px var(--cyan);
}
h2, h3 {
  color: #fff;
  margin-top: 0.5em;
  text-shadow:
    0 0 6px rgba(0, 255, 255, 0.6),
    0 0 18px rgba(0, 255, 255, 0.3);
}

.dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(480px,1fr));
  gap:20px;
  margin:0 5%;
}

/* cards */
.card{
  background:rgba(10,10,30,0.65);
  border:1px solid rgba(0,255,255,0.25);
  border-radius:10px;
  padding:20px;
  box-shadow:0 0 20px rgba(0,255,255,0.15);
  backdrop-filter:blur(6px);
  animation:fadeIn 1s ease-in-out;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

/* glowing table */
.table-holder{overflow-x:auto;max-height:350px;}
table{width:100%;border-collapse:collapse;font-size:0.9rem;}
th,td{padding:6px 8px;text-align:left;}
th{color:var(--pink);}
tr:nth-child(even){background:rgba(255,255,255,0.05);}
tr:hover{background:rgba(0,255,255,0.1);}
.value{color:var(--cyan);}
.gain-pos{color:var(--green);}
.gain-neg{color:#ff5555;}

/* sync indicator */
#auroraSyncStatus{
  position:fixed;top:10px;right:20px;
  font-size:0.85rem;color:#fff;
}
#auroraSyncDot{
  display:inline-block;width:10px;height:10px;border-radius:50%;
  background:var(--cyan);
  box-shadow:0 0 10px var(--cyan);
  margin-right:6px;vertical-align:middle;
  animation:pulseGlow 3s ease-in-out infinite;
}
@keyframes pulseGlow{
  0%,100%{box-shadow:0 0 10px var(--cyan);}
  50%{box-shadow:0 0 25px var(--magenta);}
}

/* new: smart timestamp */
#syncTime{
  display:block;
  font-size:0.75rem;
  color:#aaa;
  margin-top:2px;
}

/* colours used in text highlights */
.amount-green{color:var(--green);}
.date-pink{color:var(--pink);}

/* responsive */
@media(max-width:720px){
  .dashboard{grid-template-columns:1fr;margin:0 3%;}
}
</style>
</head>
<body>
<h1>Aurora Tracker</h1>

<!-- ===================== SECTION: SYNC STATUS ===================== -->
<div id="auroraSyncStatus">
  <span id="auroraSyncDot"></span>Synced
  <span id="syncTime">Last updated --:-- Â· Next sync in 5 min</span>
</div>

<!-- ===================== SECTION: DASHBOARD GRID ===================== -->
<div class="dashboard">

  <!-- === Portfolio Summary (gain pulse added later in script) === -->
  <div class="card" id="portfolio-summary">
    <h2>Portfolio Summary</h2>
    <p>Total Target: Â£<span id="targetValue">0.00</span></p>
    <p>Dividend Yield: <span id="divYield">0.00</span>%</p>
    <p>Total Gain: <span id="totalGain">0.00</span> ( <span id="gainPercent">0.00</span>% )</p>
  </div>

  <!-- ===================== AURORA DIGITAL WAVE LINE ===================== -->
<div class="wave-container">
  <svg viewBox="0 0 600 100" preserveAspectRatio="none">
    <path d="M0,50 Q150,0 300,50 T600,50" class="wave"></path>
  </svg>
</div>

  <!-- === ISA Balances === -->
  <div class="card" id="isa-balances">
    <h2>ISA Balances</h2>
    <p>IG ISA: Â£<span id="igBalance">0.00</span></p>
    <p>Trade212 ISA: Â£<span id="t212Balance">0.00</span></p>
  </div>

  <!-- === IG ISA Holdings === -->
  <div class="card" id="ig-holdings">
    <h2>IG ISA Holdings</h2>
    <div class="table-holder">
      <table id="igTable">
        <thead>
          <tr>
            <th>Name</th><th>Value (Â£)</th><th>Gain (Â£)</th>
            <th>Gain (%)</th><th>Yield (%)</th><th>Income (Â£)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- === Trade212 Holdings === -->
  <div class="card" id="t212-holdings">
    <h2>Trade212 Holdings</h2>
    <div class="table-holder">
      <table id="t212Table">
        <thead>
          <tr>
            <th>Name</th><th>Value (Â£)</th><th>Gain (Â£)</th>
            <th>Gain (%)</th><th>Yield (%)</th><th>Income (Â£)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- === Dividends List + Calendar Toggle === -->
  <div class="card" id="dividends">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Dividends Centre</h2>
      <button id="toggleCalendar" style="background:rgba(0,0,0,0.4);
        border:1px solid var(--cyan);color:#fff;padding:5px 10px;
        border-radius:6px;cursor:pointer;">ðŸ“… Calendar View</button>
    </div>
    <div id="dividendListView">
      <h3>Next 5 Dividends</h3>
      <ul id="nextDivs"></ul>
      <h3>Next 5 Ex-Dividends</h3>
      <ul id="nextExDivs"></ul>
    </div>
    <div id="dividendCalendarView" style="display:none;text-align:center;">
      <canvas id="divCalendar" width="420" height="320"></canvas>
      <p style="font-size:0.8rem;color:#aaa;">Tap again to return to list view</p>
    </div>
  </div>

  <!-- === Dividend Charts & Forecast Band === -->
  <div class="card" id="dividend-charts">
    <h2>Dividend Income Overview</h2>
    <div id="dividendCharts" style="display:flex;flex-wrap:wrap;justify-content:space-between;gap:18px;">
      <div class="chartBlock" style="flex:1 1 45%;text-align:center;">
        <h3>Monthly Breakdown (Nov 2025 â†’ Nov 2026)</h3>
        <div id="monthlyBars" class="chartHolder"
             style="display:flex;justify-content:space-around;align-items:flex-end;height:240px;margin-top:12px;gap:10px;"></div>
      </div>
      <div class="chartBlock" style="flex:1 1 45%;text-align:center;">
        <h3>Quarterly Totals</h3>
        <div id="quarterlyBars" class="chartHolder"
             style="display:flex;justify-content:space-around;align-items:flex-end;height:240px;margin-top:12px;gap:10px;"></div>
      </div>
    </div>
     <!-- === Sector Allocation Rings === -->
  <div class="card" id="sector-allocation">
    <h2>Sector Allocation Rings</h2>
    <div style="display:flex;flex-wrap:wrap;justify-content:space-around;gap:20px;">
      <div style="text-align:center;">
        <h3>IG ISA</h3>
        <canvas id="igSectorRing" width="200" height="200"></canvas>
      </div>
      <div style="text-align:center;">
        <h3>Trade212 ISA</h3>
        <canvas id="t212SectorRing" width="200" height="200"></canvas>
      </div>
    </div>
  </div>
    <!-- === Forecast Band === -->
    <div id="forecastBand" style="margin-top:25px;text-align:center;">
      <h3>Dividend Forecast</h3>
      <p>Forecast Annual Income: Â£<span id="forecastTotal">0.00</span> Â· YTD Received: Â£<span id="receivedYTD">0.00</span></p>
      <div style="width:90%;margin:0 auto;background:rgba(255,255,255,0.1);
          border-radius:8px;height:16px;overflow:hidden;">
        <div id="forecastProgress"
             style="height:100%;width:0%;
             background:linear-gradient(90deg,var(--cyan),var(--pink));
             box-shadow:0 0 10px var(--cyan);
             transition:width 1s ease;"></div>
      </div>
      <p style="font-size:0.8rem;margin-top:6px;">Progress to Â£6 000 Goal: <span id="forecastPercent">0%</span></p>
    </div>
  </div>

</div>
<!-- ===================== SECTION: SCRIPT ===================== -->
<script>
const JSON_URL="https://cdn.jsdelivr.net/gh/webbchrisuk-max/Aurora@main/AuroraSync.json?nocache=";
let lastGain=0;

/* ===== Utility helpers ===== */
const asNum=v=>isNaN(+v)?0:+v;
const shortMonths=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
function monthKey(d){const dt=new Date(d+"T00:00:00Z");return shortMonths[dt.getUTCMonth()]+" "+dt.getUTCFullYear();}
function buildRollingMonths(){
  const start=new Date(Date.UTC(2025,10,1));const arr=[];
  for(let i=0;i<13;i++){const d=new Date(Date.UTC(start.getUTCFullYear(),start.getUTCMonth()+i,1));
    arr.push({key:shortMonths[d.getUTCMonth()]+" "+d.getUTCFullYear(),label:shortMonths[d.getUTCMonth()]});
  }return arr;
}

/* === Digital Wave Line === */
.wave-container {
  width: 100%;
  height: 70px;
  position: relative;
  margin: -10px 0 10px 0;
}

.wave-container svg {
  width: 100%;
  height: 100%;
}

.wave {
  fill: none;
  stroke: rgba(0,255,255,0.9);
  stroke-width: 2;
  filter: drop-shadow(0 0 8px rgba(0,255,255,0.6));
  stroke-dasharray: 10 8;
  animation: waveFlow 4s linear infinite;
}

@keyframes waveFlow {
  to { stroke-dashoffset: -36; }
}
  
  
  /* ====== MAIN FETCH ====== */
async function loadAuroraSync(){
  const dot=document.getElementById("auroraSyncDot");
  const time=document.getElementById("syncTime");
  try{
    const res=await fetch(JSON_URL+Date.now(),{cache:"no-store"});
    if(!res.ok)throw new Error(res.status);
    const data=await res.json();
    renderAll(data);
    const now=new Date();
    time.textContent=`Last updated ${now.getHours().toString().padStart(2,"0")}:${now.getMinutes().toString().padStart(2,"0")} Â· Next sync in 5 min`;
    dot.style.background="#00ffcc";
    dot.style.boxShadow="0 0 10px #00ffcc";
  }catch(e){
    dot.style.background="#ff3333";
    dot.style.boxShadow="0 0 15px #ff3333";
    time.textContent="Sync Error";
    console.error(e);
  }
}

/* ====== RENDER ALL SECTIONS ====== */
function renderAll(data){
  /* Portfolio summary + gain pulse */
  const g=parseFloat((data.isa.ig_isa.unrealised_gain??0)+(data.isa.trade212_isa.unrealised_gain??0));
  const pct=((g/(asNum(data.isa.ig_isa.book_cost)+asNum(data.isa.trade212_isa.book_cost)))*100).toFixed(2);
  document.getElementById("targetValue").textContent=data.isa.portfolio_summary.annual_target_value.toFixed(2);
  document.getElementById("divYield").textContent=data.isa.portfolio_summary.dividend_yield.toFixed(2);
  document.getElementById("totalGain").textContent=g.toFixed(2);
  document.getElementById("gainPercent").textContent=pct;
  const card=document.getElementById("portfolio-summary");
  if(g>lastGain){pulse(card,"#00ff99");}
  else if(g<lastGain){pulse(card,"#ffaa33");}
  lastGain=g;

  /* Balances */
  document.getElementById("igBalance").textContent=data.isa.ig_isa.balance.toFixed(2);
  document.getElementById("t212Balance").textContent=data.isa.trade212_isa.balance.toFixed(2);

  /* Holdings tables */
  renderTable("#igTable tbody",data.isa_feed.filter(x=>x.account==="IG ISA"));
  renderTable("#t212Table tbody",data.isa_feed.filter(x=>x.account==="TRADE212"));

  /* Dividends list & ex-div list */
  renderDividends(data);

  /* Charts & forecast band */
  renderMonthly(data);
  renderQuarterly(data);
  renderForecast(data);

  /* Sector rings */
  drawSectorRing("igSectorRing",data.isa_feed.filter(x=>x.account==="IG ISA"));
  drawSectorRing("t212SectorRing",data.isa_feed.filter(x=>x.account==="TRADE212"));
}

/* ===== TABLES ===== */
function renderTable(sel,list){
  const el=document.querySelector(sel);
  el.innerHTML="";
  list.forEach(h=>{
    el.insertAdjacentHTML("beforeend",
      `<tr><td>${h.name}</td>
      <td class='value'>${asNum(h.value).toFixed(2)}</td>
      <td class='${asNum(h.gain_value)>=0?"gain-pos":"gain-neg"}'>${asNum(h.gain_value).toFixed(2)}</td>
      <td class='${asNum(h.gain_value)>=0?"gain-pos":"gain-neg"}'>${asNum(h.gain_percentage).toFixed(2)}%</td>
      <td>${asNum(h.annual_div_yield).toFixed(2)}%</td>
      <td>${asNum(h.annual_income).toFixed(2)}</td></tr>`);
  });
}

/* ===== DIVIDENDS ===== */
function renderDividends(data){
  const now=new Date();
  const next=document.getElementById("nextDivs");
  const nextEx=document.getElementById("nextExDivs");
  next.innerHTML=""; nextEx.innerHTML="";
  const pays=data.dividends_feed.filter(d=>new Date(d.pay_date)>now)
              .sort((a,b)=>new Date(a.pay_date)-new Date(b.pay_date)).slice(0,5);
  const exes=data.dividends_feed.filter(d=>new Date(d.ex_div_date)>now)
              .sort((a,b)=>new Date(a.ex_div_date)-new Date(b.ex_div_date)).slice(0,5);
  pays.forEach(d=>{
    next.insertAdjacentHTML("beforeend",
      `<li>${d.name} â€“ <span class='amount-green'>Â£${asNum(d.total_dividend).toFixed(2)}</span>
       on <span class='date-pink'>${d.pay_date}</span></li>`);
  });
  exes.forEach(d=>{
    nextEx.insertAdjacentHTML("beforeend",
      `<li>${d.name} â€“ Ex-Div <span class='date-pink'>${d.ex_div_date}</span></li>`);
  });
}

/* ===== MONTHLY / QUARTERLY CHARTS ===== */
function renderMonthly(data){
  const holder=document.getElementById("monthlyBars");
  holder.innerHTML="";
  const frame=buildRollingMonths();
  const mbMap={};(data.dividend_planner.monthly_breakdown||[]).forEach(m=>mbMap[m.month.trim()]=asNum(m.total_estimated_income));
  const monthPayments={};
  (data.dividends_feed||[]).forEach(d=>{
    const k=monthKey(d.pay_date);if(!monthPayments[k])monthPayments[k]=[];
    monthPayments[k].push({t:d.ticker||d.name,a:asNum(d.total_dividend)});
  });
  const vals=frame.map(f=>mbMap[f.key]||0);
  const max=Math.max(1,...vals);
  frame.forEach(f=>{
    const total=mbMap[f.key]||0;
    const wrap=document.createElement("div");
    wrap.style.display="flex";wrap.style.flexDirection="column";wrap.style.alignItems="center";wrap.style.position="relative";
    const bar=document.createElement("div");
    bar.style.width="22px";bar.style.borderRadius="6px 6px 0 0";
    bar.style.background="linear-gradient(180deg,#ff00ff,#00ffff)";
    bar.style.boxShadow="0 0 15px #00ffff";
    bar.style.height=(total/max*190)+"px";
    bar.style.transition="height 1s";
    wrap.appendChild(bar);
    /* tooltip */
    const tip=document.createElement("div");
    tip.className="tip";
    tip.style.position="absolute";
    tip.style.bottom="100%";tip.style.left="50%";tip.style.transform="translate(-50%,-8px)";
    tip.style.background="rgba(8,8,30,0.95)";
    tip.style.border="1px solid rgba(0,255,255,0.4)";
    tip.style.borderRadius="8px";tip.style.padding="8px 10px";tip.style.minWidth="160px";
    tip.style.opacity="0";tip.style.transition="opacity .2s,transform .2s";
    tip.innerHTML=`<h4 style='color:#00ffff;margin:0;'>${f.key}: Â£${total.toFixed(2)}</h4>`+
      (monthPayments[f.key]?monthPayments[f.key].map(p=>`<div class='line'>${p.t} â€“ Â£${p.a.toFixed(2)}</div>`).join(""):"<div class='line'>No payments</div>");
    wrap.appendChild(tip);
    wrap.addEventListener("mouseenter",()=>{tip.style.opacity="1";tip.style.transform="translate(-50%,-12px)";});
    wrap.addEventListener("mouseleave",()=>{tip.style.opacity="0";tip.style.transform="translate(-50%,-8px)";});
    const lbl=document.createElement("div");
    lbl.textContent=f.label;lbl.style.fontSize=".75rem";lbl.style.marginTop="6px";
    wrap.appendChild(lbl);
    holder.appendChild(wrap);
  });
}
function renderQuarterly(data){
  const el=document.getElementById("quarterlyBars");el.innerHTML="";
  const qd=data.dividend_planner.quarterly_breakdown||{};
  const max=Math.max(1,...Object.values(qd));
  Object.entries(qd).forEach(([q,v])=>{
    const w=document.createElement("div");w.style.display="flex";w.style.flexDirection="column";w.style.alignItems="center";
    const b=document.createElement("div");
    b.style.width="60px";b.style.height=(v/max*190)+"px";
    b.style.borderRadius="6px 6px 0 0";
    b.style.background="linear-gradient(180deg,#00ffff,#ff00ff)";
    b.style.boxShadow="0 0 15px #ff00ff";
    w.appendChild(b);
    const l=document.createElement("div");l.innerHTML=`${q}<br>Â£${v.toFixed(2)}`;
    l.style.fontSize=".8rem";l.style.textAlign="center";l.style.marginTop="6px";
    w.appendChild(l);
    el.appendChild(w);
  });
}

/* ===== FORECAST BAND ===== */
function renderForecast(data){
  const f=data.dividend_planner;
  document.getElementById("forecastTotal").textContent=asNum(f.forecast_total).toFixed(2);
  document.getElementById("receivedYTD").textContent=asNum(f.received_ytd).toFixed(2);
  const pct=(asNum(f.forecast_total)/6000*100).toFixed(1);
  document.getElementById("forecastPercent").textContent=pct+"%";
  document.getElementById("forecastProgress").style.width=Math.min(pct,100)+"%";
}

/* ===== SECTOR RINGS ===== */
function drawSectorRing(id,list){
  const ctx=document.getElementById(id).getContext("2d");
  ctx.clearRect(0,0,200,200);
  const total=list.reduce((s,h)=>s+asNum(h.value),0)||1;
  const sectors={};
  list.forEach(h=>{const s=(h.sector||"Other").trim();sectors[s]=(sectors[s]||0)+asNum(h.value);});
  const colors=["#00ffff","#ff00ff","#ff66cc","#00ff99","#ffaa33","#33ccff","#cc99ff"];
  let start=-Math.PI/2,i=0;
  Object.entries(sectors).forEach(([s,v])=>{
    const ang=(v/total)*2*Math.PI;
    ctx.beginPath();ctx.arc(100,100,80,start,start+ang);
    ctx.strokeStyle=colors[i++%colors.length];
    ctx.lineWidth=25;ctx.shadowBlur=10;ctx.shadowColor=ctx.strokeStyle;
    ctx.stroke();

    /* === ADD THIS FOR LABELS === */
    const mid=start+ang/2;
    const percent=((v/total)*100).toFixed(1)+"%";
    const x=100+Math.cos(mid)*55;
    const y=100+Math.sin(mid)*55;
    ctx.fillStyle="#fff";
    ctx.font="10px Orbitron";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.shadowBlur=8;ctx.shadowColor=ctx.strokeStyle;
    ctx.fillText(percent,x,y);
    ctx.shadowBlur=0;

    start+=ang;
  });
  ctx.shadowBlur=0;
}

/* ===== GAIN PULSE ===== */
function pulse(el,color){
  el.style.boxShadow=`0 0 25px ${color}`;
  setTimeout(()=>el.style.boxShadow="0 0 20px rgba(0,255,255,0.15)",1000);
}

/* ===== CALENDAR TOGGLE (placeholder drawing) ===== */
document.getElementById("toggleCalendar").addEventListener("click",()=>{
  const list=document.getElementById("dividendListView");
  const cal=document.getElementById("dividendCalendarView");
  const btn=document.getElementById("toggleCalendar");
  if(cal.style.display==="none"){list.style.display="none";cal.style.display="block";btn.textContent="ðŸ“ƒ List View";drawCalendar();}
  else{list.style.display="block";cal.style.display="none";btn.textContent="ðŸ“… Calendar View";}
});
function drawCalendar(){
  const c=document.getElementById("divCalendar");
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  const grad=ctx.createLinearGradient(0,0,c.width,0);
  grad.addColorStop(0,"#00ffff");grad.addColorStop(1,"#ff00ff");
  ctx.strokeStyle=grad;ctx.lineWidth=1;
  for(let i=0;i<7;i++){ctx.beginPath();ctx.moveTo(60*i,0);ctx.lineTo(60*i,320);ctx.stroke();}
  for(let j=0;j<5;j++){ctx.beginPath();ctx.moveTo(0,64*j);ctx.lineTo(420,64*j);ctx.stroke();}
  ctx.font="12px Orbitron";ctx.fillStyle="#fff";ctx.fillText("Future dividend calendar placeholder",40,160);
}
/* ===== INITIALISE & AUTO-REFRESH ===== */
loadAuroraSync();
setInterval(loadAuroraSync, 300000); // every 5 min
</script>
</body>
</html>
