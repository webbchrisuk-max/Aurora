<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Aurora Tracker – HyperGrid Live Feed v2.2 (Hover Insights Edition)</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<!-- ===================== SECTION: CORE THEME ===================== -->
<style>
  body{
    margin:0;padding:0;font-family:'Orbitron',sans-serif;color:#fff;
    background:#030012;
    background-image:
      linear-gradient(90deg,rgba(255,0,255,0.05) 1px,transparent 1px),
      linear-gradient(rgba(0,255,255,0.05) 1px,transparent 1px);
    background-size:40px 40px;
    animation:scrollGrid 60s linear infinite;
    overflow-x:hidden;
  }
  @keyframes scrollGrid{from{background-position:0 0,0 0;}to{background-position:400px 400px,400px 400px;}}

  h1{text-align:center;font-size:1.8rem;margin:20px 0;color:#00ffff;text-shadow:0 0 15px #00ffff;}
  .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(480px,1fr));gap:20px;margin:0 5%;}
  .card{
    background:rgba(10,10,30,0.65);
    border:1px solid rgba(0,255,255,0.25);
    border-radius:10px;
    padding:20px;
    box-shadow:0 0 20px rgba(0,255,255,0.15);
    backdrop-filter:blur(6px);
    animation:fadeIn 1s ease-in-out;
  }
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

  /* ===================== SECTION: TABLES ===================== */
  .table-holder{overflow-x:auto;max-height:350px;}
  table{width:100%;border-collapse:collapse;font-size:0.9rem;}
  th,td{padding:6px 8px;text-align:left;}
  th{color:#ff66cc;}
  tr:nth-child(even){background:rgba(255,255,255,0.05);}
  tr:hover{background:rgba(0,255,255,0.1);}
  .value{color:#00ffff;}
  .gain-pos{color:#00ff99;}
  .gain-neg{color:#ff6666;}

  /* ===================== SECTION: SYNC STATUS ===================== */
  #auroraSyncStatus{position:fixed;top:10px;right:20px;font-size:0.85rem;color:#fff;}
  #auroraSyncDot{
    display:inline-block;width:10px;height:10px;border-radius:50%;
    background:#00ffcc;box-shadow:0 0 10px #00ffcc;margin-right:6px;vertical-align:middle;
    animation:pulseGlow 3s ease-in-out infinite;
  }
  @keyframes pulseGlow{0%,100%{box-shadow:0 0 10px #00ffcc;}50%{box-shadow:0 0 25px #00ffff;}}

  /* ===================== SECTION: DIVIDEND CHARTS ===================== */
  #dividendCharts{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:flex-start;gap:18px;}
  .chartBlock{flex:1 1 45%;text-align:center;}
  .chartHolder{display:flex;justify-content:space-around;align-items:flex-end;height:240px;margin-top:12px;gap:10px;}
  .bar, .qbar{
    background:linear-gradient(180deg,#ff00ff,#00ffff);
    border-radius:6px 6px 0 0;
    box-shadow:0 0 15px #00ffff;
    animation:pulseBar 4s ease-in-out infinite;
  }
  .bar{width:22px;}
  .qbar{width:75px;}
  @keyframes pulseBar{0%,100%{opacity:0.9;box-shadow:0 0 15px #00ffff;}50%{opacity:1;box-shadow:0 0 25px #ff00ff;}}
  .bar-wrap, .qbar-wrap{display:flex;flex-direction:column;align-items:center;position:relative;}
  .bar-label, .qbar-label{text-align:center;margin-top:6px;font-size:0.78rem;}

  /* ===================== SECTION: TOOLTIP ===================== */
  .tip{
    position:absolute;bottom:100%;left:50%;transform:translate(-50%,-8px);
    background:rgba(8,8,30,0.95);
    border:1px solid rgba(0,255,255,0.4);
    box-shadow:0 0 18px rgba(0,255,255,0.35), inset 0 0 6px rgba(255,0,255,0.25);
    padding:10px 12px;border-radius:8px;min-width:180px;max-width:260px;pointer-events:none;
    opacity:0;transition:opacity .18s ease, transform .18s ease; z-index:9;
  }
  .tip.show{opacity:1;transform:translate(-50%,-12px);}
  .tip h4{margin:0 0 6px 0;font-size:0.85rem;color:#00ffff;}
  .tip .line{font-size:0.8rem;margin:2px 0;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

  /* ===================== SECTION: COLORED TEXT HELPERS ===================== */
  .amount-green{color:#00ff99;}
  .date-pink{color:#ff66cc;}

  /* ===================== SECTION: RESPONSIVE ===================== */
  @media (max-width:720px){
    .dashboard{grid-template-columns:1fr;margin:0 3%;}
    .chartBlock{flex:1 1 100%;}
    .qbar{width:56px;}
  }
</style>
</head>

<body>
<h1>Aurora Tracker – HyperGrid Live Feed v2.2 (Hover Insights Edition)</h1>
<div id="auroraSyncStatus"><span id="auroraSyncDot"></span>Synced</div>

<div class="dashboard">
  <!-- ===================== SECTION: Portfolio Summary ===================== -->
  <div class="card" id="portfolio-summary">
    <h2>Portfolio Summary</h2>
    <p>Total Target: £<span id="targetValue">0.00</span></p>
    <p>Dividend Yield: <span id="divYield">0.00</span>%</p>
  </div>

  <!-- ===================== SECTION: ISA Balances ===================== -->
  <div class="card" id="isa-balances">
    <h2>ISA Balances</h2>
    <p>IG ISA: £<span id="igBalance">0.00</span></p>
    <p>Trade212 ISA: £<span id="t212Balance">0.00</span></p>
  </div>

  <!-- ===================== SECTION: IG ISA Holdings ===================== -->
  <div class="card" id="ig-holdings">
    <h2>IG ISA Holdings</h2>
    <div class="table-holder">
      <table id="igTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Value (£)</th>
            <th>Gain (£)</th>
            <th>Gain (%)</th>
            <th>Yield (%)</th>
            <th>Income (£)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ===================== SECTION: Trade212 Holdings ===================== -->
  <div class="card" id="t212-holdings">
    <h2>Trade212 Holdings</h2>
    <div class="table-holder">
      <table id="t212Table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Value (£)</th>
            <th>Gain (£)</th>
            <th>Gain (%)</th>
            <th>Yield (%)</th>
            <th>Income (£)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ===================== SECTION: Dividends Lists ===================== -->
  <div class="card" id="dividends">
    <h2>Next 5 Dividends</h2>
    <ul id="nextDivs"></ul>
    <h2>Next 5 Ex-Dividends</h2>
    <ul id="nextExDivs"></ul>
  </div>

  <!-- ===================== SECTION: Dividend Charts (Monthly + Quarterly) ===================== -->
  <div class="card" id="dividend-charts">
    <h2>Dividend Income Overview</h2>
    <div id="dividendCharts">
      <div class="chartBlock">
        <h3>Monthly Breakdown (Nov 2025 → Nov 2026)</h3>
        <div id="monthlyBars" class="chartHolder"></div>
      </div>
      <div class="chartBlock">
        <h3>Quarterly Totals</h3>
        <div id="quarterlyBars" class="chartHolder"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===================== SECTION: SCRIPT ===================== -->
<script>
  /* ---------- Utils ---------- */
  const JSON_URL = "https://cdn.jsdelivr.net/gh/webbchrisuk-max/Aurora@main/AuroraSync.json?nocache=";

  const shortMonths = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  function monthKey(dateStr){ // "2025-12-19" -> "Dec 2025"
    const d = new Date(dateStr+"T00:00:00");
    return shortMonths[d.getUTCMonth()] + " " + d.getUTCFullYear();
  }
  function buildRollingMonths(){
    // Nov 2025 → Nov 2026 inclusive (13 months)
    const start = new Date(Date.UTC(2025,10,1)); // 10 = November (0-indexed)
    const list = [];
    for(let i=0;i<13;i++){
      const d = new Date(Date.UTC(start.getUTCFullYear(), start.getUTCMonth()+i, 1));
      list.push({ key: shortMonths[d.getUTCMonth()]+" "+d.getUTCFullYear(), label: shortMonths[d.getUTCMonth()] });
    }
    return list;
  }
  function asNum(x){ const n = +x; return isNaN(n)?0:n; }

  /* ---------- Load & Render ---------- */
  async function loadAuroraSync(){
    const STATUS = document.getElementById("auroraSyncStatus");
    try{
      const res = await fetch(JSON_URL + Date.now(), { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP "+res.status);
      const data = await res.json();
      renderAll(data);
      // keep green "Synced"
      STATUS.innerHTML = '<span id="auroraSyncDot"></span>Synced';
    }catch(err){
      STATUS.innerHTML = '<span id="auroraSyncDot" style="background:#ff4444;box-shadow:0 0 20px #ff4444;"></span>Sync Error';
      console.error("AuroraSync load error:", err);
    }
  }

  function renderAll(data){
    /* ----- Portfolio summary ----- */
    document.getElementById("targetValue").textContent = data.isa.portfolio_summary.annual_target_value.toFixed(2);
    document.getElementById("divYield").textContent = data.isa.portfolio_summary.dividend_yield.toFixed(2);

    /* ----- ISA balances ----- */
    document.getElementById("igBalance").textContent = data.isa.ig_isa.balance.toFixed(2);
    document.getElementById("t212Balance").textContent = data.isa.trade212_isa.balance.toFixed(2);

    /* ----- Holdings tables ----- */
    const igBody = document.querySelector("#igTable tbody");
    igBody.innerHTML = "";
    data.isa_feed.filter(x => x.account === "IG ISA").forEach(h => {
      igBody.insertAdjacentHTML("beforeend",
        `<tr>
          <td>${h.name}</td>
          <td class="value">${asNum(h.value).toFixed(2)}</td>
          <td class="${asNum(h.gain_value)>=0?'gain-pos':'gain-neg'}">${asNum(h.gain_value).toFixed(2)}</td>
          <td class="${asNum(h.gain_value)>=0?'gain-pos':'gain-neg'}">${asNum(h.gain_percentage).toFixed(2)}%</td>
          <td>${asNum(h.annual_div_yield).toFixed(2)}%</td>
          <td>${asNum(h.annual_income).toFixed(2)}</td>
        </tr>`);
    });

    const tBody = document.querySelector("#t212Table tbody");
    tBody.innerHTML = "";
    data.isa_feed.filter(x => x.account === "TRADE212").forEach(h => {
      tBody.insertAdjacentHTML("beforeend",
        `<tr>
          <td>${h.name}</td>
          <td class="value">${asNum(h.value).toFixed(2)}</td>
          <td class="${asNum(h.gain_value)>=0?'gain-pos':'gain-neg'}">${asNum(h.gain_value).toFixed(2)}</td>
          <td class="${asNum(h.gain_value)>=0?'gain-pos':'gain-neg'}">${asNum(h.gain_percentage).toFixed(2)}%</td>
          <td>${asNum(h.annual_div_yield).toFixed(2)}%</td>
          <td>${asNum(h.annual_income).toFixed(2)}</td>
        </tr>`);
    });

    /* ----- Next 5 Dividends (green amounts, pink dates) ----- */
    const now = new Date();
    const upcoming = data.dividends_feed
      .filter(d => new Date(d.pay_date+"T00:00:00Z") > now)
      .sort((a,b)=> new Date(a.pay_date) - new Date(b.pay_date))
      .slice(0,5);
    const nextDivs = document.getElementById("nextDivs");
    nextDivs.innerHTML = "";
    upcoming.forEach(d => {
      const amt = asNum(d.total_dividend).toFixed(2);
      const li = document.createElement("li");
      li.innerHTML = `${d.name} – <span class="amount-green">£${amt}</span> on <span class="date-pink">${d.pay_date}</span>`;
      nextDivs.appendChild(li);
    });

    /* ----- Next 5 Ex-Dividends (pink dates only) ----- */
    const upcomingEx = data.dividends_feed
      .filter(d => new Date(d.ex_div_date+"T00:00:00Z") > now)
      .sort((a,b)=> new Date(a.ex_div_date) - new Date(b.ex_div_date))
      .slice(0,5);
    const nextExDivs = document.getElementById("nextExDivs");
    nextExDivs.innerHTML = "";
    upcomingEx.forEach(d => {
      const li = document.createElement("li");
      li.innerHTML = `${d.name} – Ex-Div <span class="date-pink">${d.ex_div_date}</span>`;
      nextExDivs.appendChild(li);
    });

    /* ----- Charts: Monthly (with tooltips) + Quarterly ----- */
    renderMonthlyWithTooltips(data);
    renderQuarterly(data);
  }

  /* ---------- Monthly bars with hover tooltip ---------- */
  function renderMonthlyWithTooltips(data){
    const container = document.getElementById("monthlyBars");
    container.innerHTML = "";

    // Build 13-month frame (Nov 2025 → Nov 2026)
    const frame = buildRollingMonths(); // [{key:'Nov 2025', label:'Nov'}, ...]
    // Map monthly_breakdown to quick lookup
    const mb = Array.isArray(data.dividend_planner.monthly_breakdown) ? data.dividend_planner.monthly_breakdown : [];
    const mbMap = {};
    mb.forEach(m => { mbMap[(m.month||"").trim()] = asNum(m.total_estimated_income); });

    // Precompute dividends per month (ticker + amount)
    const monthPayments = {};
    (data.dividends_feed || []).forEach(d => {
      const key = monthKey(d.pay_date);
      if(!monthPayments[key]) monthPayments[key] = [];
      monthPayments[key].push({
        name: d.ticker ? d.ticker : d.name,
        amount: asNum(d.total_dividend)
      });
    });

    // Determine max for scaling
    const values = frame.map(f => (mbMap[f.key] ?? 0));
    const maxVal = Math.max(1, ...values);

    frame.forEach(f => {
      const total = mbMap[f.key] ?? 0;
      const payments = monthPayments[f.key] || [];

      const wrap = document.createElement("div");
      wrap.className = "bar-wrap";

      const bar = document.createElement("div");
      bar.className = "bar";
      bar.style.height = (total / maxVal * 190) + "px";
      wrap.appendChild(bar);

      // Tooltip
      const tip = document.createElement("div");
      tip.className = "tip";
      const header = `<h4>${f.key}: £${total.toFixed(2)}</h4>`;
      const lines = payments.length
        ? payments.map(p => `<div class="line">${p.name} – £${p.amount.toFixed(2)}</div>`).join("")
        : `<div class="line">No payments</div>`;
      tip.innerHTML = header + lines;
      wrap.appendChild(tip);

      // Hover / touch events
      wrap.addEventListener("mouseenter", ()=> tip.classList.add("show"));
      wrap.addEventListener("mouseleave", ()=> tip.classList.remove("show"));
      wrap.addEventListener("touchstart", (e)=>{ e.stopPropagation(); tip.classList.add("show"); }, {passive:true});
      document.body.addEventListener("touchstart", ()=> tip.classList.remove("show"), {passive:true});

      const lbl = document.createElement("div");
      lbl.className = "bar-label";
      lbl.textContent = f.label;
      wrap.appendChild(lbl);

      container.appendChild(wrap);
    });
  }

  /* ---------- Quarterly glowing bars ---------- */
  function renderQuarterly(data){
    const qBars = document.getElementById("quarterlyBars");
    qBars.innerHTML = "";
    const qData = data.dividend_planner.quarterly_breakdown || {};
    const qVals = Object.values(qData);
    const qMax = Math.max(1, ...qVals);

    Object.entries(qData).forEach(([q,v])=>{
      const wrap = document.createElement("div");
      wrap.className = "qbar-wrap";
      const bar = document.createElement("div");
      bar.className = "qbar";
      bar.style.height = (v/qMax*190)+"px";
      wrap.appendChild(bar);
      const lbl = document.createElement("div");
      lbl.className = "qbar-label";
      lbl.innerHTML = `${q}<br>£${(+v).toFixed(2)}`;
      wrap.appendChild(lbl);
      qBars.appendChild(wrap);
    });
  }

  /* ---------- Init ---------- */
  loadAuroraSync();
  setInterval(loadAuroraSync, 300000); // 5 mins
</script>
</body>
</html>
